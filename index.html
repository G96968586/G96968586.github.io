<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>箫鉴哥博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="箫鉴哥博客">
<meta property="og:url" content="http://G96968586.github.io/index.html">
<meta property="og:site_name" content="箫鉴哥博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="箫鉴哥博客">
  
    <link rel="alternative" href="/atom.xml" title="箫鉴哥博客" type="application/atom+xml">
  
  
    <link rel="icon" href="//favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="https://gw.alicdn.com/tps/TB1mZsZNXXXXXXDXVXXXXXXXXXX-200-200.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">箫鉴哥</a></h1>
		</hgroup>

		
		<p class="header-subtitle">如果没能一次成功，那就叫它1.0版吧</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>

				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
						<li>Über</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/G96968586" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/p/1005051813501992/home?from=page_100505&mod=TAB#place" title="weibo">weibo</a>
					        
								<a class="mail" target="_blank" href="mailto:huijian.xhj@gmail.com" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>

				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						
					</div>
				</section>
				

				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">奥巴马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">卡卡的美丽传说</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">本泽马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">吉格斯的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">习大大大不同</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">托蒂的博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">简简单单，热爱生活和编程的技术鲜肉，理想是成为大神！</div>
				</section>
				
			</div>
		</div>
	</header>
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">箫鉴哥</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="nullhttps://gw.alicdn.com/tps/TB1mZsZNXXXXXXDXVXXXXXXXXXX-200-200.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
				
			</div>
			<hgroup>
			  <h1 class="header-author">箫鉴哥</h1>
			</hgroup>
			
			<p class="header-subtitle">如果没能一次成功，那就叫它1.0版吧</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/G96968586" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/p/1005051813501992/home?from=page_100505&mod=TAB#place" title="weibo">weibo</a>
			        
						<a class="mail" target="_blank" href="mailto:huijian.xhj@gmail.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-JavaScript-客户端检测技术学习分享" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/09/15/JavaScript-客户端检测技术学习分享/" class="article-date">
  	<time datetime="2016-09-15T15:26:39.000Z" itemprop="datePublished">2016-09-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/15/JavaScript-客户端检测技术学习分享/">JavaScript  客户端检测技术学习分享</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近学习了 JavaScript  客户端检测 的知识点，写这篇文章是为了方便自己以后有需要时查阅，同时也把自己的学习成果分享给大家。</p>
<p>客户端检测方案分三种，分别是：</p>
<ul>
<li>能力检测</li>
<li>怪癖检测</li>
<li>用户代理检测</li>
</ul>
<p>能力检测是指在编写代码之前先检测特定浏览器的能力。比如，脚本在调用某个函数之前，可能要先检测该函数是否存在。</p>
<p>怪癖检测实际上是浏览器实现中存在的 bug，例如，早起的 WebKit 中存在一个怪癖，即它会在 for-in 村换中返回被隐蔽的属性。</p>
<p>用户代理检测是通过检测用户代理字符串来识别浏览器。因为在用户代理字符串中，包含着大量与浏览器有关的信息，包括浏览器、平台、操作系统及浏览器版本。</p>
<p>这里我要说的是第三种方案，用户代理检测。</p>
<p>下面是一份完整的用户代理字符串检测脚本，包括检测呈现引擎、平台、Windows 操作系统、移动设备和游戏系统。我会在脚本难以理解的地方写上注释，方便理解。资料整理自 <a href="">《JavaScript 高级程序设计》</a>。</p>
<pre><code>var client = function() {
  // 呈现引擎
  /**
  * 每个呈现引擎都对应着一个属性，默认值为0，如果检测到哪一个呈现引擎，就将该引擎的版本号以浮点数值
  * 形式写入相应的属性。呈现引擎的完整版本号则以字符串形式写入 ver 属性.
  */
  var engine = {
    ie: 0,
    gecko: 0,
    webkit: 0,
    khtml: 0,
    opera: 0,

    // 完整的版本号
    var: null
};

  // 浏览器
  /**
  * 与 engine 变量一样，除了当前使用的浏览器，其他属性的值都保持为0。当前浏览器的这个属性保存的是
  * 浮点数值形式版本号。 ver 同上。
  */
  var browser = {
  // 主要的浏览器
    ie: 0,
    firefox: 0,
    safari: 0,
    konq: 0,
    opera: 0,
    chrome: 0,

    // 具体的版本号
    ver: null
};

  // 平台、设备和操作系统
  /**
  * 与呈现引擎不同，在不能访问操作系统或版本的情况下，平台信息通常是很有限的。对这三个平台，浏览器
  * 一般只报告 Windows 版本。所以新变量 system 的每个属性最初值都保存着布尔值 false。
  * 在确定平台时，检测 navigator.platform 要比检测用户代理字符串更简单，后者在不同浏览器中会给出
  * 不同的平台信息。navigator.platform 属性可能的值包括：
  * &quot;Win32&quot;、&quot;Win64&quot;、&quot;MacPPC&quot;、&quot;MacIntel&quot;、&quot;X11&quot; 和 &quot;Linux i686&quot;
  * 这些值在不同浏览器都是一致的。
  */
  var system = {
    win: false,/*Windows*/
    mac: false,/*Mac*/
    x11: false,/*Unix*/

    // 移动设备
    iphone: false,
    ipod: false,
    ipad: false,
    ios: false,
    android: false,
    nokiaN: false,
    winMobile: false,

    // 游戏系统
    wii: false,/*任天堂*/
    playstation: false /*playstation 3,简称 PS3*/
};

  // 检测呈现引擎和浏览器
  var ua = navigator.userAgent;
  /**
  * 要识别 opera，必须得检测 window.opera 对象。Opera 5及更高版本中都有这个对象。在 Opera 7.6       
  * 及更高版本中，调用 Version() 方法可以返回一个表示浏览器版本的字符串，而这也是确定 Opera 版本
  * 号的最佳方式。至于要检测更早版本的 Opera，可以直接检查用户代理字符串，因为早期版本不支持隐藏身
  * 份。但是在 07年底 Opera 的最高版本已经是 9.5 了，所以现在太可能有人还在使用 7.6 之前的版本。
  */
  if (window.opera) {
    engine.ver = browser.ver = window.opera.version();
    engine.opera = browser.opera = parseFloat(engine.ver);
}
  /**
  * WebKit 的用户代理字符串中的 &quot;AppleWebKit&quot;是独一无二的，所以检测这个字符串最合适。
  * eg:
  * &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_3) AppleWebKit/537.36 (KHTML, like Gecko)       
  * Chrome/48.0.2564.116 Safari/537.36&quot;
  */
  else if (/AppleWebKit\/(\S+)/.test(ua)) {
    engine.ver = RegExp[&quot;$1&quot;];
    engine.webkit = parseFloat(engine.ver);

    // 此时确定是 Chrome 还是 Safari
    if (/Chrome\/(\S+)/.test(ua)) {
        browser.ver = RegExp[&quot;$1&quot;];
        browser.chrome = parseFloat(browser.ver);
    } else if (/Version\/(\S+)/.test(ua)) {
        browser.ver = RegExp[&quot;$1&quot;];
        browser.safari = parseFloat(browser.ver);
    } else {
        // 近似确定版本号
        var safariVersion = 1;
        if (engine.webkit &lt; 100) {
            safariVersion = 1;
        } else if (engine.webkit &lt; 312) {
            safariVersion = 1.2;
        } else if (engine.webkit &lt; 412) {
            safariVersion = 1.3;
        } else if (engine.webkit &lt; 523) {
            safariVersion = 2;
        } else if (engine.webkit &lt; 525) {
            safariVersion = 3;
        } else {
            safariVersion = 3.1;
        }

        browser.safari = browser.ver = safariVersion;
    }
}
  /**
  * 先检测 KHTML,因为 KHTML 的 UA 中也包含了 &quot;Gecko&quot;,因此在排除 KHTML 之前，我们无法准确检测基于
  * Gecko 的浏览器。
  * KHTML 与 WebKit 的版本号在 UA 中的格式差不多，因此用了类似的正则表达式。但由于在 Konqueror
  * 3.1 及更高的版本中不包含 KHTML 的版本，所以要使用 Konqueror 的版本来代替，所以有了后面的正则
  * 表达式。
  */
  else if (/KHTML\/(\S+)/.test(ua) || /Kongqueror\/([^;]+)/.test(ua)) {
        engine.ver = browser.ver = RegExp[&quot;$1&quot;];
        engine.khtml = browser.konq = parseFloat(engine.ver);
}
  /**
  * Gecko 的版本号不会出现在字符串 &quot;Gecko&quot; 的后面，而是会出现在字符串 &quot;rv:&quot; 的后面。
  */
  else if (/rv:([^\)]+)\) Gecko\/\d{8}/.test(ua)) {
        engine.ver = RegExp[&quot;$1&quot;];
        engine.gecko = parseFloat(engine.ver);
    // 确定是不是 Firefox
    if (/Firefox\/(\S+)/.test(ua)) {
        browser.ver = RegExp[&quot;$1&quot;];
        browser.firefox = parseFloat(browser.ver);
    }
}
  // IE 的版本号位于字符串 &quot;MSIE&quot; 的后面，一个分号的前面
  else if (/MSIE ([^;]+)/.test(ua)) {
        engine.ver = browser.ver = RegExp[&quot;$1&quot;];
        engine.ie = browser.ie = parseFloat(engine.ver);
}

  // 检测浏览器
  // browser.ie = engine.ie;
  // browser.opera = engine.opera;

  // 检测平台
  var p = navigator.platform;
  system.win = p.indexOf(&quot;Win&quot;) == 0;
  system.mac = p.indexOf(&quot;Mac&quot;) == 0;
  system.x11 = (p == &quot;X11&quot;) || (p.indexOf(&quot;Linux&quot;) == 0);

  // 检测 Windows 操作系统
  // 第一个捕获组匹配 95、98、9x、NT、ME 或 XP，第二个捕获组只针对 Windows ME 及所有 Windows
  // NT 的变体。
  /**
  * 要理解下面的正则表达式，首先要知道不同浏览器在表示不同的 Windows 操作系统时给出的不同字符串。
  * windows版本    IE4+          Gecko          Opera&lt;7          0pera7+      WebKit
  *    95      &quot; Windows 95&quot;    &quot;Win95&quot;      &quot;Windows 95&quot;     &quot;Windows 95      n/a
  *    98       &quot;Windows 98&quot;    &quot;Win98&quot;      &quot;Windows 98&quot;     &quot;Windows 98&quot;     n/a
  *  NT 4.0     &quot;Windows NT&quot;   &quot;WinNT4.O&quot;    &quot;Windows NT 4.O&quot; &quot;Windows NT 4.0&quot; n/a
  *   2000   &quot;Windows NT 5.0&quot; &quot;Windows NT 5.O&quot;&quot;Windows 2000&quot;  &quot;Windows NT 5.O&quot; n/a
  *    ME       &quot;Win 9x 4.90&quot; &quot;Win 9x 4.90&quot;   &quot;Windows ME&quot;    &quot;Win 9x 4.90&quot;    n/a
  *    XP  &quot;Windows NT 5.1&quot; &quot;Windows NT 5.1&quot;&quot;Windows XP&quot;   &quot;Windows NT 5.1&quot;&quot;Windows NT 5.1&quot;
  *  Vista &quot;Windows NT 6.0&quot; &quot;Windows NT 6.0&quot;    n/a        &quot;Windows NT 6.0&quot;&quot;Windows NT 6.0&quot;
  *    7   &quot;Windows NT 6.1&quot; &quot;Windows NT 6.1&quot;    n/a        &quot;Windows NT 6.1&quot;&quot;Windows NT 6.1&quot;
*/
  if (system.win) {
    if (/Win(?:dows )?([^do]{2})\s?(\d+\.\d+)?/.test(ua)) {
        if (RegExp[&quot;$1&quot;] == &quot;NT&quot;) {
            switch(RegExp[&quot;$2&quot;]) {
              case &quot;5.0&quot;:
                system.win = &quot;2000&quot;;
                break;
              case &quot;5.1&quot;:
                system.win = &quot;XP&quot;;
                break;
              case &quot;6.0&quot;:
                system.win = &quot;Vista&quot;;
                break;
              case &quot;6.1&quot;:
                system.win = 7;
                break;
              default:
                system.win = &quot;NT&quot;;
                break;
            }
        } else if (RegExp[&quot;$1&quot;] == &quot;9x&quot;) {
            system.win = &quot;ME&quot;;
        } else {
            system.win = RegExp[&quot;$1&quot;];
        }
    }
}

  // 移动设备
  system.iphone = ua.indexOf(&quot;iPhone&quot;) &gt; -1;
  system.ipad = ua.indexOf(&quot;iPad&quot;) &gt; -1;
  system.ipod = ua.indexOf(&quot;iPod&quot;) &gt; -1;
  system.nokiaN = ua.indexOf(&quot;nokiaN&quot;) &gt; -1;

  // windows mobile，简称 Windows CE，用于 Pocket PC 和 Smartphone 中。
  /**
  * 在 Windows Mobile 5.0 及以前版本，上面两种设备的 UA 很相似，比如：
  * Mozilla/4.0 (compatible; MSIE 4.01; Windows CE; PPC; 240x320)
  * Mozilla/4.0 (compatible; MSIE 4.01; Windows CE; Smartphone; 176x220)
  * 因为在 Windows Mobile 5.0 以后版本的浏览器中，移除了上面的记号 &quot;PPC&quot; 和 &quot;Smartphone&quot;，
  * 所以不建议测试字符串中的 &quot;PPC&quot; 和 &quot;Smartphone&quot;。一般情况下，只是到某个设备使用的是 Windows
  * Mobile 就足够了。
  * Windows Phone 7 的 UA 稍有改进，基本格式如下：
  * Mozilla/4.0 (compatible; MSIE 7.0; Windows Phone OS 7.0; Trident/3.1; IEMobile/7.0)
  * Asus; Galaxy6
  * 其中，Windows 操作符的标识符与以往完全不同，在这个用户代理中， client.system.win == &quot;Ph&quot;
  */
  if (system.win == &quot;CE&quot;) {
    system.winMobile = system.win;
  } else if (system.win == &quot;Ph&quot;) {
    if(/Windows Phone OS (\d+\.\d+)/.test(ua)) {
        system.win = &quot;Phone&quot;;
        system.winMobile = parseFloat(RegExp[&quot;$1&quot;]);
    }
  }

  // 检测 iOS 版本
  /**
  * iOS 3 之前，UA 只包含 &quot;CPU like Max OS&quot;,后来 iPhone 中又改成 &quot;CPU iPhone OS 3_0 like Mac
  * OS X&quot;, iPad 中又改成 &quot;CPU OS 3_2 like Mac OS X&quot;。
  */
  if (system.mac &amp;&amp; ua.indexOf(&quot;Mobile&quot;) &gt; -1) {
    if (/CPU (?:iPhone )?OS (\d+_\d+)/.test(ua)) {
        system.ios = parseFloat(RegExp.$1.replace(&quot;_&quot;,&quot;.&quot;));
    } else {
        system.ios = 2;// 因为没有办法确定到底是什么版本，所以设置为更早的版本比较稳妥。
    }
  }

  // 检测 Android 版本,只需简单的获取字符串 &quot;Android&quot; 紧随其后的版本号
  if (/Android (\d+\.\d+)/.test(ua)) {
    system.android = parseFloat(RegExp.$1);
  }

  // 游戏系统
  system.wii = ua.indexOf(&quot;Wii&quot;) &gt; -1;
  system.playstation = /playstation/i.test(ua);

  // 返回这些对象
  return {
    engine: engine,
    browser: browser,
    system: system
  };
}();
</code></pre><p>以上的脚本是出自 2012年3月份的，但放在今天还是适用的，知识更新速度还不至于夸张到几年前的东西放到今天大多都不能使用。然而对于后面出现的一些新的浏览器特性，就只能靠大家一起努力去完善这份脚本了。</p>
<p>有了上面的脚本，我们就可以这样方便的使用了。</p>
<p>比如：</p>
<pre><code>// 区分浏览器
if (client.engine.webkit) {
  if (client.browser.chrome) {
    // 执行针对 chrome 的代码
  } else if (client.browser.safari) {
    // 执行针对 safari 的代码
    }
} else if (client.engine.gecko) {
    if (client.browser.firefox) {
        // 执行针对 firefox 的代码
    } else {
        // 执行针对其他 gecko 的浏览器代码
    }
  }

// 区分系统
if (client.system.win) {
  if (client.system.win == &quot;XP&quot;) {
    // 说明是 XP
  } else if (client.system.win == &quot;Vista&quot;) {
    // 说明是 Vista
  }
}

// 移动端
if (client.system.webkit) {
  if (client.system.ios) {

  } else if (client.system.android) {

  }
}
</code></pre><p>等等。</p>
<p>这里虽然没有对能力检测和怪癖检测进行详细总结，但并不代表它们不重要。在决定使用哪种客户端检测方法时，一般应优先考虑使用能力检测。怪癖检测是确定应该如何处理代码的第二选择。用户代理检测则是客户端检测的最后一种方案，因为该方法对 UA 有很强的依赖性。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/JavaScript/">JavaScript</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-聊聊-Android-的-Service-组件" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/09/15/聊聊-Android-的-Service-组件/" class="article-date">
  	<time datetime="2016-09-15T15:18:09.000Z" itemprop="datePublished">2016-09-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/15/聊聊-Android-的-Service-组件/">聊聊 Android 的 Service 组件</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Android 开发的同学都知道，Android 有四大组件，分别是 <a href="https://developer.android.com/reference/android/app/Activity.html" target="_blank" rel="external">Activity</a>、<a href="https://developer.android.com/reference/android/app/Service.html" target="_blank" rel="external">Service</a>、<a href="https://developer.android.com/reference/android/content/BroadcastReceiver.html" target="_blank" rel="external">BroadcastReceiver</a> 和 <a href="https://developer.android.com/reference/android/content/ContentProvider.html" target="_blank" rel="external">ContentProvider</a>。在这里，我想跟大家聊一聊 Service 组件，我们从头开始，包括什么是 Service？Service 有什么作用？怎么使用它？需要关注哪些性能问题？什么情况下使用它最合适？好，废话少说，马上进入主题。</p>
<p>直译过来，Service 就是服务。它跟 Activity 不同，没有界面，不直接与用户进行交互，是一个可以在后台长时间运行的应用组件。服务可以由其他应用组件来启动，也可以由系统来启动。当用户从你的应用切换到其他应用后，我们的服务仍然可以在后台继续运行，甚至有些情况下，你退出了应用，服务仍能继续运行。最典型的例子就是音乐播放器了，当你退出应用后，音乐还能继续播放。又比如钉钉和微信，只要你没有在系统里禁止掉它们，即使杀掉它们的应用进程，你还是能收到别人给你发的消息。事实上，当你杀掉一个应用的进程后，该应用包括后台服务就彻底完了，只不过微信和钉钉有自启策略，又把服务拉起来了，这样你才能实时收到消息。</p>
<p>我们一般会在 Service 里做什么呢？上面刚举了一个例子，可以在 Service 里播放音乐，这样当用户手机锁屏或者按了 Home 键回到桌面，我们的音乐仍然能处于播放状态。另外，我们会常在 Service 里处理一些网络请求(如文件上传/下载等)、执行文件 I/O 或与内容提供程序(ContentProvider)交互等。</p>
<p>Service 有两种启动方式：</p>
<ul>
<li>通过 startService() 来启动</li>
<li>通过 bindService() 绑定服务启动</li>
</ul>
<p>Service 跟 Activity 一样，有它自己的生命周期。上面两种方式启动的 Service，其生命周期是有一些区别的，看下面的图：</p>
<p><img src="https://gw.alicdn.com/tps/TB1onGRLXXXXXcvXVXXXXXXXXXX-389-507.png" alt=""></p>
<p>左图是使用 startService() 所创建的服务的生命周期，右图是使用 bindService() 所创建的服务的生命周期。</p>
<p>服务的<strong>整个生命周期</strong>从调用 <code>onCreate()</code> 开始起，到 <code>onDestroy()</code> 返回时结束。与 Activity 类似，服务也在 <code>onCreate()</code> 中完成初始设置，并在<code>onDestroy()</code> 中释放所有剩余资源。例如，音乐播放服务可以在 <code>onCreate()</code> 中创建用于播放音乐的线程，然后在 <code>onDestroy()</code> 中停止该线程。无论服务是通过 <code>startService()</code> 还是 <code>bindService()</code> 创建，都会为所有服务调用 <code>onCreate()</code> 和 <code>onDestroy()</code> 方法。</p>
<p>服务的<strong>有效生命周期</strong>从调用 <code>onStartCommand()</code> 或 <code>onBind()</code> 方法开始。每种方法均有 <code>Intent</code> 对象，该对象分别传递到 <code>startService()</code> 或<code>bindService()</code>。</p>
<h4 id="startService"><a href="#startService" class="headerlink" title="startService()"></a>startService()</h4><p>下面是一个普通的 Service 例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"LocalService"</span>;</div><div class="line">    <span class="keyword">private</span> NotificationManager mNM;</div><div class="line"></div><div class="line">    <span class="comment">// Unique Identification Number for the Notification.</span></div><div class="line">    <span class="comment">// We use it on Notification start, and to cancel it.</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> NOTIFICATION = R.string.local_service_started;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Class for clients to access.  Because we know this service always</div><div class="line">     * runs in the same process as its clients, we don't need to deal with</div><div class="line">     * IPC.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalBinder</span> <span class="keyword">extends</span> <span class="title">Binder</span> </span>&#123;</div><div class="line">        <span class="function">LocalService <span class="title">getService</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> LocalService.<span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LocalService</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// This is the object that receives interactions from clients.  See</span></div><div class="line">    <span class="comment">// RemoteService for a more complete example.</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IBinder mBinder = <span class="keyword">new</span> LocalBinder();</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onBind"</span>);</div><div class="line">        <span class="keyword">return</span> mBinder;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onCreate"</span>);</div><div class="line">        mNM = (NotificationManager)getSystemService(NOTIFICATION_SERVICE);</div><div class="line"></div><div class="line">        <span class="comment">// Display a notification about us starting.  We put an icon in the status bar.</span></div><div class="line">        showNotification();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onStartCommand"</span>);</div><div class="line">        Log.i(<span class="string">"LocalService"</span>, <span class="string">"Received start id "</span> + startId + <span class="string">": "</span> + intent);</div><div class="line">        <span class="keyword">return</span> START_NOT_STICKY;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">(Intent intent, <span class="keyword">int</span> startId)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onStart"</span>);</div><div class="line">        <span class="keyword">super</span>.onStart(intent, startId);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onUnbind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onUnbind"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onUnbind(intent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onDestroy"</span>);</div><div class="line">        <span class="comment">// Cancel the persistent notification.</span></div><div class="line">        mNM.cancel(NOTIFICATION);</div><div class="line"></div><div class="line">        <span class="comment">// Tell the user we stopped.</span></div><div class="line">        Toast.makeText(<span class="keyword">this</span>, R.string.local_service_stopped, Toast.LENGTH_SHORT).show();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Show a notification while this service is running.</div><div class="line">     */</div><div class="line">    <span class="meta">@TargetApi</span>(<span class="number">16</span>)</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showNotification</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// In this sample, we'll use the same text for the ticker and the expanded notification</span></div><div class="line">        CharSequence text = getText(R.string.local_service_started);</div><div class="line"></div><div class="line">        <span class="comment">// The PendingIntent to launch our activity if the user selects this notification</span></div><div class="line">        PendingIntent contentIntent = PendingIntent.getActivity(<span class="keyword">this</span>, <span class="number">0</span>,</div><div class="line">                <span class="keyword">new</span> Intent(<span class="keyword">this</span>, OtherActivity.class), <span class="number">0</span>);</div><div class="line"></div><div class="line">        <span class="comment">// Set the info for the views that show in the notification panel.</span></div><div class="line">        Notification notification = <span class="keyword">new</span> Notification.Builder(<span class="keyword">this</span>)</div><div class="line">                .setSmallIcon(R.mipmap.ic_launcher)  <span class="comment">// the status icon</span></div><div class="line">                .setTicker(text)  <span class="comment">// the status text</span></div><div class="line">                .setWhen(System.currentTimeMillis())  <span class="comment">// the time stamp</span></div><div class="line">                .setContentTitle(getText(R.string.local_service_label))  <span class="comment">// the label of the entry</span></div><div class="line">                .setContentText(text)  <span class="comment">// the contents of the entry</span></div><div class="line">                .setContentIntent(contentIntent)  <span class="comment">// The intent to send when the entry is clicked</span></div><div class="line">                .build();</div><div class="line"></div><div class="line">        <span class="comment">// Send the notification.</span></div><div class="line">        mNM.notify(NOTIFICATION, notification);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Activity 用来启动和结束服务，具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, LocalService.class);</div><div class="line">        startService(intent);<span class="comment">// 这里我们先使用 startService 来启动服务</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, LocalService.class);</div><div class="line">        stopService(intent);<span class="comment">// 使用 startService 启动的服务，需要我们通过 stopService 来结束它</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>XML 布局代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span></span></div><div class="line">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></div><div class="line">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:paddingBottom</span>=<span class="string">"@dimen/activity_vertical_margin"</span></div><div class="line">    <span class="attr">android:paddingLeft</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></div><div class="line">    <span class="attr">android:paddingRight</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></div><div class="line">    <span class="attr">android:paddingTop</span>=<span class="string">"@dimen/activity_vertical_margin"</span></div><div class="line">    <span class="attr">tools:context</span>=<span class="string">"com.xhj.huijian.servicedemo.MainActivity"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"Hello World!"</span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/textView"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"startService"</span></div><div class="line">        <span class="attr">android:onClick</span>=<span class="string">"start"</span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/button"</span></div><div class="line">        <span class="attr">android:layout_below</span>=<span class="string">"@+id/textView"</span></div><div class="line">        <span class="attr">android:layout_alignParentLeft</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">android:layout_alignParentStart</span>=<span class="string">"true"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"stopService"</span></div><div class="line">        <span class="attr">android:onClick</span>=<span class="string">"stop"</span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/button2"</span></div><div class="line">        <span class="attr">android:layout_below</span>=<span class="string">"@+id/button"</span></div><div class="line">        <span class="attr">android:layout_alignParentLeft</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">android:layout_alignParentStart</span>=<span class="string">"true"</span>/&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>如同 Activity（以及其他组件）一样，您必须在应用的清单文件(AndroidManifest.xml)中声明所有服务。需要添加 <a href="https://developer.android.com/guide/topics/manifest/service-element.html" target="_blank" rel="external"><code>&lt;service&gt;</code></a> 元素作为 <a href="https://developer.android.com/guide/topics/manifest/application-element.html" target="_blank" rel="external"><code>&lt;application&gt;</code></a> 元素的子元素。例如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">...</span> &gt;</span></div><div class="line">  ...</div><div class="line">  <span class="tag">&lt;<span class="name">application</span> <span class="attr">...</span> &gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">".service.LocalService"</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">activity</span>&gt;</span>...<span class="tag">&lt;/<span class="name">activity</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">activity</span>&gt;</span>...<span class="tag">&lt;/<span class="name">activity</span>&gt;</span></div><div class="line">      ...</div><div class="line">  <span class="tag">&lt;/<span class="name">application</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></div></pre></td></tr></table></figure>
<p>service 标签有一些常见的选项，我在这里也跟大家罗列一下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">service</span></span></div><div class="line">            <span class="attr">android:name</span>=<span class="string">".service.LocalService"</span></div><div class="line">            <span class="attr">android:exported</span>=<span class="string">"false"</span></div><div class="line">            <span class="attr">android:enabled</span>=<span class="string">"true"</span></div><div class="line">            <span class="attr">android:label</span>=<span class="string">"@string/local_service_label"</span></div><div class="line">            <span class="attr">android:icon</span>=<span class="string">"@mipmap/ic_launcher"</span></div><div class="line">            <span class="attr">android:permission</span>=<span class="string">""</span></div><div class="line">            <span class="attr">android:process</span>=<span class="string">":process"</span>&gt;</div><div class="line">        <span class="tag">&lt;/<span class="name">service</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">android:name:　服务类名</div><div class="line">android:label: 这个属性用于设定一个要显示给用户的服务的名称。如果没有设置这个属性，则会使用&lt;application&gt;元素的label属性值来代替。</div><div class="line">android:icon: 这个属性定义了一个代表服务的图标，它必须要引用一个包含图片定义的可绘制资源。如果这个属性没有设置，则会使用&lt;application&gt;元素的icon属性所设定的图标来代替。</div><div class="line">android:permission: 申明此服务的权限，这意味着只有提供了该权限的应用才能控制或连接此服务</div><div class="line">android:process: 表示该服务是否运行在另外一个进程，如果设置了此项，那么将会在包名后面加上这段字符串表示另一进程的名字</div><div class="line">android:enabled: 这个属性用于指示该服务是否能够被实例化。如果设置为true，则能够被实例化，否则不能被实例化。默认值是true。</div><div class="line">android:exported： 表示该服务是否能够被其他应用程序所控制或连接，不设置默认此项为 false</div></pre></td></tr></table></figure>
<p>OK，大家可以看到，前面我在 LocalService 的每一个生命周期方法中都添加了 log 打印，这样方便我们在跑 demo 时看到效果。现在请先忽视 LocalBinder 这个类。当服务通过 startService 启动后，我在 onCreate() 里调用了 showNotification() 方法，这时候会在系统状态栏看到一条消息：</p>
<p><img src="https://gw.alicdn.com/tps/TB1GIa9LXXXXXXSXpXXXXXXXXXX-970-236.png" alt=""></p>
<p>如果你点击它，则会打开一个新的 Activity，简单的显示一条招呼内容：</p>
<p><img src="https://gw.alicdn.com/tps/TB1FRSPLXXXXXXYaXXXXXXXXXXX-980-324.png" alt=""></p>
<p>从前面的生命周期图中，我们可以知道，当我们启动一个服务后，它会依次调用 onCreate -&gt; onStartCommand 方法，我们看下日志输出：</p>
<p><img src="https://gw.alicdn.com/tps/TB1zG93LXXXXXaxXFXXXXXXXXXX-2266-190.png" alt=""></p>
<p>因为我在 onStartCommand 里多打印了一条 log，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Log.i(<span class="string">"LocalService"</span>, <span class="string">"Received start id "</span> + startId + <span class="string">": "</span> + intent);</div></pre></td></tr></table></figure>
<p>所以在 onStartCommand 后面多了一条日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Received start id 1: Intent &#123; cmp=com.xhj.huijian.servicedemo/.service.LocalService &#125;</div></pre></td></tr></table></figure>
<p>如果这时候，我再重新去启动这个服务，它是不会再走 onCreate 这个方法的，但会重复调用 onStartCommand 方法，从上图的日志就可以看出来啦，系统又打印了两条 log:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">07-31 01:42:11.928 11361-11361/com.xhj.huijian.servicedemo D/LocalService: onStartCommand</div><div class="line">07-31 01:42:11.928 11361-11361/com.xhj.huijian.servicedemo I/LocalService: Received start id 2: Intent &#123; cmp=com.xhj.huijian.servicedemo/.service.LocalService &#125;</div></pre></td></tr></table></figure>
<p>此时，我在主 Activity 点击了 stop 按钮结束服务，LocalService 就会调用 onDestory 方法并结束掉自己。</p>
<h4 id="bindService"><a href="#bindService" class="headerlink" title="bindService()"></a>bindService()</h4><p>现在，我们通过第二种方式 bindService()  来启动服务。首先，在主 Activity 的布局里我们添加一个 bindService 按钮，另其 android:onClick=”bind” ，并在主 Activity 实现 bind 方法，这样当你点击 bindService 按钮时 bind 方法就会被触发，这是 Android 另一种事件绑定的方式。 bindService 绑定 Service 之前，我们还需要去实现一个 ServiceConnection，它用来监视 Activity (client) 与 service 的连接状态。当创建了一个可以绑定的 service 之后，你必须提供一个 <a href="http://developer.android.com/reference/android/os/IBinder.html" target="_blank" rel="external">IBinder</a> 对象，它用来提供 Activity (client) 与service 进行交互的接口。前面我们提到的 LocalBinder 就是一个 IBinder 对象了。</p>
<p>回顾一下 LocalService ，有下面的一段代码，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Class for clients to access.  Because we know this service always</div><div class="line">     * runs in the same process as its clients, we don't need to deal with</div><div class="line">     * IPC.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalBinder</span> <span class="keyword">extends</span> <span class="title">Binder</span> </span>&#123;</div><div class="line">        <span class="function">LocalService <span class="title">getService</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> LocalService.<span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LocalService</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// This is the object that receives interactions from clients.  See</span></div><div class="line">    <span class="comment">// RemoteService for a more complete example.</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IBinder mBinder = <span class="keyword">new</span> LocalBinder();</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onBind"</span>);</div><div class="line">        <span class="keyword">return</span> mBinder;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在 onBind 方法里返回一个 IBinder 对象。</p>
<p>在 MainActivity 里实现 ServiceConnection 的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> LocalService mBoundService;</div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mIsBound = <span class="keyword">false</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> ServiceConnection mConnection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">  		<span class="comment">// 绑定成功时回调该方法</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName className, IBinder service)</span> </span>&#123;</div><div class="line">            <span class="comment">// This is called when the connection with the service has been</span></div><div class="line">            <span class="comment">// established, giving us the service object we can use to</span></div><div class="line">            <span class="comment">// interact with the service.  Because we have bound to a explicit</span></div><div class="line">            <span class="comment">// service that we know is running in our own process, we can</span></div><div class="line">            <span class="comment">// cast its IBinder to a concrete class and directly access it.</span></div><div class="line">            mBoundService = ((LocalService.LocalBinder)service).getService();</div><div class="line"></div><div class="line">            <span class="comment">// Tell the user about this for our demo.</span></div><div class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>, R.string.local_service_connected,</div><div class="line">                    Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line">		<span class="comment">// 解绑时回调该方法</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName className)</span> </span>&#123;</div><div class="line">            <span class="comment">// This is called when the connection with the service has been</span></div><div class="line">            <span class="comment">// unexpectedly disconnected -- that is, its process crashed.</span></div><div class="line">            <span class="comment">// Because it is running in our same process, we should never</span></div><div class="line">            <span class="comment">// see this happen.</span></div><div class="line">            mBoundService = <span class="keyword">null</span>;</div><div class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>, R.string.local_service_disconnected,</div><div class="line">                    Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line"><span class="comment">// 添加绑定和解绑方法</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">doBindService</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// Establish a connection with the service.  We use an explicit</span></div><div class="line">        <span class="comment">// class name because we want a specific service implementation that</span></div><div class="line">        <span class="comment">// we know will be running in our own process (and thus won't be</span></div><div class="line">        <span class="comment">// supporting component replacement by other applications).</span></div><div class="line">        bindService(<span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>,</div><div class="line">                LocalService.class), mConnection, Context.BIND_AUTO_CREATE);</div><div class="line">        mIsBound = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doUnbindService</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mIsBound) &#123;</div><div class="line">            <span class="comment">// Detach our existing connection.</span></div><div class="line">            unbindService(mConnection);</div><div class="line">            mIsBound = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="comment">// 在 bind 方法里调用 doBindService</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        doBindService();</div><div class="line">    &#125;</div><div class="line"><span class="comment">// 在 Activity 的 onDestory 方法里解绑</span></div><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        doUnbindService();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>bindService 比 startService 多了两个参数，需要传入 ServiceConnection 对象和一个绑定的选项，这里我们传入了 Context.BIND_AUTO_CREATE，表示只要有绑定存在，就自动创建服务(automatically create the service as long as the binding exists)。上面的代码，我们还在 Activity 的 onDestory 方法里调用了 doUnbindService 方法去解绑服务，事实上，当一个 client(这里指 Activity) 销毁后，即使我们没有在 onDestory 里进行解绑，被绑定的服务也会一同被销毁，因为系统会自动为我们解绑。这一点跟 startService 启动的服务不同，使用 startService 启动的服务，如果在 Activity 被销毁时没有调用 stopService()，服务还将在后台运行(如果是应用进程被杀掉，服务也就挂了)。</p>
<p>启动绑定服务并退出应用，可以看到下面的日志输出：</p>
<p><img src="https://gw.alicdn.com/tps/TB1CUbjLXXXXXXeXXXXXXXXXXXX-1230-130.png" alt=""></p>
<p>依次调用了 onCreate -&gt; onBind -&gt; onUnbind -&gt; onDestory 方法，这验证了前面说的使用 bindService 创建服务的生命周期。那如果我们重复 bindService 呢？其生命周期是否会发生改变？事实是，onCreate 和 onBind 都不会重复调用。</p>
<p>当我们需要允许组件与服务进行交互、发送请求、获取结果，甚至是利用进程间通信 (IPC) 跨进程执行这些操作时，就需要绑定服务提供一个客户端(client)-服务器(service)接口了。换句话说，通常是需要给其他程序组件提供服务时才会使用 bindService。</p>
<p>上面所说的都是本地服务(local service) ，即服务跑在应用主进程中。有本地自然就有远程啦，接下来，我们来了解远程服务 (remote service) 是什么样的。</p>
<h4 id="RemoteService-AIDL"><a href="#RemoteService-AIDL" class="headerlink" title="RemoteService(AIDL)"></a>RemoteService(AIDL)</h4><p>远程服务运行在独立的进程中，对应进程名格式为所在包名加上你指定的 android:process 字符串，前面介绍 service 标签常见选项时有提到过。比如，我有一个应用的包名是：com.example.servicedemo，我在其中一个 service 里添加了下面的属性 android:process=”:process”，这时候，这个服务就会运行在一个名叫 com.example.servicedemo:process 的进程中。由于是独立的进程，因此在 Activity 所在进程被Kill 的时候，该服务依然在运行，不受其他进程影响，有利于为多个进程提供服务具有较高的灵活性。</p>
<p>远程服务一般都是系统服务，并且都是常驻服务，Android 上第三方的消息推送服务，也都是跑在独立进程中的。</p>
<p>远程服务涉及到不同进程之间的通信(IPC，interprocess communication)，需要使用到 AIDL(Android Interface Definition Language)，用于生成可以在 Android 设备上两个进程之间进行进程间通信的代码。说到这里，你应该知道远程服务需要通过绑定来启动了。下面我们动起手，使用 AIDL 创建一个远程服务。</p>
<p>首先，我们另起一个 Android 工程 AIDLServer，用来充当跨进程通信的服务端，然后创建一个 .aidl 文件。在 AS 里创建 AIDL 很简单，在工程的 java 目录下，右键你的包名，选择 New -&gt; AIDL -&gt; AIDL File，</p>
<p><img src="https://gw.alicdn.com/tps/TB1S9yYLXXXXXayapXXXXXXXXXX-847-417.png" alt=""></p>
<p>我们将其命名为 IRemoteService，然后就会在 main 目录下出现一个 aidl 跟 java 同级别的目录，如图：</p>
<p><img src="https://gw.alicdn.com/tps/TB1Qqe1LXXXXXckaXXXXXXXXXXX-434-214.png" alt=""></p>
<p>在 IRemoteService.aidl 添加一个 getPid() 方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// IRemoteService.aidl</span></div><div class="line"><span class="keyword">package</span> com.xhj.huijian.aidlserver;</div><div class="line"></div><div class="line"><span class="comment">// Declare any non-default types here with import statements</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IRemoteService</span> </span>&#123;</div><div class="line">    <span class="comment">/** Request the process ID of this service, to do evil things with it. */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getPid</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Demonstrates some basic types that you can use as parameters</div><div class="line">     * and return values in AIDL.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat,</span></span></div><div class="line">            <span class="keyword">double</span> aDouble, String aString);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>说明一下，aidl 中支持的参数类型为：基本类型（int, long, char, boolean 等）,String, CharSequence, List, Map，其他类型必须使用 import 导入，即使它们可能在同一个包里。另外，接口中的参数除了 aidl 支持的类型，其他类型必须标识其方向：输入、输出或两者兼之，用 in，out 或者 inout 来表示，默认为 in。</p>
<p>我们可以在工程 app -&gt; build -&gt; generated -&gt; source -&gt; aidl -&gt; debug 下看到 AS 为我们自动生成了一个接口 IRemoteService，</p>
<p><img src="https://gw.alicdn.com/tps/TB1LnPcLXXXXXaWXFXXXXXXXXXX-434-267.png" alt=""></p>
<p>打开 IRemoteService 可以看到一个代理类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">xhj</span>.<span class="title">huijian</span>.<span class="title">aidlserver</span>.<span class="title">IRemoteService</span></span></div></pre></td></tr></table></figure>
<p>这个 Stub 类就是一个普通的 Binder，只不过它实现了我们定义的 aidl 接口。它还有一个静态方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Cast an IBinder object into an com.xhj.huijian.aidlserver.IRemoteService interface,</div><div class="line"> * generating a proxy if needed.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> com.xhj.huijian.aidlserver.<span class="function">IRemoteService <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span></span></div></pre></td></tr></table></figure>
<p>通过它，我们就可以在客户端中得到 IRemoteService 的实例，进而通过实例来调用其方法。现在，我们创建一个服务端的 service，在里面去实现 aidl 中的抽象函数，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"ServerService"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PACKAGE_PERMISSION = <span class="string">"com.xhj.huijian.servicedemo"</span>;</div><div class="line">    <span class="keyword">private</span> NotificationManager mNM;</div><div class="line"></div><div class="line">    <span class="comment">// Unique Identification Number for the Notification.</span></div><div class="line">    <span class="comment">// We use it on Notification start, and to cancel it.</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> NOTIFICATION = R.string.remote_service_started;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServerService</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 实现 aidl 中的抽象函数</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IRemoteService.Stub mBinder = <span class="keyword">new</span> IRemoteService.Stub() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPid</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            <span class="comment">// 这里返回进程 ID</span></div><div class="line">            <span class="keyword">return</span> Process.myPid();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat, <span class="keyword">double</span> aDouble, String aString)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            <span class="comment">// Does nothing</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 在这里可以做权限认证，return false 意味着客户端的调用就会失败，比如下面，只允许包名为 com.xhj.huijian.servicedemo 的客户端通过，</span></div><div class="line">        <span class="comment">// 其他 apk 将无法完成调用过程</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            String packageName = <span class="keyword">null</span>;</div><div class="line">            String[] packages = ServerService.<span class="keyword">this</span>.getPackageManager().</div><div class="line">                    getPackagesForUid(getCallingUid());</div><div class="line">            <span class="keyword">if</span> (packages != <span class="keyword">null</span> &amp;&amp; packages.length &gt; <span class="number">0</span>) &#123;</div><div class="line">                packageName = packages[<span class="number">0</span>];</div><div class="line">            &#125;</div><div class="line">            Log.d(TAG, <span class="string">"onTransact: "</span> + packageName);</div><div class="line">            <span class="keyword">if</span> (!PACKAGE_PERMISSION.equals(packageName)) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"remote service onCreate"</span>);</div><div class="line">        mNM = (NotificationManager)getSystemService(NOTIFICATION_SERVICE);</div><div class="line"></div><div class="line">        <span class="comment">// Display a notification about us starting.  We put an icon in the status bar.</span></div><div class="line">        showNotification();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"remote service onStartCommand"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"remote service onBind"</span>);</div><div class="line">        <span class="keyword">return</span> mBinder;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onUnbind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"remote service onUnbind"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onUnbind(intent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRebind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onRebind(intent);</div><div class="line">        Log.d(TAG, <span class="string">"remote service onRebind"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        Log.d(TAG, <span class="string">"remote service onDestroy"</span>);</div><div class="line">        <span class="comment">// Cancel the persistent notification.</span></div><div class="line">        mNM.cancel(NOTIFICATION);</div><div class="line"></div><div class="line">        <span class="comment">// Tell the user we stopped.</span></div><div class="line">        Toast.makeText(<span class="keyword">this</span>, R.string.remote_service_stopped, Toast.LENGTH_SHORT).show();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Show a notification while this service is running.</div><div class="line">     */</div><div class="line">    <span class="meta">@TargetApi</span>(<span class="number">16</span>)</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showNotification</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// In this sample, we'll use the same text for the ticker and the expanded notification</span></div><div class="line">        CharSequence text = getText(R.string.remote_service_started);</div><div class="line"></div><div class="line">        <span class="comment">// The PendingIntent to launch our activity if the user selects this notification</span></div><div class="line">        PendingIntent contentIntent = PendingIntent.getActivity(<span class="keyword">this</span>, <span class="number">0</span>,</div><div class="line">                <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MainActivity.class), <span class="number">0</span>);</div><div class="line"></div><div class="line">        <span class="comment">// Set the info for the views that show in the notification panel.</span></div><div class="line">        Notification notification = <span class="keyword">new</span> Notification.Builder(<span class="keyword">this</span>)</div><div class="line">                .setSmallIcon(R.mipmap.ic_launcher)  <span class="comment">// the status icon</span></div><div class="line">                .setTicker(text)  <span class="comment">// the status text</span></div><div class="line">                .setWhen(System.currentTimeMillis())  <span class="comment">// the time stamp</span></div><div class="line">                .setContentTitle(getText(R.string.remote_service_label))  <span class="comment">// the label of the entry</span></div><div class="line">                .setContentText(text)  <span class="comment">// the contents of the entry</span></div><div class="line">                .setContentIntent(contentIntent)  <span class="comment">// The intent to send when the entry is clicked</span></div><div class="line">                .build();</div><div class="line"></div><div class="line">        <span class="comment">// Send the notification.</span></div><div class="line">        mNM.notify(NOTIFICATION, notification);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ServerService 中 new 了一个 IRemoteService.Stub 对象，并实现了其抽象方法，然后在 onBind 方法返回给 client，这不难理解。在这里我要说的是在 IRemoteService.Stub 里被我们重写的 onTransact 方法，在该方法中可以根据调用者的 uid 来获取其信息，然后做权限认证，如果返回 true，则调用成功，否则调用会失败。这样我们的服务就可以做到只让某个特定的 apk 使用，而不是所有的 apk 都能使用。</p>
<p>接下来，在 AndroidMenifest 中声明我们的服务，</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">service</span></span></div><div class="line">           <span class="attr">android:name</span>=<span class="string">".ServerService"</span></div><div class="line">           <span class="attr">android:process</span>=<span class="string">":remote"</span></div><div class="line">           <span class="attr">android:enabled</span>=<span class="string">"true"</span></div><div class="line">           <span class="attr">android:exported</span>=<span class="string">"true"</span>&gt;</div><div class="line">           <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></div><div class="line">               <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;</span></div><div class="line">               <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"com.xhj.huijian.aidlserver.ServerService"</span> /&gt;</span></div><div class="line">           <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></div><div class="line">       <span class="tag">&lt;/<span class="name">service</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"com.xhj.huijian.aidlserver.ServerService"</span> /&gt;</span></div></pre></td></tr></table></figure>
<p>这一句是为了让其他应用通过隐式的方式来 bind 我们的 Service。通过隐式调用的方式来起 activity 或者service，需要把 category 设为 default，这是因为，隐式调用的时候，intent 中的 category 默认会被设置为default。这里需要注意的是，exported 要设置为 true，否则其他应用就绑定不了我们的服务了。</p>
<p>现在回到我们的“客户端”，第一个工程，在 MainActivity 里我们稍加一些测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="comment">// action，隐式调用</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_BIND_SERVICE = <span class="string">"com.xhj.huijian.aidlserver.ServerService"</span>;</div><div class="line"><span class="keyword">private</span> IRemoteService mIRemoteService;</div><div class="line"></div><div class="line"><span class="comment">// 远程服务 ServiceConnection</span></div><div class="line">    <span class="keyword">private</span> ServiceConnection mRemoteConnection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName componentName, IBinder iBinder)</span> </span>&#123;</div><div class="line">            mIRemoteService = IRemoteService.Stub.asInterface(iBinder);</div><div class="line">            <span class="keyword">int</span> pid = <span class="number">0</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                pid = mIRemoteService.getPid();</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            Log.d(TAG, <span class="string">"process id : "</span> + pid);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName componentName)</span> </span>&#123;</div><div class="line">            mIRemoteService = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line"><span class="comment">// 添加一个启动远程服务进程的 button，设置 onClick = bindRemoteService</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bindRemoteService</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(ACTION_BIND_SERVICE);</div><div class="line">        intent.setPackage(<span class="string">"com.xhj.huijian.aidlserver"</span>);</div><div class="line">        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</div><div class="line">        bindService(intent, mRemoteConnection, Context.BIND_AUTO_CREATE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">	    ...</div><div class="line">        <span class="keyword">if</span> (mIRemoteService != <span class="keyword">null</span>) &#123;</div><div class="line">            unbindService(mRemoteConnection);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>和前面一样，我们绑定服务前要声明一个 ServiceConnection，我们在 onServiceConnected 方法里去获取 IRemoteService 的实例，然后调用它的方法 getPid 打印出一条 log，这里需要 try catch 一下捕获异常。在写 demo 时我遇到了一个问题，原本在 bindRemoteService 里我是这样写的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bindRemoteService</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(ACTION_BIND_SERVICE);</div><div class="line">        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</div><div class="line">        bindService(intent, mRemoteConnection, Context.BIND_AUTO_CREATE);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>少了这一行代码 intent.setPackage(“com.xhj.huijian.aidlserver”); 然后在运行 demo 时发生了 crash，错误日志有这么一句，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">IllegalArgumentException: Service Intent must be explicit</div></pre></td></tr></table></figure>
<p>经查阅资料发现，在 Android 5.0 以后服务必须采用显示方式启动，刚好我的模拟器就是 5.0 的，醉了。不过，方法还是有的，就是加上那句设置应用包名的代码，这是 Google 推荐的解决方法。OK，先安装好服务端，然后打开客户端，点击绑定远程服务按钮，可以看到系统状态栏弹出了一条消息，效果图如下：</p>
<p><img src="https://gw.alicdn.com/tps/TB1sXnpLXXXXXalXFXXXXXXXXXX-996-314.png" alt=""></p>
<p>从日志可以看出，我们调用 ServerService 的 getPid 方法成功了，输出了 process id : 16822</p>
<p><img src="https://gw.alicdn.com/tps/TB1lvPfLXXXXXbXXVXXXXXXXXXX-1350-54.png" alt=""></p>
<p>下面是 ServerService 的生命周期，跟本地服务绑定的生命周期一个样。</p>
<p><img src="https://gw.alicdn.com/tps/TB1qFTqLXXXXXXZXFXXXXXXXXXX-1762-166.png" alt=""></p>
<p>如果 AIDL 所支持的参数类型不满足我们的需求，我们想传输自定义类型的对象，该怎么做呢？</p>
<p>首先，在 AIDLServer 工程新建一个 Rect.aidl (名字随便起一个) 文件，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Rect.aidl</span></div><div class="line"><span class="keyword">package</span> com.xhj.huijian.aidlserver;</div><div class="line"></div><div class="line"><span class="comment">// Declare any non-default types here with import statements</span></div><div class="line">parcelable Rect;</div></pre></td></tr></table></figure>
<p>这里 parcelable 是个类型，首字母是小写的，和 Parcelable 接口不是一个东西。</p>
<p>Rect.java 代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Rect</span> <span class="keyword">implements</span> <span class="title">Parcelable</span></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> left;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> top;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> right;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> bottom;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Rect</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Rect</span><span class="params">(Parcel in)</span> </span>&#123;</div><div class="line">        readFromParcel(in);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Creator&lt;Rect&gt; CREATOR = <span class="keyword">new</span> Creator&lt;Rect&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Rect <span class="title">createFromParcel</span><span class="params">(Parcel in)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Rect(in);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> Rect[] newArray(<span class="keyword">int</span> size) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Rect[size];</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">describeContents</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel parcel, <span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">        parcel.writeInt(left);</div><div class="line">        parcel.writeInt(top);</div><div class="line">        parcel.writeInt(right);</div><div class="line">        parcel.writeInt(bottom);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFromParcel</span><span class="params">(Parcel in)</span> </span>&#123;</div><div class="line">        left = in.readInt();</div><div class="line">        top = in.readInt();</div><div class="line">        right = in.readInt();</div><div class="line">        bottom = in.readInt();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过 AIDL 传输非基本类型的对象，被传输的对象需要序列化，Android sdk 提供了更轻量级更方便的方法，即实现 Parcelable 接口，上面就是一个去实现 Parcelable 接口的例子。你需要去实现一些抽象方法，还有 Parcelable.CREATOR 接口。</p>
<p>回到 IRemoteService.aidl，往里面添加一些代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// IRemoteService.aidl</span></div><div class="line"><span class="keyword">package</span> com.xhj.huijian.aidlserver;</div><div class="line"><span class="keyword">import</span> com.xhj.huijian.aidlserver.Rect;</div><div class="line"><span class="comment">// Declare any non-default types here with import statements</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IRemoteService</span> </span>&#123;</div><div class="line">    <span class="comment">/** Request the process ID of this service, to do evil things with it. */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getPid</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Demonstrates some basic types that you can use as parameters</div><div class="line">     * and return values in AIDL.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat,</span></span></div><div class="line">            <span class="keyword">double</span> aDouble, String aString);</div><div class="line"></div><div class="line">    List&lt;com.xhj.huijian.aidlserver.Rect&gt; getRect();</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addRect</span><span class="params">(in com.xhj.huijian.aidlserver.Rect rect)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>新增了两个方法 getRect() 和 addRect(in Rect rect)，前面提到过，除了 aidl 支持的类型外，其他类型都必须标识其方向，这里 addRect 方法参数用 in 标记，因为它是输入型参数。</p>
<p>ServerService 做了一些修改，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> List&lt;Rect&gt; mRects = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">...</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> IRemoteService.Stub mBinder = <span class="keyword">new</span> IRemoteService.Stub() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPid</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            <span class="comment">// 这里返回进程 ID</span></div><div class="line">            <span class="keyword">return</span> Process.myPid();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat, <span class="keyword">double</span> aDouble, String aString)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            <span class="comment">// Does nothing</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">  	    <span class="comment">// 实现两个新增的方法</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> List&lt;Rect&gt; <span class="title">getRect</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            <span class="keyword">synchronized</span> (mRects) &#123;</div><div class="line">                <span class="keyword">return</span> mRects;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRect</span><span class="params">(Rect rect)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            <span class="keyword">synchronized</span> (mRects) &#123;</div><div class="line">                <span class="keyword">if</span> (!mRects.contains(rect)) &#123;</div><div class="line">                    mRects.add(rect);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">...</div><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"remote service onCreate"</span>);</div><div class="line">        mNM = (NotificationManager)getSystemService(NOTIFICATION_SERVICE);</div><div class="line"></div><div class="line">        <span class="comment">// Display a notification about us starting.  We put an icon in the status bar.</span></div><div class="line">        showNotification();</div><div class="line">        <span class="comment">// 初始化一些数据</span></div><div class="line">        <span class="keyword">synchronized</span> (mRects) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</div><div class="line">                Rect rect = <span class="keyword">new</span> Rect();</div><div class="line">                rect.top = i * <span class="number">1</span>;</div><div class="line">                rect.left = i * <span class="number">2</span>;</div><div class="line">                rect.right = i * <span class="number">4</span>;</div><div class="line">                rect.bottom = i * <span class="number">8</span>;</div><div class="line">                mRects.add(rect);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>因为我们增加了两个文件，Rect.aidl 和 Rect.class，所以也需要把这个两个文件拷贝到客户端中去。把 Rect.aidl 放在跟 IRemoteService 同目录下，在客户端工程(ServiceDemo)新建一个包，名为 com.xhj.huijian.aidlserve， Rect.class 在服务端的包名一样。客户端的 MainActivity 我们也修改一下调用代码，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 远程服务 ServiceConnection</span></div><div class="line">    <span class="keyword">private</span> ServiceConnection mRemoteConnection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName componentName, IBinder iBinder)</span> </span>&#123;</div><div class="line">            mIRemoteService = IRemoteService.Stub.asInterface(iBinder);</div><div class="line">            <span class="keyword">int</span> pid = <span class="number">0</span>;</div><div class="line">            Rect rect = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                pid = mIRemoteService.getPid();</div><div class="line">                <span class="comment">// 因为第一个元素的四个属性值都是0，所以我在这里取 rect 数组的第二个元素</span></div><div class="line">                rect = mIRemoteService.getRect().get(<span class="number">1</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            Log.d(TAG, <span class="string">"process id : "</span> + pid);</div><div class="line">            Log.d(TAG, <span class="string">"rect top : "</span> + rect.top + <span class="string">" right : "</span> + rect.right + <span class="string">" left : "</span></div><div class="line">            + rect.left + <span class="string">" bottom : "</span> + rect.bottom);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName componentName)</span> </span>&#123;</div><div class="line">            mIRemoteService = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div></pre></td></tr></table></figure>
<p>OK，重新 run 一下工程，点击绑定按钮，可以看到下面的日志输出，</p>
<p><img src="https://gw.alicdn.com/tps/TB120DxLXXXXXbTXpXXXXXXXXXX-1696-60.png" alt=""></p>
<p>大功告成！是不是觉得 AIDL 实现起来稍微麻烦了些啊？反正我是觉得挺烦的，那下面就给大家介绍不用 AIDL 实现 IPC 的一个简便方法。嘿，请别喷我，这只是一个简便方法。</p>
<p>大概的思路如下：</p>
<ul>
<li>Service 实现一个 Handler 来接受 Client 的每一个 callback。</li>
<li>这个 Handler 用来创建 Messenger 对象。</li>
<li>Messenger 创建一个 IBinder 对象，Service 在 onBind 方法里面把这个对象返回给客户端。</li>
<li>客户端使用这个 IBinder 对象来实例化 Messenger (that references the service’s Handler), 然后客户端使用这个 messager 再发送 message 对象给 service。</li>
<li>Service 在它的 handler 里面接收到每一个 Message。</li>
</ul>
<p>直接上代码，代码演示了 client 和 service 怎么进行交互的。</p>
<p>Service 代码(AIDLServer)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"MessageService"</span>;</div><div class="line">    <span class="comment">/** For showing and hiding our notification. */</span></div><div class="line">    NotificationManager mNM;</div><div class="line">    <span class="comment">/** Keeps track of all current registered clients. */</span></div><div class="line">    ArrayList&lt;Messenger&gt; mClients = <span class="keyword">new</span> ArrayList&lt;Messenger&gt;();</div><div class="line">    <span class="comment">/** Holds last value set by a client. */</span></div><div class="line">    <span class="keyword">int</span> mValue = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Command to the service to register a client, receiving callbacks</div><div class="line">     * from the service.  The Message's replyTo field must be a Messenger of</div><div class="line">     * the client where callbacks should be sent.</div><div class="line">     */</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_REGISTER_CLIENT = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Command to the service to unregister a client, ot stop receiving callbacks</div><div class="line">     * from the service.  The Message's replyTo field must be a Messenger of</div><div class="line">     * the client as previously given with MSG_REGISTER_CLIENT.</div><div class="line">     */</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_UNREGISTER_CLIENT = <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Command to service to set a new value.  This can be sent to the</div><div class="line">     * service to supply a new value, and will be sent by the service to</div><div class="line">     * any registered clients with the new value.</div><div class="line">     */</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SET_VALUE = <span class="number">3</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Handler of incoming messages from clients.</div><div class="line">     */</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">IncomingHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">                <span class="keyword">case</span> MSG_REGISTER_CLIENT:</div><div class="line">                    mClients.add(msg.replyTo);</div><div class="line">                    Log.d(TAG, <span class="string">"register_client"</span>);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> MSG_UNREGISTER_CLIENT:</div><div class="line">                    mClients.remove(msg.replyTo);</div><div class="line">                    Log.d(TAG, <span class="string">"unregister_client"</span>);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> MSG_SET_VALUE:</div><div class="line">                    Log.d(TAG, <span class="string">"set_value"</span>);</div><div class="line">                    mValue = msg.arg1;</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = mClients.size()-<span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            mClients.get(i).send(Message.obtain(<span class="keyword">null</span>,</div><div class="line">                                    MSG_SET_VALUE, mValue, <span class="number">0</span>));</div><div class="line">                        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                            <span class="comment">// The client is dead.  Remove it from the list;</span></div><div class="line">                            <span class="comment">// we are going through the list from back to front</span></div><div class="line">                            <span class="comment">// so this is safe to do inside the loop.</span></div><div class="line">                            mClients.remove(i);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">super</span>.handleMessage(msg);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Target we publish for clients to send messages to IncomingHandler.</div><div class="line">     */</div><div class="line">    <span class="keyword">final</span> Messenger mMessenger = <span class="keyword">new</span> Messenger(<span class="keyword">new</span> IncomingHandler());</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MessageService</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        mNM = (NotificationManager)getSystemService(NOTIFICATION_SERVICE);</div><div class="line">        <span class="comment">// Display a notification about us starting.</span></div><div class="line">        showNotification();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        <span class="comment">// Cancel the persistent notification.</span></div><div class="line">        mNM.cancel(R.string.remote_service_started);</div><div class="line">        <span class="comment">// Tell the user we stopped.</span></div><div class="line">        Toast.makeText(<span class="keyword">this</span>, R.string.remote_service_stopped, Toast.LENGTH_SHORT).show();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * When binding to the service, we return an interface to our messenger</div><div class="line">     * for sending messages to the service.</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mMessenger.getBinder();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Show a notification while this service is running.</div><div class="line">     */</div><div class="line">    <span class="meta">@TargetApi</span>(<span class="number">16</span>)</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showNotification</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// In this sample, we'll use the same text for the ticker and the expanded notification</span></div><div class="line">        CharSequence text = getText(R.string.remote_service_started);</div><div class="line">        <span class="comment">// The PendingIntent to launch our activity if the user selects this notification</span></div><div class="line">        PendingIntent contentIntent = PendingIntent.getActivity(<span class="keyword">this</span>, <span class="number">0</span>,</div><div class="line">                <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MainActivity.class), <span class="number">0</span>);</div><div class="line">        <span class="comment">// Set the info for the views that show in the notification panel.</span></div><div class="line">        Notification notification = <span class="keyword">new</span> Notification.Builder(<span class="keyword">this</span>)</div><div class="line">                .setSmallIcon(R.mipmap.ic_launcher)  <span class="comment">// the status icon</span></div><div class="line">                .setTicker(text)  <span class="comment">// the status text</span></div><div class="line">                .setWhen(System.currentTimeMillis())  <span class="comment">// the time stamp</span></div><div class="line">                .setContentTitle(getText(R.string.remote_service_label))  <span class="comment">// the label of the entry</span></div><div class="line">                .setContentText(text)  <span class="comment">// the contents of the entry</span></div><div class="line">                .setContentIntent(contentIntent)  <span class="comment">// The intent to send when the entry is clicked</span></div><div class="line">                .build();</div><div class="line">        <span class="comment">// Send the notification.</span></div><div class="line">        <span class="comment">// We use a string id because it is a unique number.  We use it later to cancel.</span></div><div class="line">        mNM.notify(R.string.remote_service_started, notification);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 AndroidManifest 中注册，</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">service</span></span></div><div class="line">            <span class="attr">android:name</span>=<span class="string">".MessageService"</span></div><div class="line">            <span class="attr">android:enabled</span>=<span class="string">"true"</span></div><div class="line">            <span class="attr">android:exported</span>=<span class="string">"true"</span></div><div class="line">            <span class="attr">android:process</span>=<span class="string">":remote_msg"</span>&gt;</div><div class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"com.xhj.huijian.aidlserver.MessageService"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">service</span>&gt;</span></div></pre></td></tr></table></figure>
<p>在客户端工程新建一个 MessageActivity，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageServiceActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_BIND_SERVICE = <span class="string">"com.xhj.huijian.aidlserver.MessageService"</span>;</div><div class="line">    <span class="comment">/** Messenger for communicating with service. */</span></div><div class="line">    Messenger mService = <span class="keyword">null</span>;</div><div class="line">    <span class="comment">/** Flag indicating whether we have called bind on the service. */</span></div><div class="line">    <span class="keyword">boolean</span> mIsBound;</div><div class="line">    <span class="comment">/** Some text view we are using to show state information. */</span></div><div class="line">    TextView mCallbackText;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Command to the service to register a client, receiving callbacks</div><div class="line">     * from the service.  The Message's replyTo field must be a Messenger of</div><div class="line">     * the client where callbacks should be sent.</div><div class="line">     */</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_REGISTER_CLIENT = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Command to the service to unregister a client, ot stop receiving callbacks</div><div class="line">     * from the service.  The Message's replyTo field must be a Messenger of</div><div class="line">     * the client as previously given with MSG_REGISTER_CLIENT.</div><div class="line">     */</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_UNREGISTER_CLIENT = <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Command to service to set a new value.  This can be sent to the</div><div class="line">     * service to supply a new value, and will be sent by the service to</div><div class="line">     * any registered clients with the new value.</div><div class="line">     */</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SET_VALUE = <span class="number">3</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Handler of incoming messages from service.</div><div class="line">     */</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">IncomingHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">                <span class="keyword">case</span> MessageServiceActivity.MSG_SET_VALUE:</div><div class="line">                    mCallbackText.setText(<span class="string">"Received from service: "</span> + msg.arg1);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">super</span>.handleMessage(msg);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Target we publish for clients to send messages to IncomingHandler.</div><div class="line">     */</div><div class="line">    <span class="keyword">final</span> Messenger mMessenger = <span class="keyword">new</span> Messenger(<span class="keyword">new</span> IncomingHandler());</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ServiceConnection mConnection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName componentName, IBinder iBinder)</span> </span>&#123;</div><div class="line">            <span class="comment">// This is called when the connection with the service has been</span></div><div class="line">            <span class="comment">// established, giving us the service object we can use to</span></div><div class="line">            <span class="comment">// interact with the service.  We are communicating with our</span></div><div class="line">            <span class="comment">// service through an IDL interface, so get a client-side</span></div><div class="line">            <span class="comment">// representation of that from the raw service object.</span></div><div class="line">            mService = <span class="keyword">new</span> Messenger(iBinder);</div><div class="line">            mCallbackText.setText(<span class="string">"Attached."</span>);</div><div class="line"></div><div class="line">            Message msg = Message.obtain(<span class="keyword">null</span>, MSG_REGISTER_CLIENT);</div><div class="line">            msg.replyTo = mMessenger;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                mService.send(msg);</div><div class="line">                msg = Message.obtain(<span class="keyword">null</span>, MSG_SET_VALUE, <span class="keyword">this</span>.hashCode(), <span class="number">0</span>);</div><div class="line">                mService.send(msg);</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                <span class="comment">// In this case the service has crashed before we could even</span></div><div class="line">                <span class="comment">// do anything with it; we can count on soon being</span></div><div class="line">                <span class="comment">// disconnected (and then reconnected if it can be restarted)</span></div><div class="line">                <span class="comment">// so there is no need to do anything here.</span></div><div class="line">            &#125;</div><div class="line">            <span class="comment">// As part of the sample, tell the user what happened.</span></div><div class="line">            Toast.makeText(MessageServiceActivity.<span class="keyword">this</span>, R.string.remote_service_connected,</div><div class="line">                    Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName componentName)</span> </span>&#123;</div><div class="line">            <span class="comment">// This is called when the connection with the service has been</span></div><div class="line">            <span class="comment">// unexpectedly disconnected -- that is, its process crashed.</span></div><div class="line">            mService = <span class="keyword">null</span>;</div><div class="line">            mCallbackText.setText(<span class="string">"Disconnected."</span>);</div><div class="line"></div><div class="line">            <span class="comment">// As part of the sample, tell the user what happened.</span></div><div class="line">            Toast.makeText(MessageServiceActivity.<span class="keyword">this</span>, R.string.remote_service_disconnected,</div><div class="line">                    Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_message_service);</div><div class="line">        <span class="comment">// Watch for button clicks.</span></div><div class="line">        Button button = (Button)findViewById(R.id.bind);</div><div class="line">        button.setOnClickListener(mBindListener);</div><div class="line">        button = (Button)findViewById(R.id.unbind);</div><div class="line">        button.setOnClickListener(mUnbindListener);</div><div class="line"></div><div class="line">        mCallbackText = (TextView)findViewById(R.id.callback);</div><div class="line">        mCallbackText.setText(<span class="string">"Not attached."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doBindService</span><span class="params">()</span> </span>&#123;</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(ACTION_BIND_SERVICE);</div><div class="line">        intent.setPackage(<span class="string">"com.xhj.huijian.aidlserver"</span>);</div><div class="line">        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</div><div class="line">        bindService(intent, mConnection, Context.BIND_AUTO_CREATE);</div><div class="line">        mIsBound = <span class="keyword">true</span>;</div><div class="line">        mCallbackText.setText(<span class="string">"Binding."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doUnbindService</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mIsBound) &#123;</div><div class="line">            <span class="comment">// If we have received the service, and hence registered with</span></div><div class="line">            <span class="comment">// it, then now is the time to unregister.</span></div><div class="line">            <span class="keyword">if</span> (mService != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Message msg = Message.obtain(<span class="keyword">null</span>, MSG_UNREGISTER_CLIENT);</div><div class="line">                    msg.replyTo = mMessenger;</div><div class="line">                    mService.send(msg);</div><div class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                    <span class="comment">// There is nothing special we need to do if the service</span></div><div class="line">                    <span class="comment">// has crashed.</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Detach our existing connection.</span></div><div class="line">            unbindService(mConnection);</div><div class="line">            mIsBound = <span class="keyword">false</span>;</div><div class="line">            mCallbackText.setText(<span class="string">"Unbinding."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> View.OnClickListener mBindListener = <span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">            doBindService();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> View.OnClickListener mUnbindListener = <span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">            doUnbindService();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码我就不再解释了，我贴下运行效果截图，</p>
<p><img src="https://gw.alicdn.com/tps/TB1QwznLXXXXXXRaXXXXXXXXXXX-998-378.png" alt=""></p>
<p>已经收到来自 service 的消息啦，哈哈，从日志也可以看出我们已经成功访问了，</p>
<p><img src="https://gw.alicdn.com/tps/TB1_nDALXXXXXXYXFXXXXXXXXXX-1594-110.png" alt=""></p>
<h4 id="IntentService"><a href="#IntentService" class="headerlink" title="IntentService"></a>IntentService</h4><p>刚开始学习 Android 开发时，常听人这么说，为了避免在 UI 线程上做耗时的操作所带来的 ANR(Application Not Responding)，可以把耗时的任务都放在 service 里去。其实这句话是不对的，在 service 里做耗时的操作同样也会带来 ANR。所以，你应该在 service 里开启子线程来执行耗时的任务。事实上，你不用自己那么麻烦地去创建一个 service，然后还要去管理 Service 的生命周期以及子线程。Android SDK 给你提供了一个叫 <strong>IntentService</strong> 的服务，它是 service 的子类，使用工作线程逐一处理所有启动请求。如果您不要求服务同时处理多个请求，这是最好的选择。 您只需实现 <code>onHandleIntent()</code> 方法即可，该方法会接收每个启动请求的 Intent，使你能够执行后台工作。</p>
<p>在 IntentService 内维护着一个工作线程来处理耗时操作，启动 IntentService 的方式和启动传统 Service 一样，同时，当任务执行完后，IntentService 会自动停止，而不需要我们去手动控制。另外， IntentService 可以启动多次，而每一个耗时操作会以工作队列的方式在IntentService 的 onHandleIntent 回调方法中执行，并且，每次只会执行一个工作线程，执行完第一个再执行第二个，以此类推。</p>
<p>而且，所有请求都在一个单线程中，不会阻塞应用程序的主线程（UI 线程），同一时间只处理一个请求。</p>
<p>综述，使用 IntentService 至少会给我们带来两个好处，一方面不需要自己去创建和管理子线程了；另一方面不需要考虑在什么时候关闭 Service 了。</p>
<p>下面，我们通过一个例子来学习 IntentService 的使用。IntentService 是一个抽象类，我们需要去实现它的 onHandleIntent 方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UploadService</span> <span class="keyword">extends</span> <span class="title">IntentService</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"UploadService"</span>;</div><div class="line">    <span class="comment">// IntentService can perform, e.g. ACTION_FETCH_NEW_ITEMS</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_UPLOAD = <span class="string">"com.xhj.huijian.servicedemo.service.action.UPLOAD"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXTRA_IMG_PATH = <span class="string">"com.xhj.huijian.servicedemo.service.extra.IMG_PATH"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UploadService</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(<span class="string">"UploadService"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onHandleIntent</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">final</span> String action = intent.getAction();</div><div class="line">            <span class="keyword">if</span> (ACTION_UPLOAD.equals(action)) &#123;</div><div class="line">                <span class="keyword">final</span> String path = intent.getStringExtra(EXTRA_IMG_PATH);</div><div class="line">                handleUploadImg(path);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleUploadImg</span><span class="params">(String path)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//模拟上传耗时</span></div><div class="line">            Thread.sleep(<span class="number">2000</span>);</div><div class="line"></div><div class="line">            Intent intent = <span class="keyword">new</span> Intent(MainActivity.UPLOAD_RESULT);</div><div class="line">            intent.putExtra(EXTRA_IMG_PATH, path);</div><div class="line">            sendBroadcast(intent);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        Log.d(TAG, <span class="string">"onCreate"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        Log.d(TAG, <span class="string">"onDestroy"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>UploadService 是一个模拟上传图片的服务，代码很简单，不做过多的解释啦，看下 MainActivity 的代码，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">private</span> BroadcastReceiver uploadImgReceiver = <span class="keyword">new</span> BroadcastReceiver() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (intent.getAction().equals(UPLOAD_RESULT)) &#123;</div><div class="line">                String path = intent.getStringExtra(UploadService.EXTRA_IMG_PATH);</div><div class="line">                uploadResult(path);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">uploadResult</span><span class="params">(String path)</span> </span>&#123;</div><div class="line">        TextView tv = (TextView) mContainer.findViewWithTag(path);</div><div class="line">        tv.setText(path + <span class="string">" upload complete "</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>广播用来监听服务发送的消息，收到消息后修改页面上的控件内容，同步上传状态。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startIntentService</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        String path = <span class="string">"/sdcard/images/"</span> + (++img) + <span class="string">".jpg"</span>;</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, UploadService.class);</div><div class="line">        intent.setAction(UploadService.ACTION_UPLOAD);</div><div class="line">        intent.putExtra(UploadService.EXTRA_IMG_PATH, path);</div><div class="line">        startService(intent);</div><div class="line"></div><div class="line">        TextView tv = <span class="keyword">new</span> TextView(<span class="keyword">this</span>);</div><div class="line">        mContainer.addView(tv);</div><div class="line">        tv.setText(path + <span class="string">" is uploading ..."</span>);</div><div class="line">        tv.setTag(path);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>上面是启动一个服务区下载图片，同时在页面上添加一个 TextView 用于显示上传状态。下面代码展示了广播的注册和注销，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        mContainer = (LinearLayout) findViewById(R.id.container);</div><div class="line">        <span class="comment">// 注册广播</span></div><div class="line">        IntentFilter filter = <span class="keyword">new</span> IntentFilter();</div><div class="line">        filter.addAction(UPLOAD_RESULT);</div><div class="line">        registerReceiver(uploadImgReceiver, filter);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">super</span>.onDestroy();</div><div class="line">       ...</div><div class="line">       <span class="comment">// 注销广播</span></div><div class="line">       unregisterReceiver(uploadImgReceiver);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>OK, Run 一下 demo，看下效果图：</p>
<p><img src="https://gw.alicdn.com/tps/TB1ZoYLLXXXXXcZXpXXXXXXXXXX-497-746.gif" alt=""></p>
<h4 id="扩展-Service-类"><a href="#扩展-Service-类" class="headerlink" title="扩展 Service 类"></a>扩展 Service 类</h4><p>上面所述，使用 IntentService 简化了启动服务的实现。但是，若要求服务执行多线程（而不是通过工作队列处理启动请求），则可扩展 service 类来处理每个 Intent。</p>
<p>下面我们创建一个并发处理多线程的 service，我们将其命名为 MultiThreadingService 吧，具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiThreadingService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Looper mServiceLooper;</div><div class="line">    <span class="keyword">private</span> ServiceHandler mServiceHandler;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_MULTI_UPLOAD = <span class="string">"com.xhj.huijian.servicedemo.service.action.MULTI_UPLOAD"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXTRA_IMG_PATH = <span class="string">"com.xhj.huijian.servicedemo.service.extra.IMG_PATH"</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Handler that receives messages from the thread</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ServiceHandler</span><span class="params">(Looper looper)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(looper);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">//模拟上传耗时</span></div><div class="line">                Thread.sleep(((<span class="keyword">int</span>)(<span class="number">1</span> + Math.random() * <span class="number">3</span>)) * <span class="number">1000</span>);</div><div class="line"></div><div class="line">                Intent intent = <span class="keyword">new</span> Intent(MainActivity.UPLOAD_RESULT);</div><div class="line">                intent.putExtra(EXTRA_IMG_PATH, (String) msg.obj);</div><div class="line">                sendBroadcast(intent);</div><div class="line">                stopSelf(msg.arg1);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MultiThreadingService</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// Start up the thread running the service.  Note that we create a</span></div><div class="line">        <span class="comment">// separate thread because the service normally runs in the process's</span></div><div class="line">        <span class="comment">// main thread, which we don't want to block.  We also make it</span></div><div class="line">        <span class="comment">// background priority so CPU-intensive work will not disrupt our UI.</span></div><div class="line">        HandlerThread thread = <span class="keyword">new</span> HandlerThread(<span class="string">"ServiceStartArguments"</span>,</div><div class="line">                Process.THREAD_PRIORITY_BACKGROUND);</div><div class="line">        thread.start();</div><div class="line"></div><div class="line">        <span class="comment">// Get the HandlerThread's Looper and use it for our Handler</span></div><div class="line">        mServiceLooper = thread.getLooper();</div><div class="line">        mServiceHandler = <span class="keyword">new</span> ServiceHandler(mServiceLooper);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">final</span> <span class="keyword">int</span> startId)</span> </span>&#123;</div><div class="line">        Toast.makeText(MultiThreadingService.<span class="keyword">this</span>, <span class="string">"多线程服务启动"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">final</span> String action = intent.getAction();</div><div class="line">            <span class="keyword">if</span> (TextUtils.equals(action, ACTION_MULTI_UPLOAD)) &#123;</div><div class="line">                <span class="keyword">final</span> String path = intent.getStringExtra(EXTRA_IMG_PATH);</div><div class="line">                <span class="comment">// 取消下面的注释, 然后注销掉下面的 Thread,该服务的作用就跟 UploadService 一样了</span></div><div class="line"><span class="comment">//                Message msg = mServiceHandler.obtainMessage();</span></div><div class="line"><span class="comment">//                msg.arg1 = startId;</span></div><div class="line"><span class="comment">//                msg.obj = path;</span></div><div class="line"><span class="comment">//                mServiceHandler.sendMessage(msg);</span></div><div class="line"></div><div class="line">                <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            <span class="comment">//模拟上传耗时</span></div><div class="line">                            Thread.sleep(((<span class="keyword">int</span>)(<span class="number">1</span> + Math.random() * <span class="number">3</span>)) * <span class="number">1000</span>);</div><div class="line"></div><div class="line">                            Intent intent = <span class="keyword">new</span> Intent(MainActivity.UPLOAD_RESULT);</div><div class="line">                            intent.putExtra(EXTRA_IMG_PATH, path);</div><div class="line">                            sendBroadcast(intent);</div><div class="line">                            stopSelf(startId);</div><div class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                            e.printStackTrace();</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;).start();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// If we get killed, after returning from here, restart</span></div><div class="line">        <span class="keyword">return</span> START_STICKY;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        Toast.makeText(MultiThreadingService.<span class="keyword">this</span>, <span class="string">"多线程服务结束"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为我们自己处理了 <code>onStartCommand()</code> 的每个调用，因此可以同时执行多个请求。Activity 的代码我就不贴出来了，大家看下 demo 吧，运行上面的代码，随便点击几下 “MultiService” 按钮，就可以看到下图的效果了，</p>
<p><img src="https://gw.alicdn.com/tps/TB1J9.XLXXXXXcYaXXXXXXXXXXX-497-746.gif" alt=""></p>
<p>可以看出已经是并发线程下载了。</p>
<h4 id="前台服务"><a href="#前台服务" class="headerlink" title="前台服务"></a>前台服务</h4><p>前台服务被认为是用户主动意识到的一种服务，因此在内存不足时，系统也不会考虑将其终止。前台服务必须为状态栏提供通知，状态栏位于“正在进行”标题下方，这意味着除非服务停止或从前台删除，否则不能清除通知。这个例子最好举了，当你打开音乐播放器时，你的手机状态栏上面是有一个通知，并且你手动去滑动是滑不掉的。</p>
<p>要请求让服务运行于前台，请调用 <code>startForeground()</code>。此方法取两个参数：唯一标识通知的整型数和状态栏的 <code>Notification</code>。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Notification notification = <span class="keyword">new</span> Notification(R.drawable.icon, getText(R.string.ticker_text),</div><div class="line">        System.currentTimeMillis());</div><div class="line">Intent notificationIntent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, ExampleActivity.class);</div><div class="line">PendingIntent pendingIntent = PendingIntent.getActivity(<span class="keyword">this</span>, <span class="number">0</span>, notificationIntent, <span class="number">0</span>);</div><div class="line">notification.setLatestEventInfo(<span class="keyword">this</span>, getText(R.string.notification_title),</div><div class="line">        getText(R.string.notification_message), pendingIntent);</div><div class="line">startForeground(ONGOING_NOTIFICATION_ID, notification);<span class="comment">// 提供给 startForeground() 的整型 ID 不得为 0</span></div></pre></td></tr></table></figure>
<p>要从前台删除服务，请调用 <code>stopForeground()</code>。此方法取一个布尔值，指示是否也删除状态栏通知。 此方法绝对不会停止服务。 但是，如果您在服务正在前台运行时将其停止，则通知也会被删除。</p>
<h4 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h4><p>写这篇文章的原因，一是作为自己对 service 组件的理解和应用做一次较全面的总结，二是帮助 Android 新人对 service 组件的学习有一个比较深刻的了解，三是方便自己遗忘，可以回头来查阅。上面较多的例子来自 Google 官方文档，所以你也能看到很多的英文注释，原本想把英文注释去掉，太占篇幅了，但后面发现，很多的英文注释可以帮助你理解代码为什么要这么写，因为注释很容易看，所以也不句句翻译了。当然，我也阅读了很多国内其他博主写的很好的博文，借鉴了他们的一些例子，之所以这么做，是怕自己个人的理解有些偏差，自己举例的代码不够好，误导大家。篇幅这么长，肯定有疏漏的地方，还请各位指出。</p>
<p><a href="http://download.csdn.net/detail/g96968586/9596505" target="_blank" rel="external">附件 demo</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Android/">Android</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Android-音频技术开发总结" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/09/15/Android-音频技术开发总结/" class="article-date">
  	<time datetime="2016-09-14T17:11:06.000Z" itemprop="datePublished">2016-09-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/15/Android-音频技术开发总结/">Android 音频技术开发总结</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>摘要： 在文章开头，我们先来了解几个概念，这样有利于对后面内容的理解。 1、概念理解 采样率：即采样频率，百科的解释是，每秒从连续信号中提取并组成离散信号的采样个数，单位 赫兹（Hz）。通俗的讲采样频率是指计算机每秒钟采集多少个声音样本，是描述声音文件的音质、音调，衡量声卡、声音文件的质量标准。好吧，感觉…</p>
</blockquote>
<p>在文章开头，我们先来了解几个概念，这样有利于对后面内容的理解。</p>
<h4 id="1、概念理解"><a href="#1、概念理解" class="headerlink" title="1、概念理解"></a>1、概念理解</h4><p><strong>采样率</strong>：即采样频率，百科的解释是，每秒从<a href="http://baike.baidu.com/view/1910376.htm" target="_blank" rel="external">连续信号</a>中提取并组成离散信号的采样个数，单位 <a href="http://baike.baidu.com/subview/19996/7461726.htm" target="_blank" rel="external">赫兹</a>（Hz）。通俗的讲采样频率是指计算机每秒钟采集多少个声音样本，是描述声音文件的音质、音调，衡量声卡、声音文件的质量标准。好吧，感觉这样还是不太理解，那我们来看看下面的解释：</p>
<p>如图，</p>
<p><img src="http://s4.51cto.com/wyfs02/M02/7C/F6/wKioL1bdXQviw_TBAAAVYm_x3gk862.gif" alt=""></p>
<p>采样就是把模拟信号数字化的过程，不仅仅是音频需要采样，所有的模拟信号都需要通过采样转换为可以用 0101 来表示的数字信号，上图蓝色代表模拟音频信号，而红色的点代表采样得到的量化数值。红色点之间的间隔越小，表示采样频率越高，同时音频质量也就越高。</p>
<p><strong>通道数</strong>：一般表示声音录制时的音源数量或回放时相应的扬声器数量。单声道（Mono）和双声道（Stereo）比较常见。</p>
<p><strong>量化精度（位宽）</strong>：上图中的每一个红色点，都有一个数值来表示其大小，这个数值的数据类型有：4bit、8bit、16bit、32bit等，位数越多，表示得就越精细，声音质量也就越好。</p>
<p><strong>音频帧（frame）</strong>：音频数据是流式的，本身并没有明确的一帧帧的概念，在实际的应用中，为了音频算法处理/传输的方便，一般约定俗成取 2.5 ms ~ 60 ms为单位的数据量为一帧音频。 这个时间被称之为“采样时间”，其长度没有特别的标准。我们可以计算一下一帧音频帧的大小：</p>
<p>假设某通道的音频信号是采样率为 8 kHz，位宽为16 bit，20 ms 一帧，双通道，则一帧音频数据的大小为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int size = 8000 x 16bit x 0.02s  x 2 = 5120 bit = 640 byte</div></pre></td></tr></table></figure>
<p><strong>音频编码</strong>：模拟的音频信号转换为数字信号需要经过采样和量化，量化的过程被称之为编码。根据不同的量化策略，产生了许多不同的编码方式。</p>
<h4 id="2、音频采集"><a href="#2、音频采集" class="headerlink" title="2、音频采集"></a>2、音频采集</h4><p>在 Android 开发中，官方 SDK 提供了两套音频录制的 API，一个是 MediaRecorder ，另一个是 AudioRecord。前者会对录入的音频数据进行编码压缩(如 AMR，3GP等)，  而后者是更加偏向底层的 API，录入的是一帧帧 的 PCM 音频数据，是无损没有经过压缩的。如果你对音频格式没有特殊的要求，只是简单的想做一个录音功能，那推荐你使用 MediaRecorder 。MediaRecorder 支持的输出方式有：amr_nb，amr_wb, default, mpeg_4, raw_amr, three_gpp。如果需要对音频数据进行额外的算法处理，则建议使用更加灵活的 AudioRecord API。比如，我想要录制一个 MP3 格式的音频文件， Android SDK 本身是不支持直接录制 MP3 格式的文件，我们就可以通过 AudioRecord 来采集音频数据，并通过第三方库来进行编码。下面我将会介绍怎么在 Android 上使用 AudioRecord 录制 MP3 和 WAV 格式的音频文件。</p>
<h5 id="2-1-MP3-音频录制"><a href="#2-1-MP3-音频录制" class="headerlink" title="2.1 MP3 音频录制"></a>2.1 MP3 音频录制</h5><p>LAME 是目前最出色的 MP3 编码引擎。我们要在 Android 平台上使用它，需要下载 <a href="http://lame.sourceforge.net/links.php" target="_blank" rel="external">lame</a> 源码并将其编译成 so 库，然后通过 jni 来调用。这里有一个开源项目 <a href="https://github.com/GavinCT/AndroidMP3Recorder" target="_blank" rel="external">AndroidMP3Recorder</a> 帮我们省去了这一步骤，而且这个库封装了底层的 MP3 编码，我们直接拿过来使用就可以了。作者具体的实现思路，可以参考这里 <a href="http://www.cnblogs.com/ct2011/p/4080193.html" target="_blank" rel="external">实现思路讲解</a>。</p>
<p>我简要说下怎么引入这个库和使用，以及本人踩过的坑。</p>
<p>在 Android studio 上集成这个库:</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> dependencies &#123;</div><div class="line">    compile &apos;com.czt.mp3recorder:library:1.0.2&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>另外，因为上面的集成会自动引入多种 so 库，如果只需要其中的几种，可以在gradle中添加下面的配置（比如）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">productFlavors &#123;</div><div class="line">  arm &#123;</div><div class="line">    ndk &#123;</div><div class="line">      abiFilters &quot;armeabi-v7a&quot;, &quot;armeabi&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  x86 &#123;</div><div class="line">    ndk &#123;</div><div class="line">      abiFilter &quot;x86&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样在编译时就只会在 arm 中接入 armeabi-v7a armeabi 包，在 x86 上接入 x86 的包，而不会接入其他的包。最后还需要在 gradle.properties 中添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">android.useDeprecatedNdk = true</div></pre></td></tr></table></figure>
<p>这样就可以正常使用了。如果不过滤不需要的 so 库，在编译时就会报这个错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java.lang.UnsatisfiedLinkError</div></pre></td></tr></table></figure>
<p>举个例子，使用无线保镖 SDK 时，我们会接入 armeabi-v7a 和 x86 这两个包的 so 文件，但由于我们使用了 AndroidMP3Recorder 这个库，它会产生额外的诸如 armeabi、armeabi-v8a、mips等多个文件夹，这些文件夹里面都有 liblame.so 文件，但没有无线保镖的 so 文件，这样就会引发java.lang.UnsatisfiedLinkError 错误，导致编译不通过。</p>
<p>OK，剩下的就是开始使用这个库了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">// 创建 MP3Recorder 实例， 传入录音文件的保存路径和文件名</div><div class="line">MP3Recorder mRecorder = new MP3Recorder(new File(Environment.getExternalStorageDirectory(), &quot;demo.mp3&quot;));</div><div class="line"></div><div class="line">// 开始录音</div><div class="line">mRecorder.start();</div><div class="line"></div><div class="line">// 停止录音</div><div class="line">mRecorder.stop();</div></pre></td></tr></table></figure>
<p>是不是很简单，转码的事情通通不用操心，全帮你做了。</p>
<p>踩到的坑：</p>
<p>后面我发现在小米4、锤子 T2 等手机上打开接入了这个库的 app 直接闪退了。经过分析发现，在小米 4、锤子 T2 等手机上运行我们的 app ，系统会先去找 arm64-v8a 这个目录下的 so 文件，如果不存在还好，偏偏我的 app 存在 arm64-v8a 目录，此时因为找不到目录下无线保镖的 so 文件（前面说过，接入了无线保镖只会引入  armeabi-v7a 和 x86 这两个包的 so 文件），就直接报 java.lang.UnsatisfiedLinkError：couldn’t find “libsecuritysdk.so” 的错了。</p>
<p>这时候我就纳闷了，前面配置时我的确只保留了 armeabi-v7a 和 x86 这两个目录下的 so 文件，去掉了不需要的 so ，但为什么还会出现其他的 so 目录呢？后面发现，在打包 apk 时，这些 so 库还是会一并被打包进 apk ！而在测试时，刚好使用的 MX3 手机加载 so 文件正常，所以没发现这个问题。这时候你也许会问，为什么小米4、锤子 T2 等手机会先去找 arm64-v8a 这个目录呢？因为它们是 64 位设备呀，而 armeabi-v7a 和 x86 针对的都是 32 位的文件。综上所述，问题可以描述为怎么在 64 位的设备上运行 32 位的二进制文件，这里指 so 文件。</p>
<p>在 stackoverflow 上找到了解决的答案：</p>
<p>When you install an APK on Android, the system will look for native libraries directories (armeabi, armeabi-v7a, arm64-v8a, x86, x86_64, mips64, mips) inside the lib folder of the APK, in the order determined by Build.SUPPORTED_ABIS.</p>
<p>If your app happen to have an arm64-v8a directory with missing libs, the missing libs will not be installed from another directory, the libs aren’t mixed. That means you have to provide the full set of your libraries for each architecture.</p>
<p>So, to solve your issue, you can remove your 64-bit libs from your build, or set abiFilters to package only 32-bit architectures:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    ....</div><div class="line">    defaultConfig &#123;</div><div class="line">        ....</div><div class="line">        ndk &#123;</div><div class="line">            abiFilters &quot;x86&quot;, &quot;armeabi-v7a&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果照上面的配置，那打包时就只会把 “x86”, “armeabi-v7a” 这两个目录及其下的 so 文件打包进 apk 。我们的问题也解决了，因为系统也只能找这两个目录下的 so 文件了。</p>
<h5 id="2-2-WAV-音频录制"><a href="#2-2-WAV-音频录制" class="headerlink" title="2.2 WAV 音频录制"></a>2.2 WAV 音频录制</h5><p>因为 wav 是无损格式的音频文件，所以我们使用的还是 AudioRecord 这个 API。但在此之前，我们需要先了解一下怎么存储 wav 格式的文件。</p>
<p>wav 是微软公司开发的一种声音文件格式，整个文件分两部分，第一部分是”文件头”，包括：采样率、通道数、位宽等参数信息，第二部分是”数据块”：指一帧一帧的二进制音频数据。</p>
<p>见下图 wav 格式的文件头：</p>
<p><img src="http://www.liuhaihua.cn/wp-content/uploads/2016/03/b2qAVfa.png" alt=""></p>
<p>它主要分为三个部分：</p>
<p>第一部分，The “RIFF” chunk descriptor，通过 “ChunkID” 来表示这是一个 “RIFF” 格式的文件，通过 “Format” 填入 “WAVE” 来标识这是一个 wav 文件。而 “ChunkSize” 则记录了整个 wav 文件的字节数。</p>
<p>第二部分，The “fmt” sub-chunk，从图中可以看出记录了 wav 音频文件的详细音频参数信息，例如：通道数、采样率、位宽、编码方式、数据块对齐信息等等。</p>
<p>第三部分，The “data” sub-chunk，这部分是真正保存 wav 数据的地方，由“Subchunk2Size”这个字段来记录后面存储的二进制原始音频数据的长度。</p>
<p>OK，我们来看下 Java 代码是怎么实现往一个文件写入 wav “文件头”的。结合上图，你理解起来就不会很困难了。</p>
<p>关键代码来自 <a href="https://github.com/mobro/android/blob/master/src/com/testo/audio/ExtAudioRecorder.java" target="_blank" rel="external">ExtAudioRecorder</a>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">RandomAccessFile randomAccessWriter = null;</div><div class="line">...</div><div class="line"></div><div class="line">randomAccessWriter = new RandomAccessFile(filePath, &quot;rw&quot;);</div><div class="line"></div><div class="line">randomAccessWriter.setLength(0); // Set file length to 0, to prevent unexpected behavior in case the file already existed</div><div class="line">randomAccessWriter.writeBytes(&quot;RIFF&quot;);</div><div class="line">randomAccessWriter.writeInt(0); // Final file size not known yet, write 0</div><div class="line">randomAccessWriter.writeBytes(&quot;WAVE&quot;);</div><div class="line">randomAccessWriter.writeBytes(&quot;fmt &quot;);</div><div class="line">randomAccessWriter.writeInt(Integer.reverseBytes(16)); // Sub-chunk size, 16 for PCM</div><div class="line">randomAccessWriter.writeShort(Short.reverseBytes((short) 1)); // AudioFormat, 1 for PCM</div><div class="line">randomAccessWriter.writeShort(Short.reverseBytes(nChannels));// Number of channels, 1 for mono, 2 for stereo</div><div class="line">randomAccessWriter.writeInt(Integer.reverseBytes(sRate)); // Sample rate</div><div class="line">randomAccessWriter.writeInt(Integer.reverseBytes(sRate*bSamples*nChannels/8)); // Byte rate, SampleRate*NumberOfChannels*BitsPerSample/8</div><div class="line">randomAccessWriter.writeShort(Short.reverseBytes((short)(nChannels*bSamples/8))); // Block align, NumberOfChannels*BitsPerSample/8</div><div class="line">randomAccessWriter.writeShort(Short.reverseBytes(bSamples)); // Bits per sample</div><div class="line">randomAccessWriter.writeBytes(&quot;data&quot;);</div><div class="line">randomAccessWriter.writeInt(0); // Data chunk size not known yet, write 0</div></pre></td></tr></table></figure>
<p>filePath 是音频文件绝对路径，注意此时的录音还未开始，这里的思路是在准备阶段，先创建一个带有 wave 头部信息的文件，然后在录音进行时再不断从缓冲区取出音频数据写入到这个文件中，所以这里的 ChunkSize 一开始就设置为 0。</p>
<p>另外，再给一个 samsung 的实现思路，它是读取录制完后的音频文件再往文件头写入 wave 的头部信息，本质上是一样的，但相对好理解些。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">private void rawToWave(final File rawFile, final File waveFile) throws IOException &#123;</div><div class="line"></div><div class="line">        byte[] rawData = new byte[(int) rawFile.length()];</div><div class="line">        DataInputStream input = null;</div><div class="line">        try &#123;</div><div class="line">            input = new DataInputStream(new FileInputStream(rawFile));</div><div class="line">            input.read(rawData);</div><div class="line">        &#125; finally &#123;</div><div class="line">            if (input != null) &#123;</div><div class="line">                input.close();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        DataOutputStream output = null;</div><div class="line">        try &#123;</div><div class="line">            output = new DataOutputStream(new FileOutputStream(waveFile));</div><div class="line">            // WAVE header</div><div class="line">            // see http://ccrma.stanford.edu/courses/422/projects/WaveFormat/</div><div class="line">            writeString(output, &quot;RIFF&quot;); // chunk id</div><div class="line">            writeInt(output, 36 + rawData.length); // chunk size</div><div class="line">            writeString(output, &quot;WAVE&quot;); // format</div><div class="line">            writeString(output, &quot;fmt &quot;); // subchunk 1 id</div><div class="line">            writeInt(output, 16); // subchunk 1 size</div><div class="line">            writeShort(output, (short) 1); // audio format (1 = PCM)</div><div class="line">            writeShort(output, (short) 1); // number of channels</div><div class="line">            writeInt(output, SAMPLE_RATE); // sample rate</div><div class="line">            writeInt(output, SAMPLE_RATE * 2); // byte rate</div><div class="line">            writeShort(output, (short) 2); // block align</div><div class="line">            writeShort(output, (short) 16); // bits per sample</div><div class="line">            writeString(output, &quot;data&quot;); // subchunk 2 id</div><div class="line">            writeInt(output, rawData.length); // subchunk 2 size</div><div class="line">            // Audio data (conversion big endian -&gt; little endian)</div><div class="line">            short[] shorts = new short[rawData.length / 2];</div><div class="line">            ByteBuffer.wrap(rawData).order(ByteOrder.LITTLE_ENDIAN).asShortBuffer().get(shorts);</div><div class="line">            ByteBuffer bytes = ByteBuffer.allocate(shorts.length * 2);</div><div class="line">            for (short s : shorts) &#123;</div><div class="line">                bytes.putShort(s);</div><div class="line">            &#125;</div><div class="line">            output.write(bytes.array());</div><div class="line">        &#125; finally &#123;</div><div class="line">            if (output != null) &#123;</div><div class="line">                output.close();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h4 id="3-麦克风音量获取"><a href="#3-麦克风音量获取" class="headerlink" title="3.麦克风音量获取"></a>3.麦克风音量获取</h4><h5 id="3-1-基础知识"><a href="#3-1-基础知识" class="headerlink" title="3.1 基础知识"></a>3.1 基础知识</h5><p>度量声音强度的单位，大家最熟悉的就是分贝。计算公式如下：</p>
<p><img src="http://upload.wikimedia.org/math/8/e/a/8eae7519d0c9f264e89ececeaaeb1d05.png" alt=""></p>
<p>分子是测量值的声压，分母是参考值的声压（20微帕，人类所能听到的最小声压）。<br>在 Android 设备上传感器可以提供的物理量是场的幅值（amplitude），常用下列公式计算分贝值：</p>
<p><img src="http://upload.wikimedia.org/math/9/0/2/9023cb5d56a945e9332196fabacb463a.png" alt=""></p>
<p>从SDK中读取了某段音频数据的振幅后，取最大振幅或平均振幅（可以用平方和平均，或绝对值的和平均），代入上述公式的A1。这里的 A0 取值似情况而定，这里不做讨论。</p>
<p>MediaRecorder 有一个无参方法 getMaxAmplitude 即可获得一小段时间内音源数据中的最大振幅。而 AudioRecord 没有提供类似的方法，但是我们可以获得具体的音源数据值来进行换算。调用 AudioRecord 的 read(byte[] audioData, int offsetInBytes, int sizeInBytes) 方法从缓冲区读取到我们传入的字节数组buffer 后，便可以对其进行操作，如求平方和或绝对值的平均值。这样可以避免个别极端值的影响，使计算的结果更加稳定。求得平均值之后，如果是平方和则代入常数系数为 10 的公式中，如果是绝对值的则代入常数系数为 20 的公式中，算出分贝值。</p>
<p>我们先来获取振幅，关键代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">AudioRecord audioRecorder;</div><div class="line">byte[] buffer;</div><div class="line">int bufferSize;</div><div class="line">// 振幅</div><div class="line">int mAmplitude= 0;</div><div class="line">// Number of frames written to file on each output(only in uncompressed mode)</div><div class="line">private int framePeriod;</div><div class="line">...</div><div class="line">// 初始化,sampleRate 是采样率，这里我设置的是 44100 Hz，Google Android 文档明确表明只有以下3个参数是可以在所有设备上保证支持的，44100 Hz，AudioFormat.CHANNEL_IN_MONO(单声道)，AudioFormat.ENCODING_PCM_16BIT(位宽)</div><div class="line"></div><div class="line">bufferSize = AudioRecord.getMinBufferSize(sampleRate, AudioFormat.CHANNEL_IN_MONO, AudioFormat.ENCODING_PCM_16BIT);</div><div class="line"></div><div class="line">// MediaRecorder.AudioSource.MIC,音频采集的输入源</div><div class="line">audioRecorder = new AudioRecord(MediaRecorder.AudioSource.MIC, sampleRate, AudioFormat.CHANNEL_IN_MONO, AudioFormat.ENCODING_PCM_16BIT, bufferSize);</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">buffer = new byte[framePeriod*bSamples/8*nChannels];</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">// 开始录音</div><div class="line">audioRecorder.start();</div><div class="line">// 读取缓冲区音频数据</div><div class="line">audioRecorder.read(buffer, 0, buffer.length); // Fill buffer</div><div class="line">            try</div><div class="line">            &#123;</div><div class="line">                randomAccessWriter.write(buffer); // Write buffer to file</div><div class="line">                payloadSize += buffer.length;</div><div class="line">                    for (int i=0; i&lt;buffer.length/2; i++)</div><div class="line">                    &#123; // 16bit sample size</div><div class="line">                        short curSample = getShort(buffer[i*2], buffer[i*2+1]);</div><div class="line">                        if (curSample &gt; mAmplitude)</div><div class="line">                        &#123; // Check amplitude</div><div class="line">                            mAmplitude = curSample;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">              &#125;</div><div class="line">            catch (IOException e)</div><div class="line">            &#123;</div><div class="line"></div><div class="line">            &#125;</div></pre></td></tr></table></figure>
<p>上面的 mAmplitude 就是振幅了。现在我们需要换算成分贝，直接代入公式，只需简单的这么一句代码就行了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int mVolume = (int)(10 * Math.log10(amplitude));</div></pre></td></tr></table></figure>
<p>上面的 mAmplitude 时刻都在变化的，除非录音结束。所以，我们可以通过 mAmplitude 来实现诸如绘制声音频率图、声波图等效果。</p>
<h5 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h5><ul>
<li><a href="http://blog.csdn.net/bluesoal/article/details/932395" target="_blank" rel="external">《wav文件格式分析详解》</a></li>
</ul>
<ul>
<li><a href="http://ju.outofmemory.cn/entry/247659" target="_blank" rel="external">《如何存储和解析wav文件》</a></li>
</ul>
<ul>
<li><a href="http://ticktick.blog.51cto.com/823160/1748506" target="_blank" rel="external">《Android 音频开发基础知识》</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Android/">Android</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Android-内存泄漏总结" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/09/14/Android-内存泄漏总结/" class="article-date">
  	<time datetime="2016-09-14T05:13:19.000Z" itemprop="datePublished">2016-09-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/14/Android-内存泄漏总结/">Android 内存泄漏总结</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>内存管理的目的就是让我们在开发中怎么有效的避免我们的应用出现内存泄漏的问题。内存泄漏大家都不陌生了，简单粗俗的讲，就是该被释放的对象没有释放，一直被某个或某些实例所持有却不再被使用导致 GC 不能回收。最近自己阅读了大量相关的文档资料，打算做个 <strong>总结</strong> 沉淀下来跟大家一起分享和学习，也给自己一个警示，以后 coding 时怎么避免这些情况，提高应用的体验和质量。</p>
<p>我会从 java 内存泄漏的基础知识开始，并通过具体例子来说明 Android 引起内存泄漏的各种原因，以及如何利用工具来分析应用内存泄漏，最后再做总结。</p>
<p>篇幅有些长，大家可以分几节来看！</p>
<h3 id="Java-内存分配策略"><a href="#Java-内存分配策略" class="headerlink" title="Java 内存分配策略"></a>Java 内存分配策略</h3><p>Java 程序运行时的内存分配策略有三种,分别是静态分配,栈式分配,和堆式分配，对应的，三种存储策略使用的内存空间主要分别是静态存储区（也称方法区）、栈区和堆区。</p>
<ul>
<li><p>静态存储区（方法区）：主要存放静态数据、全局 static 数据和常量。这块内存在程序编译时就已经分配好，并且在程序整个运行期间都存在。</p>
</li>
<li><p>栈区 ：当方法被执行时，方法体内的局部变量都在栈上创建，并在方法执行结束时这些局部变量所持有的内存将会自动被释放。因为栈内存分配运算内置于处理器的指令集中，效率很高，但是分配的内存容量有限。</p>
</li>
<li><p>堆区 ： 又称动态内存分配，通常就是指在程序运行时直接 new 出来的内存。这部分内存在不使用时将会由 Java 垃圾回收器来负责回收。</p>
</li>
</ul>
<h5 id="栈与堆的区别："><a href="#栈与堆的区别：" class="headerlink" title="栈与堆的区别："></a>栈与堆的区别：</h5><p>在方法体内定义的（局部变量）一些基本类型的变量和对象的引用变量都是在方法的栈内存中分配的。当在一段方法块中定义一个变量时，Java 就会在栈中为该变量分配内存空间，当超过该变量的作用域后，该变量也就无效了，分配给它的内存空间也将被释放掉，该内存空间可以被重新使用。</p>
<p>堆内存用来存放所有由 new 创建的对象（包括该对象其中的所有成员变量）和数组。在堆中分配的内存，将由 Java 垃圾回收器来自动管理。在堆中产生了一个数组或者对象后，还可以在栈中定义一个特殊的变量，这个变量的取值等于数组或者对象在堆内存中的首地址，这个特殊的变量就是我们上面说的引用变量。我们可以通过这个引用变量来访问堆中的对象或者数组。</p>
<p>举个例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public class Sample() &#123;</div><div class="line">	int s1 = 0;</div><div class="line">	Sample mSample1 = new Sample();</div><div class="line"></div><div class="line">	public void method() &#123;</div><div class="line">		int s2 = 1;</div><div class="line">		Sample mSample2 = new Sample();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Sample mSample3 = new Sample();</div></pre></td></tr></table></figure>
<p>Sample 类的局部变量 s2 和引用变量 mSample2 都是存在于栈中，但 mSample2 指向的对象是存在于堆上的。<br>mSample3 指向的对象实体存放在堆上，包括这个对象的所有成员变量 s1 和 mSample1，而它自己存在于栈中。</p>
<p>结论：</p>
<p>局部变量的基本数据类型和引用存储于栈中，引用的对象实体存储于堆中。—— 因为它们属于方法中的变量，生命周期随方法而结束。</p>
<p>成员变量全部存储与堆中（包括基本数据类型，引用和引用的对象实体）—— 因为它们属于类，类对象终究是要被new出来使用的。</p>
<p>了解了 Java 的内存分配之后，我们再来看看 Java 是怎么管理内存的。</p>
<h3 id="Java是如何管理内存"><a href="#Java是如何管理内存" class="headerlink" title="Java是如何管理内存"></a>Java是如何管理内存</h3><p>Java的内存管理就是对象的分配和释放问题。在 Java 中，程序员需要通过关键字 new 为每个对象申请内存空间 (基本类型除外)，所有的对象都在堆 (Heap)中分配空间。另外，对象的释放是由 GC 决定和执行的。在 Java 中，内存的分配是由程序完成的，而内存的释放是由 GC 完成的，这种收支两条线的方法确实简化了程序员的工作。但同时，它也加重了JVM的工作。这也是 Java 程序运行速度较慢的原因之一。因为，GC 为了能够正确释放对象，GC 必须监控每一个对象的运行状态，包括对象的申请、引用、被引用、赋值等，GC 都需要进行监控。</p>
<p>监视对象状态是为了更加准确地、及时地释放对象，而释放对象的根本原则就是该对象不再被引用。</p>
<p>为了更好理解 GC 的工作原理，我们可以将对象考虑为有向图的顶点，将引用关系考虑为图的有向边，有向边从引用者指向被引对象。另外，每个线程对象可以作为一个图的起始顶点，例如大多程序从 main 进程开始执行，那么该图就是以 main 进程顶点开始的一棵根树。在这个有向图中，根顶点可达的对象都是有效对象，GC将不回收这些对象。如果某个对象 (连通子图)与这个根顶点不可达(注意，该图为有向图)，那么我们认为这个(这些)对象不再被引用，可以被 GC 回收。<br>以下，我们举一个例子说明如何用有向图表示内存管理。对于程序的每一个时刻，我们都有一个有向图表示JVM的内存分配情况。以下右图，就是左边程序运行到第6行的示意图。</p>
<p><img src="http://www.ibm.com/developerworks/cn/java/l-JavaMemoryLeak/1.gif" alt=""></p>
<p>Java使用有向图的方式进行内存管理，可以消除引用循环的问题，例如有三个对象，相互引用，只要它们和根进程不可达的，那么GC也是可以回收它们的。这种方式的优点是管理内存的精度很高，但是效率较低。另外一种常用的内存管理技术是使用计数器，例如COM模型采用计数器方式管理构件，它与有向图相比，精度行低(很难处理循环引用的问题)，但执行效率很高。</p>
<h3 id="什么是Java中的内存泄露"><a href="#什么是Java中的内存泄露" class="headerlink" title="什么是Java中的内存泄露"></a>什么是Java中的内存泄露</h3><p>在Java中，内存泄漏就是存在一些被分配的对象，这些对象有下面两个特点，首先，这些对象是可达的，即在有向图中，存在通路可以与其相连；其次，这些对象是无用的，即程序以后不会再使用这些对象。如果对象满足这两个条件，这些对象就可以判定为Java中的内存泄漏，这些对象不会被GC所回收，然而它却占用内存。</p>
<p>在C++中，内存泄漏的范围更大一些。有些对象被分配了内存空间，然后却不可达，由于C++中没有GC，这些内存将永远收不回来。在Java中，这些不可达的对象都由GC负责回收，因此程序员不需要考虑这部分的内存泄露。</p>
<p>通过分析，我们得知，对于C++，程序员需要自己管理边和顶点，而对于Java程序员只需要管理边就可以了(不需要管理顶点的释放)。通过这种方式，Java提高了编程的效率。</p>
<p><img src="http://www.ibm.com/developerworks/cn/java/l-JavaMemoryLeak/2.gif" alt=""></p>
<p>因此，通过以上分析，我们知道在Java中也有内存泄漏，但范围比C++要小一些。因为Java从语言上保证，任何对象都是可达的，所有的不可达对象都由GC管理。</p>
<p>对于程序员来说，GC基本是透明的，不可见的。虽然，我们只有几个函数可以访问GC，例如运行GC的函数System.gc()，但是根据Java语言规范定义， 该函数不保证JVM的垃圾收集器一定会执行。因为，不同的JVM实现者可能使用不同的算法管理GC。通常，GC的线程的优先级别较低。JVM调用GC的策略也有很多种，有的是内存使用到达一定程度时，GC才开始工作，也有定时执行的，有的是平缓执行GC，有的是中断式执行GC。但通常来说，我们不需要关心这些。除非在一些特定的场合，GC的执行影响应用程序的性能，例如对于基于Web的实时系统，如网络游戏等，用户不希望GC突然中断应用程序执行而进行垃圾回收，那么我们需要调整GC的参数，让GC能够通过平缓的方式释放内存，例如将垃圾回收分解为一系列的小步骤执行，Sun提供的HotSpot JVM就支持这一特性。</p>
<p>同样给出一个 Java 内存泄漏的典型例子，</p>
<pre><code>Vector v = new Vector(10);
for (int i = 1; i &lt; 100; i++) {
    Object o = new Object();
    v.add(o);
    o = null;
}
</code></pre><p>在这个例子中，我们循环申请Object对象，并将所申请的对象放入一个 Vector 中，如果我们仅仅释放引用本身，那么 Vector 仍然引用该对象，所以这个对象对 GC 来说是不可回收的。因此，如果对象加入到Vector 后，还必须从 Vector 中删除，最简单的方法就是将 Vector 对象设置为 null。</p>
<h3 id="Android中常见的内存泄漏汇总"><a href="#Android中常见的内存泄漏汇总" class="headerlink" title="Android中常见的内存泄漏汇总"></a>Android中常见的内存泄漏汇总</h3><ul>
<li><p>集合类泄漏</p>
<p>  集合类如果仅仅有添加元素的方法，而没有相应的删除机制，导致内存被占用。如果这个集合类是全局性的变量 (比如类中的静态属性，全局性的 map 等即有静态引用或 final 一直指向它)，那么没有相应的删除机制，很可能导致集合所占用的内存只增不减。比如上面的典型例子就是其中一种情况，当然实际上我们在项目中肯定不会写这么 2B 的代码，但稍不注意还是很容易出现这种情况，比如我们都喜欢通过 HashMap 做一些缓存之类的事，这种情况就要多留一些心眼。</p>
</li>
<li><p>单例造成的内存泄漏</p>
<p>由于单例的静态特性使得其生命周期跟应用的生命周期一样长，所以如果使用不恰当的话，很容易造成内存泄漏。比如下面一个典型的例子，</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public class AppManager &#123;</div><div class="line">private static AppManager instance;</div><div class="line">private Context context;</div><div class="line">private AppManager(Context context) &#123;</div><div class="line">this.context = context;</div><div class="line">&#125;</div><div class="line">public static AppManager getInstance(Context context) &#123;</div><div class="line">if (instance == null) &#123;</div><div class="line">instance = new AppManager(context);</div><div class="line">&#125;</div><div class="line">return instance;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这是一个普通的单例模式，当创建这个单例的时候，由于需要传入一个Context，所以这个Context的生命周期的长短至关重要：</p>
<p>1、如果此时传入的是 Application 的 Context，因为 Application 的生命周期就是整个应用的生命周期，所以这将没有任何问题。</p>
<p>2、如果此时传入的是 Activity 的 Context，当这个 Context 所对应的 Activity 退出时，由于该 Context 的引用被单例对象所持有，其生命周期等于整个应用程序的生命周期，所以当前 Activity 退出时它的内存并不会被回收，这就造成泄漏了。</p>
<p>正确的方式应该改为下面这种方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public class AppManager &#123;</div><div class="line">private static AppManager instance;</div><div class="line">private Context context;</div><div class="line">private AppManager(Context context) &#123;</div><div class="line">this.context = context.getApplicationContext();// 使用Application 的context</div><div class="line">&#125;</div><div class="line">public static AppManager getInstance(Context context) &#123;</div><div class="line">if (instance == null) &#123;</div><div class="line">instance = new AppManager(context);</div><div class="line">&#125;</div><div class="line">return instance;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>或者这样写，连 Context 都不用传进来了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">在你的 Application 中添加一个静态方法，getContext() 返回 Application 的 context，</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">context = getApplicationContext();</div><div class="line"></div><div class="line">...</div><div class="line">   /**</div><div class="line">     * 获取全局的context</div><div class="line">     * @return 返回全局context对象</div><div class="line">     */</div><div class="line">    public static Context getContext()&#123;</div><div class="line">        return context;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">public class AppManager &#123;</div><div class="line">private static AppManager instance;</div><div class="line">private Context context;</div><div class="line">private AppManager() &#123;</div><div class="line">this.context = MyApplication.getContext();// 使用Application 的context</div><div class="line">&#125;</div><div class="line">public static AppManager getInstance() &#123;</div><div class="line">if (instance == null) &#123;</div><div class="line">instance = new AppManager();</div><div class="line">&#125;</div><div class="line">return instance;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>匿名内部类/非静态内部类和异步线程</p>
<ul>
<li><p>非静态内部类创建静态实例造成的内存泄漏</p>
<p>有的时候我们可能会在启动频繁的Activity中，为了避免重复创建相同的数据资源，可能会出现这种写法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">public class MainActivity extends AppCompatActivity &#123;</div><div class="line">private static TestResource mResource = null;</div><div class="line">@Override</div><div class="line">protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">super.onCreate(savedInstanceState);</div><div class="line">setContentView(R.layout.activity_main);</div><div class="line">if(mManager == null)&#123;</div><div class="line">mManager = new TestResource();</div><div class="line">&#125;</div><div class="line">//...</div><div class="line">&#125;</div><div class="line">class TestResource &#123;</div><div class="line">//...</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>这样就在Activity内部创建了一个非静态内部类的单例，每次启动Activity时都会使用该单例的数据，这样虽然避免了资源的重复创建，不过这种写法却会造成内存泄漏，因为非静态内部类默认会持有外部类的引用，而该非静态内部类又创建了一个静态的实例，该实例的生命周期和应用的一样长，这就导致了该静态实例一直会持有该Activity的引用，导致Activity的内存资源不能正常回收。正确的做法为：</p>
<p>将该内部类设为静态内部类或将该内部类抽取出来封装成一个单例，如果需要使用Context，请按照上面推荐的使用Application 的 Context。当然，Application 的 context 不是万能的，所以也不能随便乱用，对于有些地方则必须使用 Activity 的 Context，对于Application，Service，Activity三者的Context的应用场景如下：</p>
<p><img src="http://img.blog.csdn.net/20151123144226349" alt=""></p>
<p><strong>其中：</strong> NO1表示 Application 和 Service 可以启动一个 Activity，不过需要创建一个新的 task 任务队列。而对于 Dialog 而言，只有在 Activity 中才能创建</p>
<ul>
<li><p>匿名内部类</p>
<p> android开发经常会继承实现Activity/Fragment/View，此时如果你使用了匿名类，并被异步线程持有了，那要小心了，如果没有任何措施这样一定会导致泄露</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">   public class MainActivity extends Activity &#123;</div><div class="line">    ...</div><div class="line">    Runnable ref1 = new MyRunable();</div><div class="line">    Runnable ref2 = new Runnable() &#123;</div><div class="line">        @Override</div><div class="line">        public void run() &#123;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">       ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>ref1和ref2的区别是，ref2使用了匿名内部类。我们来看看运行时这两个引用的内存：</p>
<p><img src="http://img2.tbcdn.cn/L1/461/1/fb05ff6d2e68f309b94dd84352c81acfe0ae839e" alt=""></p>
<p>可以看到，ref1没什么特别的。<br>但ref2这个匿名类的实现对象里面多了一个引用：<br>this$0这个引用指向MainActivity.this，也就是说当前的MainActivity实例会被ref2持有，如果将这个引用再传入一个异步线程，此线程和此Acitivity生命周期不一致的时候，就造成了Activity的泄露。</p>
<ul>
<li><p>Handler 造成的内存泄漏</p>
<p> Handler 的使用造成的内存泄漏问题应该说是最为常见了，很多时候我们为了避免 ANR 而不在主线程进行耗时操作，在处理网络任务或者封装一些请求回调等api都借助Handler来处理，但 Handler 不是万能的，对于 Handler 的使用代码编写一不规范即有可能造成内存泄漏。另外，我们知道 Handler、Message 和 MessageQueue 都是相互关联在一起的，万一 Handler 发送的 Message 尚未被处理，则该 Message 及发送它的 Handler 对象将被线程 MessageQueue 一直持有。<br> 由于 Handler 属于 TLS(Thread Local Storage) 变量, 生命周期和 Activity 是不一致的。因此这种实现方式一般很难保证跟 View 或者 Activity 的生命周期保持一致，故很容易导致无法正确释放。</p>
<p> 举个例子：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">   public class SampleActivity extends Activity &#123;</div><div class="line"></div><div class="line">  private final Handler mLeakyHandler = new Handler() &#123;</div><div class="line">    @Override</div><div class="line">    public void handleMessage(Message msg) &#123;</div><div class="line">      // ...</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  @Override</div><div class="line">  protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">    super.onCreate(savedInstanceState);</div><div class="line"></div><div class="line">    // Post a message and delay its execution for 10 minutes.</div><div class="line">    mLeakyHandler.postDelayed(new Runnable() &#123;</div><div class="line">      @Override</div><div class="line">      public void run() &#123; /* ... */ &#125;</div><div class="line">    &#125;, 1000 * 60 * 10);</div><div class="line"></div><div class="line">    // Go back to the previous Activity.</div><div class="line">    finish();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>在该 SampleActivity 中声明了一个延迟10分钟执行的消息 Message，mLeakyHandler 将其 push 进了消息队列 MessageQueue 里。当该 Activity 被 finish() 掉时，延迟执行任务的 Message 还会继续存在于主线程中，它持有该 Activity 的 Handler 引用，所以此时 finish() 掉的 Activity 就不会被回收了从而造成内存泄漏（因 Handler 为非静态内部类，它会持有外部类的引用，在这里就是指 SampleActivity）。</p>
<p>修复方法：在 Activity 中避免使用非静态内部类，比如上面我们将 Handler 声明为静态的，则其存活期跟 Activity 的生命周期就无关了。同时通过弱引用的方式引入 Activity，避免直接将 Activity 作为 context 传进去，见下面代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">public class SampleActivity extends Activity &#123;</div><div class="line"></div><div class="line">  /**</div><div class="line">   * Instances of static inner classes do not hold an implicit</div><div class="line">   * reference to their outer class.</div><div class="line">   */</div><div class="line">  private static class MyHandler extends Handler &#123;</div><div class="line">    private final WeakReference&lt;SampleActivity&gt; mActivity;</div><div class="line"></div><div class="line">    public MyHandler(SampleActivity activity) &#123;</div><div class="line">      mActivity = new WeakReference&lt;SampleActivity&gt;(activity);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void handleMessage(Message msg) &#123;</div><div class="line">      SampleActivity activity = mActivity.get();</div><div class="line">      if (activity != null) &#123;</div><div class="line">        // ...</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  private final MyHandler mHandler = new MyHandler(this);</div><div class="line"></div><div class="line">  /**</div><div class="line">   * Instances of anonymous classes do not hold an implicit</div><div class="line">   * reference to their outer class when they are &quot;static&quot;.</div><div class="line">   */</div><div class="line">  private static final Runnable sRunnable = new Runnable() &#123;</div><div class="line">      @Override</div><div class="line">      public void run() &#123; /* ... */ &#125;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  @Override</div><div class="line">  protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">    super.onCreate(savedInstanceState);</div><div class="line"></div><div class="line">    // Post a message and delay its execution for 10 minutes.</div><div class="line">    mHandler.postDelayed(sRunnable, 1000 * 60 * 10);</div><div class="line"></div><div class="line">    // Go back to the previous Activity.</div><div class="line">    finish();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>综述，即推荐使用静态内部类 + WeakReference 这种方式。每次使用前注意判空。</p>
<p>前面提到了 WeakReference，所以这里就简单的说一下 Java 对象的几种引用类型。</p>
<p>Java对引用的分类有 Strong reference, SoftReference, WeakReference, PhatomReference 四种。</p>
<p><img src="https://gw.alicdn.com/tps/TB1U6TNLVXXXXchXFXXXXXXXXXX-644-546.jpg" alt=""></p>
<p>在Android应用的开发中，为了防止内存溢出，在处理一些占用内存大而且声明周期较长的对象时候，可以尽量应用软引用和弱引用技术。</p>
<p>软/弱引用可以和一个引用队列（ReferenceQueue）联合使用，如果软引用所引用的对象被垃圾回收器回收，Java虚拟机就会把这个软引用加入到与之关联的引用队列中。利用这个队列可以得知被回收的软/弱引用的对象列表，从而为缓冲器清除已失效的软/弱引用。</p>
<p>假设我们的应用会用到大量的默认图片，比如应用中有默认的头像，默认游戏图标等等，这些图片很多地方会用到。如果每次都去读取图片，由于读取文件需要硬件操作，速度较慢，会导致性能较低。所以我们考虑将图片缓存起来，需要的时候直接从内存中读取。但是，由于图片占用内存空间比较大，缓存很多图片需要很多的内存，就可能比较容易发生OutOfMemory异常。这时，我们可以考虑使用软/弱引用技术来避免这个问题发生。以下就是高速缓冲器的雏形：</p>
<p>首先定义一个HashMap，保存软引用对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">private Map &lt;String, SoftReference&lt;Bitmap&gt;&gt; imageCache = new HashMap &lt;String, SoftReference&lt;Bitmap&gt;&gt; ();</div></pre></td></tr></table></figure>
<p>再来定义一个方法，保存Bitmap的软引用到HashMap。</p>
<p><img src="https://gw.alicdn.com/tps/TB1oW_FLVXXXXXuaXXXXXXXXXXX-679-717.jpg" alt=""></p>
<p>使用软引用以后，在OutOfMemory异常发生之前，这些缓存的图片资源的内存空间可以被释放掉的，从而避免内存达到上限，避免Crash发生。</p>
<p>如果只是想避免OutOfMemory异常的发生，则可以使用软引用。如果对于应用的性能更在意，想尽快回收一些占用内存比较大的对象，则可以使用弱引用。</p>
<p>另外可以根据对象是否经常使用来判断选择软引用还是弱引用。如果该对象可能会经常使用的，就尽量用软引用。如果该对象不被使用的可能性更大些，就可以用弱引用。</p>
<p>ok，继续回到主题。前面所说的，创建一个静态Handler内部类，然后对 Handler 持有的对象使用弱引用，这样在回收时也可以回收 Handler 持有的对象，但是这样做虽然避免了 Activity 泄漏，不过 Looper 线程的消息队列中还是可能会有待处理的消息，所以我们在 Activity 的 Destroy 时或者 Stop 时应该移除消息队列 MessageQueue 中的消息。</p>
<p>下面几个方法都可以移除 Message：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public final void removeCallbacks(Runnable r);</div><div class="line"></div><div class="line">public final void removeCallbacks(Runnable r, Object token);</div><div class="line"></div><div class="line">public final void removeCallbacksAndMessages(Object token);</div><div class="line"></div><div class="line">public final void removeMessages(int what);</div><div class="line"></div><div class="line">public final void removeMessages(int what, Object object);</div></pre></td></tr></table></figure>
<ul>
<li><p>尽量避免使用 static 成员变量</p>
<p> 如果成员变量被声明为 static，那我们都知道其生命周期将与整个app进程生命周期一样。</p>
<p> 这会导致一系列问题，如果你的app进程设计上是长驻内存的，那即使app切到后台，这部分内存也不会被释放。按照现在手机app内存管理机制，占内存较大的后台进程将优先回收，yi’wei如果此app做过进程互保保活，那会造成app在后台频繁重启。当手机安装了你参与开发的app以后一夜时间手机被消耗空了电量、流量，你的app不得不被用户卸载或者静默。<br>这里修复的方法是：</p>
</li>
</ul>
<p>不要在类初始时初始化静态成员。可以考虑lazy初始化。<br>架构设计上要思考是否真的有必要这样做，尽量避免。如果架构需要这么设计，那么此对象的生命周期你有责任管理起来。</p>
<ul>
<li><p>避免 override finalize()</p>
<p> 1、finalize 方法被执行的时间不确定，不能依赖与它来释放紧缺的资源。时间不确定的原因是：</p>
<pre><code>*   虚拟机调用GC的时间不确定

*  Finalize daemon线程被调度到的时间不确定
</code></pre><p> 2、finalize 方法只会被执行一次，即使对象被复活，如果已经执行过了 finalize 方法，再次被 GC 时也不会再执行了，原因是：</p>
<p> 含有 finalize 方法的 object 是在 new 的时候由虚拟机生成了一个 finalize reference 在来引用到该Object的，而在 finalize 方法执行的时候，该 object 所对应的 finalize Reference 会被释放掉，即使在这个时候把该 object 复活(即用强引用引用住该 object )，再第二次被 GC 的时候由于没有了 finalize reference 与之对应，所以 finalize 方法不会再执行。</p>
<p> 3、含有Finalize方法的object需要至少经过两轮GC才有可能被释放。</p>
<p>详情见这里 <a href="http://blog.csdn.net/kai_gong/article/details/24188803" target="_blank" rel="external">深入分析过dalvik的代码</a></p>
</li>
<li><p>资源未关闭造成的内存泄漏</p>
<p> 对于使用了BraodcastReceiver，ContentObserver，File，游标 Cursor，Stream，Bitmap等资源的使用，应该在Activity销毁时及时关闭或者注销，否则这些资源将不会被回收，造成内存泄漏。</p>
</li>
<li><p>一些不良代码造成的内存压力</p>
<p> 有些代码并不造成内存泄露，但是它们，或是对没使用的内存没进行有效及时的释放，或是没有有效的利用已有的对象而是频繁的申请新内存。</p>
<p> 比如：</p>
<pre><code>- Bitmap 没调用 recycle()方法，对于 Bitmap 对象在不使用时,我们应该先调用 recycle() 释放内存，然后才它设置为 null. 因为加载 Bitmap 对象的内存空间，一部分是 java 的，一部分 C   的（因为 Bitmap 分配的底层是通过 JNI 调用的 )。 而这个 recyle() 就是针对 C 部分的内存释放。

- 构造 Adapter 时，没有使用缓存的 convertView ,每次都在创建新的 converView。这里推荐使用 ViewHolder。
</code></pre></li>
</ul>
<h3 id="工具分析"><a href="#工具分析" class="headerlink" title="工具分析"></a>工具分析</h3><p>Java 内存泄漏的分析工具有很多，但众所周知的要数 MAT(Memory Analysis Tools) 和 YourKit 了。由于篇幅问题，我这里就只对 <a href="http://www.eclipse.org/mat/" target="_blank" rel="external">MAT</a> 的使用做一下介绍。–&gt; <a href="http://www.ibm.com/developerworks/cn/opensource/os-cn-ecl-ma/index.html" target="_blank" rel="external">MAT 的安装</a></p>
<ul>
<li><p>MAT分析heap的总内存占用大小来初步判断是否存在泄露</p>
<p>打开 DDMS 工具，在左边 Devices 视图页面选中“Update Heap”图标，然后在右边切换到 Heap 视图，点击 Heap 视图中的“Cause GC”按钮，到此为止需检测的进程就可以被监视。</p>
<p><img src="https://gw.alicdn.com/tps/TB1pdf2LVXXXXXeXXXXXXXXXXXX-690-514.jpg" alt=""></p>
<p>Heap视图中部有一个Type叫做data object，即数据对象，也就是我们的程序中大量存在的类类型的对象。在data object一行中有一列是“Total Size”，其值就是当前进程中所有Java数据对象的内存总量，一般情况下，这个值的大小决定了是否会有内存泄漏。可以这样判断：</p>
<p>进入某应用，不断的操作该应用，同时注意观察data object的Total Size值，正常情况下Total Size值都会稳定在一个有限的范围内，也就是说由于程序中的的代码良好，没有造成对象不被垃圾回收的情况。</p>
<p>所以说虽然我们不断的操作会不断的生成很多对象，而在虚拟机不断的进行GC的过程中，这些对象都被回收了，内存占用量会会落到一个稳定的水平；反之如果代码中存在没有释放对象引用的情况，则data object的Total Size值在每次GC后不会有明显的回落。随着操作次数的增多Total Size的值会越来越大，直到到达一个上限后导致进程被杀掉。</p>
</li>
<li><p>MAT分析hprof来定位内存泄露的原因所在</p>
<p>这是出现内存泄露后使用MAT进行问题定位的有效手段。</p>
<p>A)Dump出内存泄露当时的内存镜像hprof，分析怀疑泄露的类：</p>
<p><img src="https://gw.alicdn.com/tps/TB1r2zZLVXXXXcHXXXXXXXXXXXX-640-167.jpg" alt=""></p>
<p>B)分析持有此类对象引用的外部对象</p>
<p><img src="https://gw.alicdn.com/tps/TB17XvOLVXXXXbiXFXXXXXXXXXX-640-90.png" alt=""></p>
<p>C)分析这些持有引用的对象的GC路径</p>
<p><img src="https://gw.alicdn.com/tps/TB10yTwLVXXXXaRapXXXXXXXXXX-640-278.png" alt=""></p>
<p>D)逐个分析每个对象的GC路径是否正常</p>
<p><img src="https://gw.alicdn.com/tps/TB1CWTQLVXXXXamXFXXXXXXXXXX-640-90.png" alt=""></p>
<p>从这个路径可以看出是一个antiRadiationUtil工具类对象持有了MainActivity的引用导致MainActivity无法释放。此时就要进入代码分析此时antiRadiationUtil的引用持有是否合理（如果antiRadiationUtil持有了MainActivity的context导致节目退出后MainActivity无法销毁，那一般都属于内存泄露了）。</p>
</li>
<li><p>MAT对比操作前后的hprof来定位内存泄露的根因所在</p>
<p>为查找内存泄漏，通常需要两个 Dump结果作对比，打开 Navigator History面板，将两个表的 Histogram结果都添加到 Compare Basket中去</p>
<p>A） 第一个HPROF 文件(usingFile &gt; Open Heap Dump ).</p>
<p>B）打开Histogram view.</p>
<p>C）在NavigationHistory view里 (如果看不到就从Window &gt;show view&gt;MAT- Navigation History ), 右击histogram然后选择Add to Compare Basket .</p>
<p><img src="https://gw.alicdn.com/tps/TB1p1rULVXXXXbyXpXXXXXXXXXX-525-212.png" alt=""></p>
<p>D）打开第二个HPROF 文件然后重做步骤2和3.</p>
<p>E）切换到Compare Basket view, 然后点击Compare the Results (视图右上角的红色”!”图标)。</p>
<p><img src="https://gw.alicdn.com/tps/TB1p0zKLVXXXXX.XVXXXXXXXXXX-640-98.png" alt=""></p>
<p>F）分析对比结果</p>
<p><img src="https://gw.alicdn.com/tps/TB1lwDMLVXXXXcUXFXXXXXXXXXX-640-115.png" alt=""></p>
<p>可以看出两个hprof的数据对象对比结果。</p>
<p>通过这种方式可以快速定位到操作前后所持有的对象增量，从而进一步定位出当前操作导致内存泄露的具体原因是泄露了什么数据对象。</p>
<p>注意：</p>
<p>如果是用 MAT Eclipse 插件获取的 Dump文件，不需要经过转换则可在MAT中打开，Adt会自动进行转换。</p>
<p>而手机SDk Dump 出的文件要经过转换才能被 MAT识别，Android SDK提供了这个工具 hprof-conv (位于 sdk/tools下)</p>
<p>首先，要通过控制台进入到你的 android sdk tools 目录下执行以下命令：</p>
<p>./hprof-conv xxx-a.hprof xxx-b.hprof</p>
<p>例如 hprof-conv input.hprof out.hprof</p>
<p>此时才能将out.hprof放在eclipse的MAT中打开。</p>
</li>
</ul>
<p>Ok，下面将给大家介绍一个屌炸天的工具 – LeakCanary 。</p>
<h3 id="使用-LeakCanary-检测-Android-的内存泄漏"><a href="#使用-LeakCanary-检测-Android-的内存泄漏" class="headerlink" title="使用 LeakCanary 检测 Android 的内存泄漏"></a>使用 LeakCanary 检测 Android 的内存泄漏</h3><p>什么是 <a href="https://github.com/square/leakcanary" target="_blank" rel="external">LeakCanary</a> 呢？为什么选择它来检测 Android 的内存泄漏呢？</p>
<p>别急，让我来慢慢告诉大家！</p>
<p>LeakCanary 是国外一位大神 Pierre-Yves Ricau 开发的一个用于检测内存泄露的开源类库。一般情况下，在对战内存泄露中，我们都会经过以下几个关键步骤：</p>
<p>1、了解 OutOfMemoryError 情况。</p>
<p>2、重现问题。</p>
<p>3、在发生内存泄露的时候，把内存 Dump 出来。</p>
<p>4、在发生内存泄露的时候，把内存 Dump 出来。</p>
<p>5、计算这个对象到 GC roots 的最短强引用路径。</p>
<p>6、确定引用路径中的哪个引用是不该有的，然后修复问题。</p>
<p>很复杂对吧？</p>
<p>如果有一个类库能在发生 OOM 之前把这些事情全部都搞定，然后你只要修复这些问题就好了。LeakCanary 做的就是这件事情。你可以在 debug 包中轻松检测内存泄露。</p>
<p>一起来看这个例子（摘自 LeakCanary 中文使用说明，下面会附上所有的参考文档链接）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">class Cat &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line">class Box &#123;</div><div class="line">  Cat hiddenCat;</div><div class="line">&#125;</div><div class="line">class Docker &#123;</div><div class="line">    // 静态变量，将不会被回收，除非加载 Docker 类的 ClassLoader 被回收。</div><div class="line">    static Box container;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// ...</div><div class="line"></div><div class="line">Box box = new Box();</div><div class="line"></div><div class="line">// 薛定谔之猫</div><div class="line">Cat schrodingerCat = new Cat();</div><div class="line">box.hiddenCat = schrodingerCat;</div><div class="line">Docker.container = box;</div></pre></td></tr></table></figure>
<p>创建一个RefWatcher，监控对象引用情况。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// 我们期待薛定谔之猫很快就会消失（或者不消失），我们监控一下</div><div class="line">refWatcher.watch(schrodingerCat);</div></pre></td></tr></table></figure>
<p>当发现有内存泄露的时候，你会看到一个很漂亮的 leak trace 报告:</p>
<ul>
<li>GC ROOT static Docker.container</li>
<li>references Box.hiddenCat</li>
<li>leaks Cat instance</li>
</ul>
<p>我们知道，你很忙，每天都有一大堆需求。所以我们把这个事情弄得很简单，你只需要添加一行代码就行了。然后 LeakCanary 就会自动侦测 activity 的内存泄露了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public class ExampleApplication extends Application &#123;</div><div class="line">  @Override public void onCreate() &#123;</div><div class="line">    super.onCreate();</div><div class="line">    LeakCanary.install(this);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后你会在通知栏看到这样很漂亮的一个界面:</p>
<p><img src="https://corner.squareup.com/images/leakcanary/leaktrace.png" alt=""></p>
<p>以很直白的方式将内存泄露展现在我们的面前。</p>
<h4 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h4><p>一个非常简单的 LeakCanary demo: <a href="https://github.com/liaohuqiu/leakcanary-demo" target="_blank" rel="external">一个非常简单的 LeakCanary demo: https://github.com/liaohuqiu/leakcanary-demo</a></p>
<h4 id="接入"><a href="#接入" class="headerlink" title="接入"></a>接入</h4><p>在 build.gradle 中加入引用，不同的编译使用不同的引用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">  debugCompile &apos;com.squareup.leakcanary:leakcanary-android:1.3&apos;</div><div class="line">  releaseCompile &apos;com.squareup.leakcanary:leakcanary-android-no-op:1.3&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h4><p>使用 RefWatcher 监控那些本该被回收的对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">RefWatcher refWatcher = &#123;...&#125;;</div><div class="line"></div><div class="line">// 监控</div><div class="line">refWatcher.watch(schrodingerCat);</div></pre></td></tr></table></figure>
<p>LeakCanary.install() 会返回一个预定义的 RefWatcher，同时也会启用一个 ActivityRefWatcher，用于自动监控调用 Activity.onDestroy() 之后泄露的 activity。</p>
<p>在Application中进行配置 ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public class ExampleApplication extends Application &#123;</div><div class="line"></div><div class="line">  public static RefWatcher getRefWatcher(Context context) &#123;</div><div class="line">    ExampleApplication application = (ExampleApplication) context.getApplicationContext();</div><div class="line">    return application.refWatcher;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  private RefWatcher refWatcher;</div><div class="line"></div><div class="line">  @Override public void onCreate() &#123;</div><div class="line">    super.onCreate();</div><div class="line">    refWatcher = LeakCanary.install(this);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用 RefWatcher 监控 Fragment：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public abstract class BaseFragment extends Fragment &#123;</div><div class="line"></div><div class="line">  @Override public void onDestroy() &#123;</div><div class="line">    super.onDestroy();</div><div class="line">    RefWatcher refWatcher = ExampleApplication.getRefWatcher(getActivity());</div><div class="line">    refWatcher.watch(this);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用 RefWatcher 监控 Activity：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">public class MainActivity extends AppCompatActivity &#123;</div><div class="line"></div><div class="line">    ......</div><div class="line">    @Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">            //在自己的应用初始Activity中加入如下两行代码</div><div class="line">        RefWatcher refWatcher = ExampleApplication.getRefWatcher(this);</div><div class="line">        refWatcher.watch(this);</div><div class="line"></div><div class="line">        textView = (TextView) findViewById(R.id.tv);</div><div class="line">        textView.setOnClickListener(new View.OnClickListener() &#123;</div><div class="line">            @Override</div><div class="line">            public void onClick(View v) &#123;</div><div class="line">                startAsyncTask();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void async() &#123;</div><div class="line"></div><div class="line">        startAsyncTask();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void startAsyncTask() &#123;</div><div class="line">        // This async task is an anonymous class and therefore has a hidden reference to the outer</div><div class="line">        // class MainActivity. If the activity gets destroyed before the task finishes (e.g. rotation),</div><div class="line">        // the activity instance will leak.</div><div class="line">        new AsyncTask&lt;Void, Void, Void&gt;() &#123;</div><div class="line">            @Override</div><div class="line">            protected Void doInBackground(Void... params) &#123;</div><div class="line">                // Do some slow work in background</div><div class="line">                SystemClock.sleep(20000);</div><div class="line">                return null;</div><div class="line">            &#125;</div><div class="line">        &#125;.execute();</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="工作机制"><a href="#工作机制" class="headerlink" title="工作机制"></a>工作机制</h4><p>1.RefWatcher.watch() 创建一个 KeyedWeakReference 到要被监控的对象。</p>
<p>2.然后在后台线程检查引用是否被清除，如果没有，调用GC。</p>
<p>3.如果引用还是未被清除，把 heap 内存 dump 到 APP 对应的文件系统中的一个 .hprof 文件中。</p>
<p>4.在另外一个进程中的 HeapAnalyzerService 有一个 HeapAnalyzer 使用HAHA 解析这个文件。</p>
<p>5.得益于唯一的 reference key, HeapAnalyzer 找到 KeyedWeakReference，定位内存泄露。</p>
<p>6.HeapAnalyzer 计算 到 GC roots 的最短强引用路径，并确定是否是泄露。如果是的话，建立导致泄露的引用链。</p>
<p>7.引用链传递到 APP 进程中的 DisplayLeakService， 并以通知的形式展示出来。</p>
<p>ok,这里就不再深入了，想要了解更多就到 <a href="https://github.com/square/leakcanary" target="_blank" rel="external">作者 github 主页</a> 这去哈。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><p>对 Activity 等组件的引用应该控制在 Activity 的生命周期之内； 如果不能就考虑使用 getApplicationContext 或者 getApplication，以避免 Activity 被外部长生命周期的对象引用而泄露。</p>
</li>
<li><p>尽量不要在静态变量或者静态内部类中使用非静态外部成员变量（包括context )，即使要使用，也要考虑适时把外部成员变量置空；也可以在内部类中使用弱引用来引用外部类的变量。</p>
</li>
<li><p>对于生命周期比Activity长的内部类对象，并且内部类中使用了外部类的成员变量，可以这样做避免内存泄漏：</p>
<ul>
<li>将内部类改为静态内部类</li>
<li>静态内部类中使用弱引用来引用外部类的成员变量</li>
</ul>
</li>
</ul>
<ul>
<li><p>Handler 的持有的引用对象最好使用弱引用，资源释放时也可以清空 Handler 里面的消息。比如在 Activity onStop 或者 onDestroy 的时候，取消掉该 Handler 对象的 Message和 Runnable.</p>
</li>
<li><p>在 Java 的实现过程中，也要考虑其对象释放，最好的方法是在不使用某对象时，显式地将此对象赋值为 null，比如使用完Bitmap 后先调用 recycle()，再赋为null,清空对图片等资源有直接引用或者间接引用的数组（使用 array.clear() ; array = null）等，最好遵循谁创建谁释放的原则。</p>
</li>
<li><p>正确关闭资源，对于使用了BraodcastReceiver，ContentObserver，File，游标 Cursor，Stream，Bitmap等资源的使用，应该在Activity销毁时及时关闭或者注销。</p>
</li>
<li><p>保持对对象生命周期的敏感，特别注意单例、静态对象、全局性集合等的生命周期。</p>
</li>
</ul>
<h4 id="以上部分图片、实例代码和文段都摘自或参考以下文章-："><a href="#以上部分图片、实例代码和文段都摘自或参考以下文章-：" class="headerlink" title="以上部分图片、实例代码和文段都摘自或参考以下文章 ："></a>以上部分图片、实例代码和文段都摘自或参考以下文章 ：</h4><p>支付宝：</p>
<p><a href="http://www.atatech.org/articles/44198" target="_blank" rel="external">Android怎样coding避免内存泄露</a></p>
<p><a href="http://www.atatech.org/articles/44197/?frm=mail_daily&amp;uid=130319" target="_blank" rel="external">支付宝钱包Android内存治理</a></p>
<p>IBM ：</p>
<p><a href="http://www.ibm.com/developerworks/cn/java/l-JavaMemoryLeak/" target="_blank" rel="external">Java的内存泄漏</a></p>
<p>Android Design Patterns ：</p>
<p><a href="http://www.androiddesignpatterns.com/2013/01/inner-class-handler-memory-leak.html" target="_blank" rel="external">How to Leak a Context: Handlers &amp; Inner Classes</a></p>
<p>伯乐在线团队：</p>
<p><a href="http://android.jobbole.com/82198/" target="_blank" rel="external">Android性能优化之常见的内存泄漏</a></p>
<p>我厂同学 ：</p>
<p><a href="http://blog.csdn.net/kai_gong/article/details/24188803" target="_blank" rel="external">Dalvik虚拟机 Finalize 方法执行分析</a></p>
<p>腾讯bugly ：</p>
<p><a href="http://bugly.qq.com/blog/?p=832" target="_blank" rel="external">内存泄露从入门到精通三部曲之基础知识篇</a></p>
<p><a href="http://bugly.qq.com/blog/?p=872" target="_blank" rel="external">内存泄露从入门到精通三部曲之排查方法篇</a></p>
<p><a href="http://bugly.qq.com/blog/?p=884" target="_blank" rel="external">内存泄露从入门到精通三部曲之常见原因与用户实践</a></p>
<p>LeakCanary :</p>
<p><a href="http://www.liaohuqiu.net/cn/posts/leak-canary-read-me/" target="_blank" rel="external">LeakCanary 中文使用说明</a></p>
<p><a href="http://www.liaohuqiu.net/cn/posts/leak-canary/" target="_blank" rel="external">LeakCanary: 让内存泄露无所遁形</a></p>
<p><a href="https://github.com/square/leakcanary" target="_blank" rel="external">https://github.com/square/leakcanary</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Android/">Android</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 箫鉴哥
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: false,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: /
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>