<!DOCTYPE html>
<html lang="">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="PWA 添加 Web Push 通知"/>




  <meta name="keywords" content="PWA," />





  <link rel="alternate" href="/atom.xml" title="箫鉴哥">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="http://G96968586.github.io/2017/11/29/PWA-添加-Web-Push-通知/"/>


<meta name="description" content="本文主要介绍如何往 PWA 中添加推送通知功能，如果你有兴趣想了解更多关于 Web Push 技术，可以阅读这篇文章《PWA系列 - Web Push 技术》，看一篇抵过 n 篇 Google 的文档。OK，下面我们进入主题。同样，你需要先做一些准备工作，可以参考这篇《搭建你的第一个 PWA》文章。然后下载示例代码：download: push-notifications-master.zip 注">
<meta name="keywords" content="PWA">
<meta property="og:type" content="article">
<meta property="og:title" content="PWA 添加 Web Push 通知">
<meta property="og:url" content="http://G96968586.github.io/2017/11/29/PWA-添加-Web-Push-通知/index.html">
<meta property="og:site_name" content="箫鉴哥">
<meta property="og:description" content="本文主要介绍如何往 PWA 中添加推送通知功能，如果你有兴趣想了解更多关于 Web Push 技术，可以阅读这篇文章《PWA系列 - Web Push 技术》，看一篇抵过 n 篇 Google 的文档。OK，下面我们进入主题。同样，你需要先做一些准备工作，可以参考这篇《搭建你的第一个 PWA》文章。然后下载示例代码：download: push-notifications-master.zip 注">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://private-alipayobjects.alipay.com/alipay-rmsdeploy-image/skylark/png/e32187ca-e5c1-4071-b1d1-024b0c17621a.png">
<meta property="og:image" content="https://private-alipayobjects.alipay.com/alipay-rmsdeploy-image/skylark/png/40be4c5b212b8e6e.png">
<meta property="og:image" content="https://private-alipayobjects.alipay.com/alipay-rmsdeploy-image/skylark/png/dc930520-3d40-409a-be0b-c5855057ae78.png">
<meta property="og:image" content="https://private-alipayobjects.alipay.com/alipay-rmsdeploy-image/skylark/png/7a6cf3b7-be1b-4841-b7c8-ef274ad7862a.png">
<meta property="og:image" content="https://private-alipayobjects.alipay.com/alipay-rmsdeploy-image/skylark/png/5d381b34-e1ca-4fc4-a182-4536976f60e3.png">
<meta property="og:image" content="https://private-alipayobjects.alipay.com/alipay-rmsdeploy-image/skylark/png/f51f662b-28d4-4b1b-9c92-ae5e76df6a82.png">
<meta property="og:image" content="https://gw.alicdn.com/tfs/TB1fr7YazuhSKJjSspmXXcQDpXa-2874-1720.png">
<meta property="og:image" content="https://gw.alicdn.com/tfs/TB1qj89eMMPMeJjy1XdXXasrXXa-2872-1652.png">
<meta property="og:image" content="https://gw.alicdn.com/tfs/TB1_dQ1aqagSKJjy0FbXXa.mVXa-2876-1320.png">
<meta property="og:image" content="https://gw.alicdn.com/tfs/TB1Y7mgX2NNTKJjSspfXXbXIFXa-2880-1488.png">
<meta property="og:image" content="https://gw.alicdn.com/tfs/TB1K8Z7aqagSKJjy0FhXXcrbFXa-2880-1488.png">
<meta property="og:image" content="https://gw.alicdn.com/tfs/TB1HImKeMoQMeJjy0FpXXcTxpXa-716-148.png">
<meta property="og:image" content="https://gw.alicdn.com/tfs/TB1NWOTeMMPMeJjy1XcXXXpppXa-2880-1658.png">
<meta property="og:image" content="https://gw.alicdn.com/tfs/TB1LnGTeMMPMeJjy1XcXXXpppXa-2880-1498.png">
<meta property="og:image" content="https://gw.alicdn.com/tfs/TB1bLmBeMMPMeJjy1XdXXasrXXa-1878-294.png">
<meta property="og:updated_time" content="2018-05-06T15:35:22.313Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PWA 添加 Web Push 通知">
<meta name="twitter:description" content="本文主要介绍如何往 PWA 中添加推送通知功能，如果你有兴趣想了解更多关于 Web Push 技术，可以阅读这篇文章《PWA系列 - Web Push 技术》，看一篇抵过 n 篇 Google 的文档。OK，下面我们进入主题。同样，你需要先做一些准备工作，可以参考这篇《搭建你的第一个 PWA》文章。然后下载示例代码：download: push-notifications-master.zip 注">
<meta name="twitter:image" content="https://private-alipayobjects.alipay.com/alipay-rmsdeploy-image/skylark/png/e32187ca-e5c1-4071-b1d1-024b0c17621a.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> PWA 添加 Web Push 通知 - 箫鉴哥 </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">箫鉴哥</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          PWA 添加 Web Push 通知
        
      </h1>

      <time class="post-time">
          Nov 29 2017
      </time>
    </header>



    
            <div class="post-content">
            <p>本文主要介绍如何往 PWA 中添加推送通知功能，如果你有兴趣想了解更多关于 Web Push 技术，可以阅读这篇文章<a href="">《PWA系列 - Web Push 技术》</a>，看一篇抵过 n 篇 Google 的文档。<br>OK，下面我们进入主题。同样，你需要先做一些准备工作，可以参考这篇<a href="">《搭建你的第一个 PWA》</a>文章。然后下载示例代码：<br><a href="">download: push-notifications-master.zip</a></p>
<h2 id="注册-Service-Worker"><a href="#注册-Service-Worker" class="headerlink" title="注册 Service Worker"></a>注册 Service Worker</h2><p>解压示例代码，在 app 目录下有一个 sw.js 的文件，打开你会发现里面除了一些注释和一行 <code>use strict;</code>外什么都没有，后面我们会不断往里面添加代码的，因为这个文件是我们的服务工作线程。<br>现在，打开 scripts/main.js，这是示例程序的入口，在文件的末尾添加下面代码，<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">'serviceWorker'</span> <span class="keyword">in</span> navigator &amp;&amp; <span class="string">'PushManager'</span> <span class="keyword">in</span> <span class="built_in">window</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Service Worker and Push is supported'</span>);</span><br><span class="line"></span><br><span class="line">  navigator.serviceWorker.register(<span class="string">'sw.js'</span>)</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">swReg</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Service Worker is registered'</span>, swReg);</span><br><span class="line"></span><br><span class="line">    swRegistration = swReg;</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">'Service Worker Error'</span>, error);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.warn(<span class="string">'Push messaging is not supported'</span>);</span><br><span class="line">  pushButton.textContent = <span class="string">'Push Not Supported'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这是一段注册服务工作线程的代码，但你会发现这段代码跟前面文章所介绍的注册服务工作线程有些不太一样，是的，我们这里同时检查了浏览器是否支持推送消息： ‘PushManager’ in window。<br>打开 Web Server for Chrome，选择访问目录为 app，<br><img src="https://private-alipayobjects.alipay.com/alipay-rmsdeploy-image/skylark/png/e32187ca-e5c1-4071-b1d1-024b0c17621a.png" alt="屏幕快照 2017-09-17 下午10.23.33.png | center | 644x680"></p>
<p>在浏览器打开网址 <strong>127.0.0.1:8887 </strong>访问我们的示例应用。如果你前面阅读过 <a href="https://lark.alipay.com/fgt-mobile/be9mcc/dt2egy" target="_blank" rel="noopener">《调试 Service Workers》</a>，并在自己的电脑上做过调试，你也许会访问到这个页面，<br><img src="https://private-alipayobjects.alipay.com/alipay-rmsdeploy-image/skylark/png/40be4c5b212b8e6e.png" alt="image | center"></p>
<p>这是因为前面我们缓存了一些资源文件，你可以打开开发者工具，切换到 Application 视图 Clear storage 选项，点击 Clear site data，清除缓存再次刷新页面，当你访问到下面这个绿色主题的页面，说明你前面操作成功！<br><img src="https://private-alipayobjects.alipay.com/alipay-rmsdeploy-image/skylark/png/dc930520-3d40-409a-be0b-c5855057ae78.png" alt="屏幕快照 2017-09-17 下午10.29.06.png | center | 2878x1536"></p>
<h3 id="获取应用服务器密钥"><a href="#获取应用服务器密钥" class="headerlink" title="获取应用服务器密钥"></a>获取应用服务器密钥</h3><p>使用示例代码，我们还需要生成一些应用服务器密钥，访问示例代码配套网站：<a href="https://web-push-codelab.appspot.com/?hl=zh-cn" target="_blank" rel="noopener">https://web-push-codelab.appspot.com/</a>，我们可以在这里生成一个公私密钥对。<br><img src="https://private-alipayobjects.alipay.com/alipay-rmsdeploy-image/skylark/png/7a6cf3b7-be1b-4841-b7c8-ef274ad7862a.png" alt="屏幕快照 2017-09-17 下午10.39.05.png | center | 2876x1180"></p>
<p>点击 refresh keys 按钮，然后将公钥复制到<code>scripts/main.js</code>替换<code>&lt;Your Public Key&gt;</code>值：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> applicationServerPublicKey = <span class="string">'&lt;Your Public Key&gt;'</span>;</span><br></pre></td></tr></table></figure></p>
<h2 id="初始化状态"><a href="#初始化状态" class="headerlink" title="初始化状态"></a>初始化状态</h2><p>你可以发现，目前我们的示例程序页面上的那个按钮不可点击。<br><img src="https://private-alipayobjects.alipay.com/alipay-rmsdeploy-image/skylark/png/5d381b34-e1ca-4fc4-a182-4536976f60e3.png" alt="屏幕快照 2017-09-17 下午11.43.42.png | center | 754x300"></p>
<p>因为默认情况下最好禁用推送按钮。如果检测到当前浏览器环境支持推送功能，并且当前用户订阅了推送消息，我们再启用此按钮。<br>下面我们在 scripts/main.js 里面添加两个函数：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检查当前用户有没有订阅消息</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initialiseUI</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Set the initial subscription value</span></span><br><span class="line">  swRegistration.pushManager.getSubscription()</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">subscription</span>) </span>&#123;</span><br><span class="line">    isSubscribed = !(subscription === <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isSubscribed) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'User IS subscribed.'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'User is NOT subscribed.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    updateBtn();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将启用推送按钮，以及更改用户是否订阅的文本，在 initialiseUI 里调用</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateBtn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isSubscribed) &#123;</span><br><span class="line">    pushButton.textContent = <span class="string">'Disable Push Messaging'</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    pushButton.textContent = <span class="string">'Enable Push Messaging'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  pushButton.disabled = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在注册服务工作线程时调用 initialiseUI() 函数。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">navigator.serviceWorker.register(<span class="string">'sw.js'</span>)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span>(<span class="params">swReg</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Service Worker is registered'</span>, swReg);</span><br><span class="line"></span><br><span class="line">  swRegistration = swReg;</span><br><span class="line">  <span class="comment">// 这里调用</span></span><br><span class="line">  initialiseUI();</span><br><span class="line">&#125;)</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>刷新页面，可以看到此时页面上的按钮变成可点击状态了，从 console 控制台上可以看到下面的输出，注意到其中有一句是 <code>User is NOT subscribed</code>，下面我们开始来订阅消息。<br><img src="https://private-alipayobjects.alipay.com/alipay-rmsdeploy-image/skylark/png/f51f662b-28d4-4b1b-9c92-ae5e76df6a82.png" alt="屏幕快照 2017-09-18 上午10.08.52.png | center | 2880x1600"></p>
<h2 id="用户订阅"><a href="#用户订阅" class="headerlink" title="用户订阅"></a>用户订阅</h2><p>在 initialiseUI() 函数里添加点击事件监听器。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initialiseUI</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  pushButton.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 用户点击按钮后，我们先设置按钮处于不可点击状态，防止用户重复订阅消息</span></span><br><span class="line">    pushButton.disabled = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (isSubscribed) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Unsubscribe user</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      subscribeUser();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set the initial subscription value</span></span><br><span class="line">  swRegistration.pushManager.getSubscription()</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">subscription</span>) </span>&#123;</span><br><span class="line">    isSubscribed = !(subscription === <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">// 注意，这里新增了一行代码</span></span><br><span class="line">    updateSubscriptionOnServer(subscription);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isSubscribed) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'User IS subscribed.'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'User is NOT subscribed.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    updateBtn();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在 scripts/main.js 里添加 subscribeUser 函数，<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">subscribeUser</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> applicationServerKey = urlB64ToUint8Array(applicationServerPublicKey);</span><br><span class="line">  swRegistration.pushManager.subscribe(&#123;</span><br><span class="line">    userVisibleOnly: <span class="literal">true</span>,</span><br><span class="line">    applicationServerKey: applicationServerKey</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">subscription</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'User is subscribed:'</span>, subscription);</span><br><span class="line"></span><br><span class="line">    updateSubscriptionOnServer(subscription);</span><br><span class="line"></span><br><span class="line">    isSubscribed = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    updateBtn();</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Failed to subscribe the user: '</span>, err);</span><br><span class="line">    updateBtn();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个函数的作用是，先获取应用服务器的公钥（base64 网址安全编码），然后将其转换为 UInt8Array。转换后，我们调用 swRegistration.pushManager 的 subscribe() 方法，把应用服务器的公钥和 userVisibleOnly: true 传进去。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> applicationServerKey = urlB64ToUint8Array(applicationServerPublicKey);</span><br><span class="line">swRegistration.pushManager.subscribe(&#123;</span><br><span class="line">  userVisibleOnly: <span class="literal">true</span>,</span><br><span class="line">  applicationServerKey: applicationServerKey</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>userVisibleOnly 表示在发送推送时显示我们的消息通知。<br>调用 subscribe() 方法后会返回一个 promise：</p>
<ol>
<li>用户已授权显示通知</li>
<li>浏览器已向推送服务发送网络请求，以便获取详细信息来生成 PushSubscription</li>
</ol>
<p>如果这些步骤成功执行，我们可以在 then 回调里对 subscription 进行解析，如果用户未授权，或者出现其他问题，我们需要在 catch 里做错误处理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">swRegistration.pushManager.subscribe(&#123;</span><br><span class="line">  userVisibleOnly: <span class="literal">true</span>,</span><br><span class="line">  applicationServerKey: applicationServerKey</span><br><span class="line">&#125;)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span>(<span class="params">subscription</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'User is subscribed:'</span>, subscription);</span><br><span class="line"></span><br><span class="line">  updateSubscriptionOnServer(subscription);</span><br><span class="line"></span><br><span class="line">  isSubscribed = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  updateBtn();</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line">.catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Failed to subscribe the user: '</span>, err);</span><br><span class="line">  updateBtn();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这样我们就可以收到订阅，并将用户标记为已订阅用户。成功或出错我们都调用 updateBtn 函数来修改按钮文案。下面在 scripts/main.js 里添加 updateSubscriptionOnServer 方法，将订阅发送到后端。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateSubscriptionOnServer</span>(<span class="params">subscription</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Send subscription to application server</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> subscriptionJson = <span class="built_in">document</span>.querySelector(<span class="string">'.js-subscription-json'</span>);</span><br><span class="line">  <span class="keyword">const</span> subscriptionDetails =</span><br><span class="line">    <span class="built_in">document</span>.querySelector(<span class="string">'.js-subscription-details'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (subscription) &#123;</span><br><span class="line">    subscriptionJson.textContent = <span class="built_in">JSON</span>.stringify(subscription);</span><br><span class="line">    subscriptionDetails.classList.remove(<span class="string">'is-invisible'</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    subscriptionDetails.classList.add(<span class="string">'is-invisible'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这时候刷新页面，点击订阅按钮，会看到下面的权限提示，</p>
<p><img src="https://gw.alicdn.com/tfs/TB1fr7YazuhSKJjSspmXXcQDpXa-2874-1720.png" alt="image | center"></p>
<p>点击允许，可以看到 console 控制台输出了 User is subscribe，同时页面底部出现了订阅信息。</p>
<p><img src="https://gw.alicdn.com/tfs/TB1qj89eMMPMeJjy1XdXXasrXXa-2872-1652.png" alt="image | center"></p>
<h2 id="处理拒绝的权限"><a href="#处理拒绝的权限" class="headerlink" title="处理拒绝的权限"></a>处理拒绝的权限</h2><p>我们还需要处理当用户点击拒绝的情况。因为如果用户拒绝了我们的推送，我们的页面是无法重新显示权限提示的，所以，这里的做法是禁止推送按钮。</p>
<p>在 updateBtn() 里检查 Notification.permission 的值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateBtn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 如果权限为 denied，就无法订阅用户，并且我们无法执行其他操作，因此，停用此按钮是最好的做法</span></span><br><span class="line">  <span class="keyword">if</span> (Notification.permission === <span class="string">'denied'</span>) &#123;</span><br><span class="line">    pushButton.textContent = <span class="string">'Push Messaging Blocked.'</span>;</span><br><span class="line">    pushButton.disabled = <span class="literal">true</span>;</span><br><span class="line">    updateSubscriptionOnServer(<span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isSubscribed) &#123;</span><br><span class="line">    pushButton.textContent = <span class="string">'Disable Push Messaging'</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    pushButton.textContent = <span class="string">'Enable Push Messaging'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  pushButton.disabled = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回到浏览器，刷新页面，点击网址栏的圆圈中的 <strong>i</strong>，将通知权限更改为 <em>Use global default (Ask)</em> 。</p>
<p><img src="https://gw.alicdn.com/tfs/TB1_dQ1aqagSKJjy0FbXXa.mVXa-2876-1320.png" alt="image | center"></p>
<p>重新加载页面，点击订阅按钮，选择禁止，发现按钮的文案现在改为 Push Messaging Blocked，并且处于不可点击状态。</p>
<p><img src="https://gw.alicdn.com/tfs/TB1Y7mgX2NNTKJjSspfXXbXIFXa-2880-1488.png" alt="image | center"></p>
<h2 id="处理推送事件"><a href="#处理推送事件" class="headerlink" title="处理推送事件"></a>处理推送事件</h2><p>在 sw.js 文件添加下面的推送事件监听器，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">self.addEventListener(<span class="string">'push'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'[Service Worker] Push Received.'</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`[Service Worker] Push had this data: "<span class="subst">$&#123;event.data.text()&#125;</span>"`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> title = <span class="string">'Push Codelab'</span>;</span><br><span class="line">  <span class="keyword">const</span> options = &#123;</span><br><span class="line">    body: <span class="string">'Yay it works.'</span>,</span><br><span class="line">    icon: <span class="string">'images/icon.png'</span>,</span><br><span class="line">    badge: <span class="string">'images/badge.png'</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  event.waitUntil(self.registration.showNotification(title, options));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>在我们触发推送消息后，浏览器会收到推送消息，再唤醒相应的服务线程并分配推送事件。我们需要监听此事件，并将通知显示出来。</p>
<p>收到推送消息后，会触发推送事件监听，我们通过在注册时调用 showNotification() 来创建通知并将其显示出来。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> title = <span class="string">'Push Codelab'</span>;</span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  body: <span class="string">'Yay it works.'</span>, <span class="comment">// 消息正文</span></span><br><span class="line">  icon: <span class="string">'images/icon.png'</span>, <span class="comment">// 图标</span></span><br><span class="line">  badge: <span class="string">'images/badge.png'</span> <span class="comment">// 标志</span></span><br><span class="line">&#125;;</span><br><span class="line">self.registration.showNotification(title, options);</span><br></pre></td></tr></table></figure>
<p>现在我们来测试一下，刷新浏览器，并将通知权限更改为 Use global default (Ask)，选择允许，然后在 Application 视图 Service Workers 选项下点击右边的 Push 按钮，发送模拟通知。</p>
<p><img src="https://gw.alicdn.com/tfs/TB1K8Z7aqagSKJjy0FhXXcrbFXa-2880-1488.png" alt="image | center"></p>
<p>会收到类似如下的通知：</p>
<p><img src="https://gw.alicdn.com/tfs/TB1HImKeMoQMeJjy0FpXXcTxpXa-716-148.png" alt="image | center"></p>
<h2 id="通知点击处理"><a href="#通知点击处理" class="headerlink" title="通知点击处理"></a>通知点击处理</h2><p>我们都希望用户收到通知后，去点击它，并作出一些行为，比如，打开一个链接。现在我们来加上这个处理逻辑。</p>
<p>在 sw.js 添加 notificationclick 事件的监听，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">self.addEventListener(<span class="string">'notificationclick'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'[Service Worker] Notification click Received.'</span>);</span><br><span class="line"></span><br><span class="line">  event.notification.close();</span><br><span class="line"></span><br><span class="line">  event.waitUntil(</span><br><span class="line">    clients.openWindow(<span class="string">'https://www.taobao.com'</span>)</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>当用户点击通知时，会调用 notificationclick 事件监听器，打开淘宝首页。</p>
<h2 id="发送推送消息"><a href="#发送推送消息" class="headerlink" title="发送推送消息"></a>发送推送消息</h2><p>下面我们来发送实际的推送消息了。回到配套网站 <a href="https://web-push-codelab.appspot.com/?hl=zh-cn%EF%BC%8C%E5%88%B7%E6%96%B0%E5%AF%86%E9%92%A5" target="_blank" rel="noopener">https://web-push-codelab.appspot.com/?hl=zh-cn，刷新密钥</a>(因为前面的 key 可能会失效，导致发送消息不成功)，更新 scripts/main.js  的 applicationServerPublicKey，然后回到示例页面，在 Application 视图里切到 Clear storage 选项，点击下边的 Clear site data，刷新页面重新订阅消息。</p>
<p>复制下面这段 Json 字符串，</p>
<p><img src="https://gw.alicdn.com/tfs/TB1NWOTeMMPMeJjy1XcXXXpppXa-2880-1658.png" alt="image | center"></p>
<p>然后粘贴到配套网站的 <em>Subscription to Send To</em> 文本区域：</p>
<p><img src="https://gw.alicdn.com/tfs/TB1LnGTeMMPMeJjy1XcXXXpppXa-2880-1498.png" alt="image | center"></p>
<p>点击 send push message 按钮，回到我们的示例页面，在控制台可以看到有一句 Push had this data: “This is a test!” 说明我们已经收到了推送消息。</p>
<p>上面的配套网站其实就是使用 <a href="https://github.com/web-push-libs/web-push" target="_blank" rel="noopener">web-push 库</a> 发送消息的节点服务器。我们可以查看 <a href="https://github.com/web-push-libs/" target="_blank" rel="noopener">Github 上的 web-push-libs org</a>，看看有哪些库可以发送推送消息。</p>
<h2 id="取消订阅用户"><a href="#取消订阅用户" class="headerlink" title="取消订阅用户"></a>取消订阅用户</h2><p>下面介绍如何取消用户的推送消息订阅。我们需要对 PushSubscription 调用 unsubscribe()。</p>
<p>在 scripts/main.js 里将 initialiseUI() 中 pushButton 的点击事件修改为下面代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pushButton.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  pushButton.disabled = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">if</span> (isSubscribed) &#123;</span><br><span class="line">    unsubscribeUser();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    subscribeUser();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>unsubscribeUser 方法如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unsubscribeUser</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 首先，我们通过调用 getSubscription() 获取当前的订阅</span></span><br><span class="line">  swRegistration.pushManager.getSubscription()</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">subscription</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 如果 subscription 存在，调用其 unsubscribe 方法</span></span><br><span class="line">    <span class="keyword">if</span> (subscription) &#123;</span><br><span class="line">      <span class="keyword">return</span> subscription.unsubscribe();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Error unsubscribing'</span>, error);</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    updateSubscriptionOnServer(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'User is unsubscribed.'</span>);</span><br><span class="line">    isSubscribed = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    updateBtn();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们现在来试一试，刷新页面，点击 <em>Disable Push Messaging</em>，可以看到控制台输出了：</p>
<p><img src="https://gw.alicdn.com/tfs/TB1bLmBeMMPMeJjy1XdXXasrXXa-1878-294.png" alt="image | center"></p>
<p>OK，教程到这里就结束了，如果你想继续深入了解，可以点击下面这两个链接</p>
<ul>
<li>Web Fundamentals 上的 <a href="https://developers.google.com/web/fundamentals/engage-and-retain/push-notifications/?hl=zh-cn" target="_blank" rel="noopener">网络推送通知</a> 文档</li>
<li><a href="https://github.com/web-push-libs/" target="_blank" rel="noopener">网络推送库</a> - 网络推送库包括 Node.js、PHP、Java 和 Python。</li>
</ul>

            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
			<a href="/tags/PWA/">PWA</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2017/11/29/有关-PWA-的几个宝贵实践经验/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">有关 PWA 的几个宝贵实践经验</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2017/11/29/App-Shell-模型介绍/">
        <span class="next-text nav-default">App Shell 模型介绍</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2016 -
    
    2018
    <span class="footer-author">箫鉴哥.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
