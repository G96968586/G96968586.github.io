<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>聊聊 Android 的 Service 组件 | 箫鉴哥博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Android 开发的同学都知道，Android 有四大组件，分别是 Activity、Service、BroadcastReceiver 和 ContentProvider。在这里，我想跟大家聊一聊 Service 组件，我们从头开始，包括什么是 Service？Service 有什么作用？怎么使用它？需要关注哪些性能问题？什么情况下使用它最合适？好，废话少说，马上进入主题。
直译过来，Serv">
<meta property="og:type" content="article">
<meta property="og:title" content="聊聊 Android 的 Service 组件">
<meta property="og:url" content="http://G96968586.github.io/2016/09/15/聊聊-Android-的-Service-组件/index.html">
<meta property="og:site_name" content="箫鉴哥博客">
<meta property="og:description" content="Android 开发的同学都知道，Android 有四大组件，分别是 Activity、Service、BroadcastReceiver 和 ContentProvider。在这里，我想跟大家聊一聊 Service 组件，我们从头开始，包括什么是 Service？Service 有什么作用？怎么使用它？需要关注哪些性能问题？什么情况下使用它最合适？好，废话少说，马上进入主题。
直译过来，Serv">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1onGRLXXXXXcvXVXXXXXXXXXX-389-507.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1GIa9LXXXXXXSXpXXXXXXXXXX-970-236.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1FRSPLXXXXXXYaXXXXXXXXXXX-980-324.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1zG93LXXXXXaxXFXXXXXXXXXX-2266-190.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1CUbjLXXXXXXeXXXXXXXXXXXX-1230-130.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1S9yYLXXXXXayapXXXXXXXXXX-847-417.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1Qqe1LXXXXXckaXXXXXXXXXXX-434-214.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1LnPcLXXXXXaWXFXXXXXXXXXX-434-267.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1sXnpLXXXXXalXFXXXXXXXXXX-996-314.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1lvPfLXXXXXbXXVXXXXXXXXXX-1350-54.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1qFTqLXXXXXXZXFXXXXXXXXXX-1762-166.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB120DxLXXXXXbTXpXXXXXXXXXX-1696-60.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1QwznLXXXXXXRaXXXXXXXXXXX-998-378.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1_nDALXXXXXXYXFXXXXXXXXXX-1594-110.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1ZoYLLXXXXXcZXpXXXXXXXXXX-497-746.gif">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1J9.XLXXXXXcYaXXXXXXXXXXX-497-746.gif">
<meta property="og:updated_time" content="2016-09-15T15:18:32.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="聊聊 Android 的 Service 组件">
<meta name="twitter:description" content="Android 开发的同学都知道，Android 有四大组件，分别是 Activity、Service、BroadcastReceiver 和 ContentProvider。在这里，我想跟大家聊一聊 Service 组件，我们从头开始，包括什么是 Service？Service 有什么作用？怎么使用它？需要关注哪些性能问题？什么情况下使用它最合适？好，废话少说，马上进入主题。
直译过来，Serv">
<meta name="twitter:image" content="https://gw.alicdn.com/tps/TB1onGRLXXXXXcvXVXXXXXXXXXX-389-507.png">
  
    <link rel="alternative" href="/atom.xml" title="箫鉴哥博客" type="application/atom+xml">
  
  
    <link rel="icon" href="//favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="https://gw.alicdn.com/tps/TB1mZsZNXXXXXXDXVXXXXXXXXXX-200-200.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">箫鉴哥</a></h1>
		</hgroup>

		
		<p class="header-subtitle">如果没能一次成功，那就叫它1.0版吧</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>

				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
						<li>Über</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/">关于我</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/G96968586" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/1813501992" title="weibo">weibo</a>
					        
								<a class="mail" target="_blank" href="mailto:huijian.xhj@gmail.com" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>

				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/转载/" style="font-size: 10px;">转载</a>
					</div>
				</section>
				

				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">奥巴马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">卡卡的美丽传说</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">本泽马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">吉格斯的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">习大大大不同</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">托蒂的博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">简简单单，热爱生活和编程的技术鲜肉，理想是成为大神！</div>
				</section>
				
			</div>
		</div>
	</header>
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">箫鉴哥</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="nullhttps://gw.alicdn.com/tps/TB1mZsZNXXXXXXDXVXXXXXXXXXX-200-200.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
				
			</div>
			<hgroup>
			  <h1 class="header-author">箫鉴哥</h1>
			</hgroup>
			
			<p class="header-subtitle">如果没能一次成功，那就叫它1.0版吧</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/">关于我</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/G96968586" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/1813501992" title="weibo">weibo</a>
			        
						<a class="mail" target="_blank" href="mailto:huijian.xhj@gmail.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-聊聊-Android-的-Service-组件" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/09/15/聊聊-Android-的-Service-组件/" class="article-date">
  	<time datetime="2016-09-15T15:18:09.000Z" itemprop="datePublished">2016-09-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      聊聊 Android 的 Service 组件
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Android/">Android</a>
	</div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Android 开发的同学都知道，Android 有四大组件，分别是 <a href="https://developer.android.com/reference/android/app/Activity.html" target="_blank" rel="external">Activity</a>、<a href="https://developer.android.com/reference/android/app/Service.html" target="_blank" rel="external">Service</a>、<a href="https://developer.android.com/reference/android/content/BroadcastReceiver.html" target="_blank" rel="external">BroadcastReceiver</a> 和 <a href="https://developer.android.com/reference/android/content/ContentProvider.html" target="_blank" rel="external">ContentProvider</a>。在这里，我想跟大家聊一聊 Service 组件，我们从头开始，包括什么是 Service？Service 有什么作用？怎么使用它？需要关注哪些性能问题？什么情况下使用它最合适？好，废话少说，马上进入主题。</p>
<p>直译过来，Service 就是服务。它跟 Activity 不同，没有界面，不直接与用户进行交互，是一个可以在后台长时间运行的应用组件。服务可以由其他应用组件来启动，也可以由系统来启动。当用户从你的应用切换到其他应用后，我们的服务仍然可以在后台继续运行，甚至有些情况下，你退出了应用，服务仍能继续运行。最典型的例子就是音乐播放器了，当你退出应用后，音乐还能继续播放。又比如钉钉和微信，只要你没有在系统里禁止掉它们，即使杀掉它们的应用进程，你还是能收到别人给你发的消息。事实上，当你杀掉一个应用的进程后，该应用包括后台服务就彻底完了，只不过微信和钉钉有自启策略，又把服务拉起来了，这样你才能实时收到消息。</p>
<p>我们一般会在 Service 里做什么呢？上面刚举了一个例子，可以在 Service 里播放音乐，这样当用户手机锁屏或者按了 Home 键回到桌面，我们的音乐仍然能处于播放状态。另外，我们会常在 Service 里处理一些网络请求(如文件上传/下载等)、执行文件 I/O 或与内容提供程序(ContentProvider)交互等。</p>
<p>Service 有两种启动方式：</p>
<ul>
<li>通过 startService() 来启动</li>
<li>通过 bindService() 绑定服务启动</li>
</ul>
<p>Service 跟 Activity 一样，有它自己的生命周期。上面两种方式启动的 Service，其生命周期是有一些区别的，看下面的图：</p>
<p><img src="https://gw.alicdn.com/tps/TB1onGRLXXXXXcvXVXXXXXXXXXX-389-507.png" alt=""></p>
<p>左图是使用 startService() 所创建的服务的生命周期，右图是使用 bindService() 所创建的服务的生命周期。</p>
<p>服务的<strong>整个生命周期</strong>从调用 <code>onCreate()</code> 开始起，到 <code>onDestroy()</code> 返回时结束。与 Activity 类似，服务也在 <code>onCreate()</code> 中完成初始设置，并在<code>onDestroy()</code> 中释放所有剩余资源。例如，音乐播放服务可以在 <code>onCreate()</code> 中创建用于播放音乐的线程，然后在 <code>onDestroy()</code> 中停止该线程。无论服务是通过 <code>startService()</code> 还是 <code>bindService()</code> 创建，都会为所有服务调用 <code>onCreate()</code> 和 <code>onDestroy()</code> 方法。</p>
<p>服务的<strong>有效生命周期</strong>从调用 <code>onStartCommand()</code> 或 <code>onBind()</code> 方法开始。每种方法均有 <code>Intent</code> 对象，该对象分别传递到 <code>startService()</code> 或<code>bindService()</code>。</p>
<h4 id="startService"><a href="#startService" class="headerlink" title="startService()"></a>startService()</h4><p>下面是一个普通的 Service 例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"LocalService"</span>;</div><div class="line">    <span class="keyword">private</span> NotificationManager mNM;</div><div class="line"></div><div class="line">    <span class="comment">// Unique Identification Number for the Notification.</span></div><div class="line">    <span class="comment">// We use it on Notification start, and to cancel it.</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> NOTIFICATION = R.string.local_service_started;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Class for clients to access.  Because we know this service always</div><div class="line">     * runs in the same process as its clients, we don't need to deal with</div><div class="line">     * IPC.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalBinder</span> <span class="keyword">extends</span> <span class="title">Binder</span> </span>&#123;</div><div class="line">        <span class="function">LocalService <span class="title">getService</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> LocalService.<span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LocalService</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// This is the object that receives interactions from clients.  See</span></div><div class="line">    <span class="comment">// RemoteService for a more complete example.</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IBinder mBinder = <span class="keyword">new</span> LocalBinder();</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onBind"</span>);</div><div class="line">        <span class="keyword">return</span> mBinder;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onCreate"</span>);</div><div class="line">        mNM = (NotificationManager)getSystemService(NOTIFICATION_SERVICE);</div><div class="line"></div><div class="line">        <span class="comment">// Display a notification about us starting.  We put an icon in the status bar.</span></div><div class="line">        showNotification();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onStartCommand"</span>);</div><div class="line">        Log.i(<span class="string">"LocalService"</span>, <span class="string">"Received start id "</span> + startId + <span class="string">": "</span> + intent);</div><div class="line">        <span class="keyword">return</span> START_NOT_STICKY;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">(Intent intent, <span class="keyword">int</span> startId)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onStart"</span>);</div><div class="line">        <span class="keyword">super</span>.onStart(intent, startId);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onUnbind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onUnbind"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onUnbind(intent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onDestroy"</span>);</div><div class="line">        <span class="comment">// Cancel the persistent notification.</span></div><div class="line">        mNM.cancel(NOTIFICATION);</div><div class="line"></div><div class="line">        <span class="comment">// Tell the user we stopped.</span></div><div class="line">        Toast.makeText(<span class="keyword">this</span>, R.string.local_service_stopped, Toast.LENGTH_SHORT).show();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Show a notification while this service is running.</div><div class="line">     */</div><div class="line">    <span class="meta">@TargetApi</span>(<span class="number">16</span>)</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showNotification</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// In this sample, we'll use the same text for the ticker and the expanded notification</span></div><div class="line">        CharSequence text = getText(R.string.local_service_started);</div><div class="line"></div><div class="line">        <span class="comment">// The PendingIntent to launch our activity if the user selects this notification</span></div><div class="line">        PendingIntent contentIntent = PendingIntent.getActivity(<span class="keyword">this</span>, <span class="number">0</span>,</div><div class="line">                <span class="keyword">new</span> Intent(<span class="keyword">this</span>, OtherActivity.class), <span class="number">0</span>);</div><div class="line"></div><div class="line">        <span class="comment">// Set the info for the views that show in the notification panel.</span></div><div class="line">        Notification notification = <span class="keyword">new</span> Notification.Builder(<span class="keyword">this</span>)</div><div class="line">                .setSmallIcon(R.mipmap.ic_launcher)  <span class="comment">// the status icon</span></div><div class="line">                .setTicker(text)  <span class="comment">// the status text</span></div><div class="line">                .setWhen(System.currentTimeMillis())  <span class="comment">// the time stamp</span></div><div class="line">                .setContentTitle(getText(R.string.local_service_label))  <span class="comment">// the label of the entry</span></div><div class="line">                .setContentText(text)  <span class="comment">// the contents of the entry</span></div><div class="line">                .setContentIntent(contentIntent)  <span class="comment">// The intent to send when the entry is clicked</span></div><div class="line">                .build();</div><div class="line"></div><div class="line">        <span class="comment">// Send the notification.</span></div><div class="line">        mNM.notify(NOTIFICATION, notification);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Activity 用来启动和结束服务，具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, LocalService.class);</div><div class="line">        startService(intent);<span class="comment">// 这里我们先使用 startService 来启动服务</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, LocalService.class);</div><div class="line">        stopService(intent);<span class="comment">// 使用 startService 启动的服务，需要我们通过 stopService 来结束它</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>XML 布局代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span></span></div><div class="line">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></div><div class="line">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:paddingBottom</span>=<span class="string">"@dimen/activity_vertical_margin"</span></div><div class="line">    <span class="attr">android:paddingLeft</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></div><div class="line">    <span class="attr">android:paddingRight</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></div><div class="line">    <span class="attr">android:paddingTop</span>=<span class="string">"@dimen/activity_vertical_margin"</span></div><div class="line">    <span class="attr">tools:context</span>=<span class="string">"com.xhj.huijian.servicedemo.MainActivity"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"Hello World!"</span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/textView"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"startService"</span></div><div class="line">        <span class="attr">android:onClick</span>=<span class="string">"start"</span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/button"</span></div><div class="line">        <span class="attr">android:layout_below</span>=<span class="string">"@+id/textView"</span></div><div class="line">        <span class="attr">android:layout_alignParentLeft</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">android:layout_alignParentStart</span>=<span class="string">"true"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"stopService"</span></div><div class="line">        <span class="attr">android:onClick</span>=<span class="string">"stop"</span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/button2"</span></div><div class="line">        <span class="attr">android:layout_below</span>=<span class="string">"@+id/button"</span></div><div class="line">        <span class="attr">android:layout_alignParentLeft</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">android:layout_alignParentStart</span>=<span class="string">"true"</span>/&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>如同 Activity（以及其他组件）一样，您必须在应用的清单文件(AndroidManifest.xml)中声明所有服务。需要添加 <a href="https://developer.android.com/guide/topics/manifest/service-element.html" target="_blank" rel="external"><code>&lt;service&gt;</code></a> 元素作为 <a href="https://developer.android.com/guide/topics/manifest/application-element.html" target="_blank" rel="external"><code>&lt;application&gt;</code></a> 元素的子元素。例如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">...</span> &gt;</span></div><div class="line">  ...</div><div class="line">  <span class="tag">&lt;<span class="name">application</span> <span class="attr">...</span> &gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">".service.LocalService"</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">activity</span>&gt;</span>...<span class="tag">&lt;/<span class="name">activity</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">activity</span>&gt;</span>...<span class="tag">&lt;/<span class="name">activity</span>&gt;</span></div><div class="line">      ...</div><div class="line">  <span class="tag">&lt;/<span class="name">application</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></div></pre></td></tr></table></figure>
<p>service 标签有一些常见的选项，我在这里也跟大家罗列一下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">service</span></span></div><div class="line">            <span class="attr">android:name</span>=<span class="string">".service.LocalService"</span></div><div class="line">            <span class="attr">android:exported</span>=<span class="string">"false"</span></div><div class="line">            <span class="attr">android:enabled</span>=<span class="string">"true"</span></div><div class="line">            <span class="attr">android:label</span>=<span class="string">"@string/local_service_label"</span></div><div class="line">            <span class="attr">android:icon</span>=<span class="string">"@mipmap/ic_launcher"</span></div><div class="line">            <span class="attr">android:permission</span>=<span class="string">""</span></div><div class="line">            <span class="attr">android:process</span>=<span class="string">":process"</span>&gt;</div><div class="line">        <span class="tag">&lt;/<span class="name">service</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">android:name:　服务类名</div><div class="line">android:label: 这个属性用于设定一个要显示给用户的服务的名称。如果没有设置这个属性，则会使用&lt;application&gt;元素的label属性值来代替。</div><div class="line">android:icon: 这个属性定义了一个代表服务的图标，它必须要引用一个包含图片定义的可绘制资源。如果这个属性没有设置，则会使用&lt;application&gt;元素的icon属性所设定的图标来代替。</div><div class="line">android:permission: 申明此服务的权限，这意味着只有提供了该权限的应用才能控制或连接此服务</div><div class="line">android:process: 表示该服务是否运行在另外一个进程，如果设置了此项，那么将会在包名后面加上这段字符串表示另一进程的名字</div><div class="line">android:enabled: 这个属性用于指示该服务是否能够被实例化。如果设置为true，则能够被实例化，否则不能被实例化。默认值是true。</div><div class="line">android:exported： 表示该服务是否能够被其他应用程序所控制或连接，不设置默认此项为 false</div></pre></td></tr></table></figure>
<p>OK，大家可以看到，前面我在 LocalService 的每一个生命周期方法中都添加了 log 打印，这样方便我们在跑 demo 时看到效果。现在请先忽视 LocalBinder 这个类。当服务通过 startService 启动后，我在 onCreate() 里调用了 showNotification() 方法，这时候会在系统状态栏看到一条消息：</p>
<p><img src="https://gw.alicdn.com/tps/TB1GIa9LXXXXXXSXpXXXXXXXXXX-970-236.png" alt=""></p>
<p>如果你点击它，则会打开一个新的 Activity，简单的显示一条招呼内容：</p>
<p><img src="https://gw.alicdn.com/tps/TB1FRSPLXXXXXXYaXXXXXXXXXXX-980-324.png" alt=""></p>
<p>从前面的生命周期图中，我们可以知道，当我们启动一个服务后，它会依次调用 onCreate -&gt; onStartCommand 方法，我们看下日志输出：</p>
<p><img src="https://gw.alicdn.com/tps/TB1zG93LXXXXXaxXFXXXXXXXXXX-2266-190.png" alt=""></p>
<p>因为我在 onStartCommand 里多打印了一条 log，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Log.i(<span class="string">"LocalService"</span>, <span class="string">"Received start id "</span> + startId + <span class="string">": "</span> + intent);</div></pre></td></tr></table></figure>
<p>所以在 onStartCommand 后面多了一条日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Received start id 1: Intent &#123; cmp=com.xhj.huijian.servicedemo/.service.LocalService &#125;</div></pre></td></tr></table></figure>
<p>如果这时候，我再重新去启动这个服务，它是不会再走 onCreate 这个方法的，但会重复调用 onStartCommand 方法，从上图的日志就可以看出来啦，系统又打印了两条 log:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">07-31 01:42:11.928 11361-11361/com.xhj.huijian.servicedemo D/LocalService: onStartCommand</div><div class="line">07-31 01:42:11.928 11361-11361/com.xhj.huijian.servicedemo I/LocalService: Received start id 2: Intent &#123; cmp=com.xhj.huijian.servicedemo/.service.LocalService &#125;</div></pre></td></tr></table></figure>
<p>此时，我在主 Activity 点击了 stop 按钮结束服务，LocalService 就会调用 onDestory 方法并结束掉自己。</p>
<h4 id="bindService"><a href="#bindService" class="headerlink" title="bindService()"></a>bindService()</h4><p>现在，我们通过第二种方式 bindService()  来启动服务。首先，在主 Activity 的布局里我们添加一个 bindService 按钮，另其 android:onClick=”bind” ，并在主 Activity 实现 bind 方法，这样当你点击 bindService 按钮时 bind 方法就会被触发，这是 Android 另一种事件绑定的方式。 bindService 绑定 Service 之前，我们还需要去实现一个 ServiceConnection，它用来监视 Activity (client) 与 service 的连接状态。当创建了一个可以绑定的 service 之后，你必须提供一个 <a href="http://developer.android.com/reference/android/os/IBinder.html" target="_blank" rel="external">IBinder</a> 对象，它用来提供 Activity (client) 与service 进行交互的接口。前面我们提到的 LocalBinder 就是一个 IBinder 对象了。</p>
<p>回顾一下 LocalService ，有下面的一段代码，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Class for clients to access.  Because we know this service always</div><div class="line">     * runs in the same process as its clients, we don't need to deal with</div><div class="line">     * IPC.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalBinder</span> <span class="keyword">extends</span> <span class="title">Binder</span> </span>&#123;</div><div class="line">        <span class="function">LocalService <span class="title">getService</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> LocalService.<span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LocalService</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// This is the object that receives interactions from clients.  See</span></div><div class="line">    <span class="comment">// RemoteService for a more complete example.</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IBinder mBinder = <span class="keyword">new</span> LocalBinder();</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onBind"</span>);</div><div class="line">        <span class="keyword">return</span> mBinder;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在 onBind 方法里返回一个 IBinder 对象。</p>
<p>在 MainActivity 里实现 ServiceConnection 的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> LocalService mBoundService;</div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mIsBound = <span class="keyword">false</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> ServiceConnection mConnection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">  		<span class="comment">// 绑定成功时回调该方法</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName className, IBinder service)</span> </span>&#123;</div><div class="line">            <span class="comment">// This is called when the connection with the service has been</span></div><div class="line">            <span class="comment">// established, giving us the service object we can use to</span></div><div class="line">            <span class="comment">// interact with the service.  Because we have bound to a explicit</span></div><div class="line">            <span class="comment">// service that we know is running in our own process, we can</span></div><div class="line">            <span class="comment">// cast its IBinder to a concrete class and directly access it.</span></div><div class="line">            mBoundService = ((LocalService.LocalBinder)service).getService();</div><div class="line"></div><div class="line">            <span class="comment">// Tell the user about this for our demo.</span></div><div class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>, R.string.local_service_connected,</div><div class="line">                    Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line">		<span class="comment">// 解绑时回调该方法</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName className)</span> </span>&#123;</div><div class="line">            <span class="comment">// This is called when the connection with the service has been</span></div><div class="line">            <span class="comment">// unexpectedly disconnected -- that is, its process crashed.</span></div><div class="line">            <span class="comment">// Because it is running in our same process, we should never</span></div><div class="line">            <span class="comment">// see this happen.</span></div><div class="line">            mBoundService = <span class="keyword">null</span>;</div><div class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>, R.string.local_service_disconnected,</div><div class="line">                    Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line"><span class="comment">// 添加绑定和解绑方法</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">doBindService</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// Establish a connection with the service.  We use an explicit</span></div><div class="line">        <span class="comment">// class name because we want a specific service implementation that</span></div><div class="line">        <span class="comment">// we know will be running in our own process (and thus won't be</span></div><div class="line">        <span class="comment">// supporting component replacement by other applications).</span></div><div class="line">        bindService(<span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>,</div><div class="line">                LocalService.class), mConnection, Context.BIND_AUTO_CREATE);</div><div class="line">        mIsBound = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doUnbindService</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mIsBound) &#123;</div><div class="line">            <span class="comment">// Detach our existing connection.</span></div><div class="line">            unbindService(mConnection);</div><div class="line">            mIsBound = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="comment">// 在 bind 方法里调用 doBindService</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        doBindService();</div><div class="line">    &#125;</div><div class="line"><span class="comment">// 在 Activity 的 onDestory 方法里解绑</span></div><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        doUnbindService();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>bindService 比 startService 多了两个参数，需要传入 ServiceConnection 对象和一个绑定的选项，这里我们传入了 Context.BIND_AUTO_CREATE，表示只要有绑定存在，就自动创建服务(automatically create the service as long as the binding exists)。上面的代码，我们还在 Activity 的 onDestory 方法里调用了 doUnbindService 方法去解绑服务，事实上，当一个 client(这里指 Activity) 销毁后，即使我们没有在 onDestory 里进行解绑，被绑定的服务也会一同被销毁，因为系统会自动为我们解绑。这一点跟 startService 启动的服务不同，使用 startService 启动的服务，如果在 Activity 被销毁时没有调用 stopService()，服务还将在后台运行(如果是应用进程被杀掉，服务也就挂了)。</p>
<p>启动绑定服务并退出应用，可以看到下面的日志输出：</p>
<p><img src="https://gw.alicdn.com/tps/TB1CUbjLXXXXXXeXXXXXXXXXXXX-1230-130.png" alt=""></p>
<p>依次调用了 onCreate -&gt; onBind -&gt; onUnbind -&gt; onDestory 方法，这验证了前面说的使用 bindService 创建服务的生命周期。那如果我们重复 bindService 呢？其生命周期是否会发生改变？事实是，onCreate 和 onBind 都不会重复调用。</p>
<p>当我们需要允许组件与服务进行交互、发送请求、获取结果，甚至是利用进程间通信 (IPC) 跨进程执行这些操作时，就需要绑定服务提供一个客户端(client)-服务器(service)接口了。换句话说，通常是需要给其他程序组件提供服务时才会使用 bindService。</p>
<p>上面所说的都是本地服务(local service) ，即服务跑在应用主进程中。有本地自然就有远程啦，接下来，我们来了解远程服务 (remote service) 是什么样的。</p>
<h4 id="RemoteService-AIDL"><a href="#RemoteService-AIDL" class="headerlink" title="RemoteService(AIDL)"></a>RemoteService(AIDL)</h4><p>远程服务运行在独立的进程中，对应进程名格式为所在包名加上你指定的 android:process 字符串，前面介绍 service 标签常见选项时有提到过。比如，我有一个应用的包名是：com.example.servicedemo，我在其中一个 service 里添加了下面的属性 android:process=”:process”，这时候，这个服务就会运行在一个名叫 com.example.servicedemo:process 的进程中。由于是独立的进程，因此在 Activity 所在进程被Kill 的时候，该服务依然在运行，不受其他进程影响，有利于为多个进程提供服务具有较高的灵活性。</p>
<p>远程服务一般都是系统服务，并且都是常驻服务，Android 上第三方的消息推送服务，也都是跑在独立进程中的。</p>
<p>远程服务涉及到不同进程之间的通信(IPC，interprocess communication)，需要使用到 AIDL(Android Interface Definition Language)，用于生成可以在 Android 设备上两个进程之间进行进程间通信的代码。说到这里，你应该知道远程服务需要通过绑定来启动了。下面我们动起手，使用 AIDL 创建一个远程服务。</p>
<p>首先，我们另起一个 Android 工程 AIDLServer，用来充当跨进程通信的服务端，然后创建一个 .aidl 文件。在 AS 里创建 AIDL 很简单，在工程的 java 目录下，右键你的包名，选择 New -&gt; AIDL -&gt; AIDL File，</p>
<p><img src="https://gw.alicdn.com/tps/TB1S9yYLXXXXXayapXXXXXXXXXX-847-417.png" alt=""></p>
<p>我们将其命名为 IRemoteService，然后就会在 main 目录下出现一个 aidl 跟 java 同级别的目录，如图：</p>
<p><img src="https://gw.alicdn.com/tps/TB1Qqe1LXXXXXckaXXXXXXXXXXX-434-214.png" alt=""></p>
<p>在 IRemoteService.aidl 添加一个 getPid() 方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// IRemoteService.aidl</span></div><div class="line"><span class="keyword">package</span> com.xhj.huijian.aidlserver;</div><div class="line"></div><div class="line"><span class="comment">// Declare any non-default types here with import statements</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IRemoteService</span> </span>&#123;</div><div class="line">    <span class="comment">/** Request the process ID of this service, to do evil things with it. */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getPid</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Demonstrates some basic types that you can use as parameters</div><div class="line">     * and return values in AIDL.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat,</span></span></div><div class="line">            <span class="keyword">double</span> aDouble, String aString);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>说明一下，aidl 中支持的参数类型为：基本类型（int, long, char, boolean 等）,String, CharSequence, List, Map，其他类型必须使用 import 导入，即使它们可能在同一个包里。另外，接口中的参数除了 aidl 支持的类型，其他类型必须标识其方向：输入、输出或两者兼之，用 in，out 或者 inout 来表示，默认为 in。</p>
<p>我们可以在工程 app -&gt; build -&gt; generated -&gt; source -&gt; aidl -&gt; debug 下看到 AS 为我们自动生成了一个接口 IRemoteService，</p>
<p><img src="https://gw.alicdn.com/tps/TB1LnPcLXXXXXaWXFXXXXXXXXXX-434-267.png" alt=""></p>
<p>打开 IRemoteService 可以看到一个代理类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">xhj</span>.<span class="title">huijian</span>.<span class="title">aidlserver</span>.<span class="title">IRemoteService</span></span></div></pre></td></tr></table></figure>
<p>这个 Stub 类就是一个普通的 Binder，只不过它实现了我们定义的 aidl 接口。它还有一个静态方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Cast an IBinder object into an com.xhj.huijian.aidlserver.IRemoteService interface,</div><div class="line"> * generating a proxy if needed.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> com.xhj.huijian.aidlserver.<span class="function">IRemoteService <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span></span></div></pre></td></tr></table></figure>
<p>通过它，我们就可以在客户端中得到 IRemoteService 的实例，进而通过实例来调用其方法。现在，我们创建一个服务端的 service，在里面去实现 aidl 中的抽象函数，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"ServerService"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PACKAGE_PERMISSION = <span class="string">"com.xhj.huijian.servicedemo"</span>;</div><div class="line">    <span class="keyword">private</span> NotificationManager mNM;</div><div class="line"></div><div class="line">    <span class="comment">// Unique Identification Number for the Notification.</span></div><div class="line">    <span class="comment">// We use it on Notification start, and to cancel it.</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> NOTIFICATION = R.string.remote_service_started;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServerService</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 实现 aidl 中的抽象函数</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IRemoteService.Stub mBinder = <span class="keyword">new</span> IRemoteService.Stub() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPid</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            <span class="comment">// 这里返回进程 ID</span></div><div class="line">            <span class="keyword">return</span> Process.myPid();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat, <span class="keyword">double</span> aDouble, String aString)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            <span class="comment">// Does nothing</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 在这里可以做权限认证，return false 意味着客户端的调用就会失败，比如下面，只允许包名为 com.xhj.huijian.servicedemo 的客户端通过，</span></div><div class="line">        <span class="comment">// 其他 apk 将无法完成调用过程</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            String packageName = <span class="keyword">null</span>;</div><div class="line">            String[] packages = ServerService.<span class="keyword">this</span>.getPackageManager().</div><div class="line">                    getPackagesForUid(getCallingUid());</div><div class="line">            <span class="keyword">if</span> (packages != <span class="keyword">null</span> &amp;&amp; packages.length &gt; <span class="number">0</span>) &#123;</div><div class="line">                packageName = packages[<span class="number">0</span>];</div><div class="line">            &#125;</div><div class="line">            Log.d(TAG, <span class="string">"onTransact: "</span> + packageName);</div><div class="line">            <span class="keyword">if</span> (!PACKAGE_PERMISSION.equals(packageName)) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"remote service onCreate"</span>);</div><div class="line">        mNM = (NotificationManager)getSystemService(NOTIFICATION_SERVICE);</div><div class="line"></div><div class="line">        <span class="comment">// Display a notification about us starting.  We put an icon in the status bar.</span></div><div class="line">        showNotification();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"remote service onStartCommand"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"remote service onBind"</span>);</div><div class="line">        <span class="keyword">return</span> mBinder;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onUnbind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"remote service onUnbind"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onUnbind(intent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRebind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onRebind(intent);</div><div class="line">        Log.d(TAG, <span class="string">"remote service onRebind"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        Log.d(TAG, <span class="string">"remote service onDestroy"</span>);</div><div class="line">        <span class="comment">// Cancel the persistent notification.</span></div><div class="line">        mNM.cancel(NOTIFICATION);</div><div class="line"></div><div class="line">        <span class="comment">// Tell the user we stopped.</span></div><div class="line">        Toast.makeText(<span class="keyword">this</span>, R.string.remote_service_stopped, Toast.LENGTH_SHORT).show();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Show a notification while this service is running.</div><div class="line">     */</div><div class="line">    <span class="meta">@TargetApi</span>(<span class="number">16</span>)</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showNotification</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// In this sample, we'll use the same text for the ticker and the expanded notification</span></div><div class="line">        CharSequence text = getText(R.string.remote_service_started);</div><div class="line"></div><div class="line">        <span class="comment">// The PendingIntent to launch our activity if the user selects this notification</span></div><div class="line">        PendingIntent contentIntent = PendingIntent.getActivity(<span class="keyword">this</span>, <span class="number">0</span>,</div><div class="line">                <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MainActivity.class), <span class="number">0</span>);</div><div class="line"></div><div class="line">        <span class="comment">// Set the info for the views that show in the notification panel.</span></div><div class="line">        Notification notification = <span class="keyword">new</span> Notification.Builder(<span class="keyword">this</span>)</div><div class="line">                .setSmallIcon(R.mipmap.ic_launcher)  <span class="comment">// the status icon</span></div><div class="line">                .setTicker(text)  <span class="comment">// the status text</span></div><div class="line">                .setWhen(System.currentTimeMillis())  <span class="comment">// the time stamp</span></div><div class="line">                .setContentTitle(getText(R.string.remote_service_label))  <span class="comment">// the label of the entry</span></div><div class="line">                .setContentText(text)  <span class="comment">// the contents of the entry</span></div><div class="line">                .setContentIntent(contentIntent)  <span class="comment">// The intent to send when the entry is clicked</span></div><div class="line">                .build();</div><div class="line"></div><div class="line">        <span class="comment">// Send the notification.</span></div><div class="line">        mNM.notify(NOTIFICATION, notification);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ServerService 中 new 了一个 IRemoteService.Stub 对象，并实现了其抽象方法，然后在 onBind 方法返回给 client，这不难理解。在这里我要说的是在 IRemoteService.Stub 里被我们重写的 onTransact 方法，在该方法中可以根据调用者的 uid 来获取其信息，然后做权限认证，如果返回 true，则调用成功，否则调用会失败。这样我们的服务就可以做到只让某个特定的 apk 使用，而不是所有的 apk 都能使用。</p>
<p>接下来，在 AndroidMenifest 中声明我们的服务，</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">service</span></span></div><div class="line">           <span class="attr">android:name</span>=<span class="string">".ServerService"</span></div><div class="line">           <span class="attr">android:process</span>=<span class="string">":remote"</span></div><div class="line">           <span class="attr">android:enabled</span>=<span class="string">"true"</span></div><div class="line">           <span class="attr">android:exported</span>=<span class="string">"true"</span>&gt;</div><div class="line">           <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></div><div class="line">               <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;</span></div><div class="line">               <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"com.xhj.huijian.aidlserver.ServerService"</span> /&gt;</span></div><div class="line">           <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></div><div class="line">       <span class="tag">&lt;/<span class="name">service</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"com.xhj.huijian.aidlserver.ServerService"</span> /&gt;</span></div></pre></td></tr></table></figure>
<p>这一句是为了让其他应用通过隐式的方式来 bind 我们的 Service。通过隐式调用的方式来起 activity 或者service，需要把 category 设为 default，这是因为，隐式调用的时候，intent 中的 category 默认会被设置为default。这里需要注意的是，exported 要设置为 true，否则其他应用就绑定不了我们的服务了。</p>
<p>现在回到我们的“客户端”，第一个工程，在 MainActivity 里我们稍加一些测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="comment">// action，隐式调用</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_BIND_SERVICE = <span class="string">"com.xhj.huijian.aidlserver.ServerService"</span>;</div><div class="line"><span class="keyword">private</span> IRemoteService mIRemoteService;</div><div class="line"></div><div class="line"><span class="comment">// 远程服务 ServiceConnection</span></div><div class="line">    <span class="keyword">private</span> ServiceConnection mRemoteConnection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName componentName, IBinder iBinder)</span> </span>&#123;</div><div class="line">            mIRemoteService = IRemoteService.Stub.asInterface(iBinder);</div><div class="line">            <span class="keyword">int</span> pid = <span class="number">0</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                pid = mIRemoteService.getPid();</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            Log.d(TAG, <span class="string">"process id : "</span> + pid);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName componentName)</span> </span>&#123;</div><div class="line">            mIRemoteService = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line"><span class="comment">// 添加一个启动远程服务进程的 button，设置 onClick = bindRemoteService</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bindRemoteService</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(ACTION_BIND_SERVICE);</div><div class="line">        intent.setPackage(<span class="string">"com.xhj.huijian.aidlserver"</span>);</div><div class="line">        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</div><div class="line">        bindService(intent, mRemoteConnection, Context.BIND_AUTO_CREATE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">	    ...</div><div class="line">        <span class="keyword">if</span> (mIRemoteService != <span class="keyword">null</span>) &#123;</div><div class="line">            unbindService(mRemoteConnection);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>和前面一样，我们绑定服务前要声明一个 ServiceConnection，我们在 onServiceConnected 方法里去获取 IRemoteService 的实例，然后调用它的方法 getPid 打印出一条 log，这里需要 try catch 一下捕获异常。在写 demo 时我遇到了一个问题，原本在 bindRemoteService 里我是这样写的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bindRemoteService</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(ACTION_BIND_SERVICE);</div><div class="line">        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</div><div class="line">        bindService(intent, mRemoteConnection, Context.BIND_AUTO_CREATE);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>少了这一行代码 intent.setPackage(“com.xhj.huijian.aidlserver”); 然后在运行 demo 时发生了 crash，错误日志有这么一句，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">IllegalArgumentException: Service Intent must be explicit</div></pre></td></tr></table></figure>
<p>经查阅资料发现，在 Android 5.0 以后服务必须采用显示方式启动，刚好我的模拟器就是 5.0 的，醉了。不过，方法还是有的，就是加上那句设置应用包名的代码，这是 Google 推荐的解决方法。OK，先安装好服务端，然后打开客户端，点击绑定远程服务按钮，可以看到系统状态栏弹出了一条消息，效果图如下：</p>
<p><img src="https://gw.alicdn.com/tps/TB1sXnpLXXXXXalXFXXXXXXXXXX-996-314.png" alt=""></p>
<p>从日志可以看出，我们调用 ServerService 的 getPid 方法成功了，输出了 process id : 16822</p>
<p><img src="https://gw.alicdn.com/tps/TB1lvPfLXXXXXbXXVXXXXXXXXXX-1350-54.png" alt=""></p>
<p>下面是 ServerService 的生命周期，跟本地服务绑定的生命周期一个样。</p>
<p><img src="https://gw.alicdn.com/tps/TB1qFTqLXXXXXXZXFXXXXXXXXXX-1762-166.png" alt=""></p>
<p>如果 AIDL 所支持的参数类型不满足我们的需求，我们想传输自定义类型的对象，该怎么做呢？</p>
<p>首先，在 AIDLServer 工程新建一个 Rect.aidl (名字随便起一个) 文件，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Rect.aidl</span></div><div class="line"><span class="keyword">package</span> com.xhj.huijian.aidlserver;</div><div class="line"></div><div class="line"><span class="comment">// Declare any non-default types here with import statements</span></div><div class="line">parcelable Rect;</div></pre></td></tr></table></figure>
<p>这里 parcelable 是个类型，首字母是小写的，和 Parcelable 接口不是一个东西。</p>
<p>Rect.java 代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Rect</span> <span class="keyword">implements</span> <span class="title">Parcelable</span></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> left;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> top;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> right;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> bottom;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Rect</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Rect</span><span class="params">(Parcel in)</span> </span>&#123;</div><div class="line">        readFromParcel(in);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Creator&lt;Rect&gt; CREATOR = <span class="keyword">new</span> Creator&lt;Rect&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Rect <span class="title">createFromParcel</span><span class="params">(Parcel in)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Rect(in);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> Rect[] newArray(<span class="keyword">int</span> size) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Rect[size];</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">describeContents</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel parcel, <span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">        parcel.writeInt(left);</div><div class="line">        parcel.writeInt(top);</div><div class="line">        parcel.writeInt(right);</div><div class="line">        parcel.writeInt(bottom);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFromParcel</span><span class="params">(Parcel in)</span> </span>&#123;</div><div class="line">        left = in.readInt();</div><div class="line">        top = in.readInt();</div><div class="line">        right = in.readInt();</div><div class="line">        bottom = in.readInt();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过 AIDL 传输非基本类型的对象，被传输的对象需要序列化，Android sdk 提供了更轻量级更方便的方法，即实现 Parcelable 接口，上面就是一个去实现 Parcelable 接口的例子。你需要去实现一些抽象方法，还有 Parcelable.CREATOR 接口。</p>
<p>回到 IRemoteService.aidl，往里面添加一些代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// IRemoteService.aidl</span></div><div class="line"><span class="keyword">package</span> com.xhj.huijian.aidlserver;</div><div class="line"><span class="keyword">import</span> com.xhj.huijian.aidlserver.Rect;</div><div class="line"><span class="comment">// Declare any non-default types here with import statements</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IRemoteService</span> </span>&#123;</div><div class="line">    <span class="comment">/** Request the process ID of this service, to do evil things with it. */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getPid</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Demonstrates some basic types that you can use as parameters</div><div class="line">     * and return values in AIDL.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat,</span></span></div><div class="line">            <span class="keyword">double</span> aDouble, String aString);</div><div class="line"></div><div class="line">    List&lt;com.xhj.huijian.aidlserver.Rect&gt; getRect();</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addRect</span><span class="params">(in com.xhj.huijian.aidlserver.Rect rect)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>新增了两个方法 getRect() 和 addRect(in Rect rect)，前面提到过，除了 aidl 支持的类型外，其他类型都必须标识其方向，这里 addRect 方法参数用 in 标记，因为它是输入型参数。</p>
<p>ServerService 做了一些修改，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> List&lt;Rect&gt; mRects = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">...</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> IRemoteService.Stub mBinder = <span class="keyword">new</span> IRemoteService.Stub() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPid</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            <span class="comment">// 这里返回进程 ID</span></div><div class="line">            <span class="keyword">return</span> Process.myPid();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat, <span class="keyword">double</span> aDouble, String aString)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            <span class="comment">// Does nothing</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">  	    <span class="comment">// 实现两个新增的方法</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> List&lt;Rect&gt; <span class="title">getRect</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            <span class="keyword">synchronized</span> (mRects) &#123;</div><div class="line">                <span class="keyword">return</span> mRects;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRect</span><span class="params">(Rect rect)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            <span class="keyword">synchronized</span> (mRects) &#123;</div><div class="line">                <span class="keyword">if</span> (!mRects.contains(rect)) &#123;</div><div class="line">                    mRects.add(rect);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">...</div><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"remote service onCreate"</span>);</div><div class="line">        mNM = (NotificationManager)getSystemService(NOTIFICATION_SERVICE);</div><div class="line"></div><div class="line">        <span class="comment">// Display a notification about us starting.  We put an icon in the status bar.</span></div><div class="line">        showNotification();</div><div class="line">        <span class="comment">// 初始化一些数据</span></div><div class="line">        <span class="keyword">synchronized</span> (mRects) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</div><div class="line">                Rect rect = <span class="keyword">new</span> Rect();</div><div class="line">                rect.top = i * <span class="number">1</span>;</div><div class="line">                rect.left = i * <span class="number">2</span>;</div><div class="line">                rect.right = i * <span class="number">4</span>;</div><div class="line">                rect.bottom = i * <span class="number">8</span>;</div><div class="line">                mRects.add(rect);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>因为我们增加了两个文件，Rect.aidl 和 Rect.class，所以也需要把这个两个文件拷贝到客户端中去。把 Rect.aidl 放在跟 IRemoteService 同目录下，在客户端工程(ServiceDemo)新建一个包，名为 com.xhj.huijian.aidlserve， Rect.class 在服务端的包名一样。客户端的 MainActivity 我们也修改一下调用代码，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 远程服务 ServiceConnection</span></div><div class="line">    <span class="keyword">private</span> ServiceConnection mRemoteConnection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName componentName, IBinder iBinder)</span> </span>&#123;</div><div class="line">            mIRemoteService = IRemoteService.Stub.asInterface(iBinder);</div><div class="line">            <span class="keyword">int</span> pid = <span class="number">0</span>;</div><div class="line">            Rect rect = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                pid = mIRemoteService.getPid();</div><div class="line">                <span class="comment">// 因为第一个元素的四个属性值都是0，所以我在这里取 rect 数组的第二个元素</span></div><div class="line">                rect = mIRemoteService.getRect().get(<span class="number">1</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            Log.d(TAG, <span class="string">"process id : "</span> + pid);</div><div class="line">            Log.d(TAG, <span class="string">"rect top : "</span> + rect.top + <span class="string">" right : "</span> + rect.right + <span class="string">" left : "</span></div><div class="line">            + rect.left + <span class="string">" bottom : "</span> + rect.bottom);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName componentName)</span> </span>&#123;</div><div class="line">            mIRemoteService = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div></pre></td></tr></table></figure>
<p>OK，重新 run 一下工程，点击绑定按钮，可以看到下面的日志输出，</p>
<p><img src="https://gw.alicdn.com/tps/TB120DxLXXXXXbTXpXXXXXXXXXX-1696-60.png" alt=""></p>
<p>大功告成！是不是觉得 AIDL 实现起来稍微麻烦了些啊？反正我是觉得挺烦的，那下面就给大家介绍不用 AIDL 实现 IPC 的一个简便方法。嘿，请别喷我，这只是一个简便方法。</p>
<p>大概的思路如下：</p>
<ul>
<li>Service 实现一个 Handler 来接受 Client 的每一个 callback。</li>
<li>这个 Handler 用来创建 Messenger 对象。</li>
<li>Messenger 创建一个 IBinder 对象，Service 在 onBind 方法里面把这个对象返回给客户端。</li>
<li>客户端使用这个 IBinder 对象来实例化 Messenger (that references the service’s Handler), 然后客户端使用这个 messager 再发送 message 对象给 service。</li>
<li>Service 在它的 handler 里面接收到每一个 Message。</li>
</ul>
<p>直接上代码，代码演示了 client 和 service 怎么进行交互的。</p>
<p>Service 代码(AIDLServer)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"MessageService"</span>;</div><div class="line">    <span class="comment">/** For showing and hiding our notification. */</span></div><div class="line">    NotificationManager mNM;</div><div class="line">    <span class="comment">/** Keeps track of all current registered clients. */</span></div><div class="line">    ArrayList&lt;Messenger&gt; mClients = <span class="keyword">new</span> ArrayList&lt;Messenger&gt;();</div><div class="line">    <span class="comment">/** Holds last value set by a client. */</span></div><div class="line">    <span class="keyword">int</span> mValue = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Command to the service to register a client, receiving callbacks</div><div class="line">     * from the service.  The Message's replyTo field must be a Messenger of</div><div class="line">     * the client where callbacks should be sent.</div><div class="line">     */</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_REGISTER_CLIENT = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Command to the service to unregister a client, ot stop receiving callbacks</div><div class="line">     * from the service.  The Message's replyTo field must be a Messenger of</div><div class="line">     * the client as previously given with MSG_REGISTER_CLIENT.</div><div class="line">     */</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_UNREGISTER_CLIENT = <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Command to service to set a new value.  This can be sent to the</div><div class="line">     * service to supply a new value, and will be sent by the service to</div><div class="line">     * any registered clients with the new value.</div><div class="line">     */</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SET_VALUE = <span class="number">3</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Handler of incoming messages from clients.</div><div class="line">     */</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">IncomingHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">                <span class="keyword">case</span> MSG_REGISTER_CLIENT:</div><div class="line">                    mClients.add(msg.replyTo);</div><div class="line">                    Log.d(TAG, <span class="string">"register_client"</span>);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> MSG_UNREGISTER_CLIENT:</div><div class="line">                    mClients.remove(msg.replyTo);</div><div class="line">                    Log.d(TAG, <span class="string">"unregister_client"</span>);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> MSG_SET_VALUE:</div><div class="line">                    Log.d(TAG, <span class="string">"set_value"</span>);</div><div class="line">                    mValue = msg.arg1;</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = mClients.size()-<span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            mClients.get(i).send(Message.obtain(<span class="keyword">null</span>,</div><div class="line">                                    MSG_SET_VALUE, mValue, <span class="number">0</span>));</div><div class="line">                        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                            <span class="comment">// The client is dead.  Remove it from the list;</span></div><div class="line">                            <span class="comment">// we are going through the list from back to front</span></div><div class="line">                            <span class="comment">// so this is safe to do inside the loop.</span></div><div class="line">                            mClients.remove(i);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">super</span>.handleMessage(msg);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Target we publish for clients to send messages to IncomingHandler.</div><div class="line">     */</div><div class="line">    <span class="keyword">final</span> Messenger mMessenger = <span class="keyword">new</span> Messenger(<span class="keyword">new</span> IncomingHandler());</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MessageService</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        mNM = (NotificationManager)getSystemService(NOTIFICATION_SERVICE);</div><div class="line">        <span class="comment">// Display a notification about us starting.</span></div><div class="line">        showNotification();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        <span class="comment">// Cancel the persistent notification.</span></div><div class="line">        mNM.cancel(R.string.remote_service_started);</div><div class="line">        <span class="comment">// Tell the user we stopped.</span></div><div class="line">        Toast.makeText(<span class="keyword">this</span>, R.string.remote_service_stopped, Toast.LENGTH_SHORT).show();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * When binding to the service, we return an interface to our messenger</div><div class="line">     * for sending messages to the service.</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mMessenger.getBinder();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Show a notification while this service is running.</div><div class="line">     */</div><div class="line">    <span class="meta">@TargetApi</span>(<span class="number">16</span>)</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showNotification</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// In this sample, we'll use the same text for the ticker and the expanded notification</span></div><div class="line">        CharSequence text = getText(R.string.remote_service_started);</div><div class="line">        <span class="comment">// The PendingIntent to launch our activity if the user selects this notification</span></div><div class="line">        PendingIntent contentIntent = PendingIntent.getActivity(<span class="keyword">this</span>, <span class="number">0</span>,</div><div class="line">                <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MainActivity.class), <span class="number">0</span>);</div><div class="line">        <span class="comment">// Set the info for the views that show in the notification panel.</span></div><div class="line">        Notification notification = <span class="keyword">new</span> Notification.Builder(<span class="keyword">this</span>)</div><div class="line">                .setSmallIcon(R.mipmap.ic_launcher)  <span class="comment">// the status icon</span></div><div class="line">                .setTicker(text)  <span class="comment">// the status text</span></div><div class="line">                .setWhen(System.currentTimeMillis())  <span class="comment">// the time stamp</span></div><div class="line">                .setContentTitle(getText(R.string.remote_service_label))  <span class="comment">// the label of the entry</span></div><div class="line">                .setContentText(text)  <span class="comment">// the contents of the entry</span></div><div class="line">                .setContentIntent(contentIntent)  <span class="comment">// The intent to send when the entry is clicked</span></div><div class="line">                .build();</div><div class="line">        <span class="comment">// Send the notification.</span></div><div class="line">        <span class="comment">// We use a string id because it is a unique number.  We use it later to cancel.</span></div><div class="line">        mNM.notify(R.string.remote_service_started, notification);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 AndroidManifest 中注册，</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">service</span></span></div><div class="line">            <span class="attr">android:name</span>=<span class="string">".MessageService"</span></div><div class="line">            <span class="attr">android:enabled</span>=<span class="string">"true"</span></div><div class="line">            <span class="attr">android:exported</span>=<span class="string">"true"</span></div><div class="line">            <span class="attr">android:process</span>=<span class="string">":remote_msg"</span>&gt;</div><div class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"com.xhj.huijian.aidlserver.MessageService"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">service</span>&gt;</span></div></pre></td></tr></table></figure>
<p>在客户端工程新建一个 MessageActivity，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageServiceActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_BIND_SERVICE = <span class="string">"com.xhj.huijian.aidlserver.MessageService"</span>;</div><div class="line">    <span class="comment">/** Messenger for communicating with service. */</span></div><div class="line">    Messenger mService = <span class="keyword">null</span>;</div><div class="line">    <span class="comment">/** Flag indicating whether we have called bind on the service. */</span></div><div class="line">    <span class="keyword">boolean</span> mIsBound;</div><div class="line">    <span class="comment">/** Some text view we are using to show state information. */</span></div><div class="line">    TextView mCallbackText;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Command to the service to register a client, receiving callbacks</div><div class="line">     * from the service.  The Message's replyTo field must be a Messenger of</div><div class="line">     * the client where callbacks should be sent.</div><div class="line">     */</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_REGISTER_CLIENT = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Command to the service to unregister a client, ot stop receiving callbacks</div><div class="line">     * from the service.  The Message's replyTo field must be a Messenger of</div><div class="line">     * the client as previously given with MSG_REGISTER_CLIENT.</div><div class="line">     */</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_UNREGISTER_CLIENT = <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Command to service to set a new value.  This can be sent to the</div><div class="line">     * service to supply a new value, and will be sent by the service to</div><div class="line">     * any registered clients with the new value.</div><div class="line">     */</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SET_VALUE = <span class="number">3</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Handler of incoming messages from service.</div><div class="line">     */</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">IncomingHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">                <span class="keyword">case</span> MessageServiceActivity.MSG_SET_VALUE:</div><div class="line">                    mCallbackText.setText(<span class="string">"Received from service: "</span> + msg.arg1);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">super</span>.handleMessage(msg);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Target we publish for clients to send messages to IncomingHandler.</div><div class="line">     */</div><div class="line">    <span class="keyword">final</span> Messenger mMessenger = <span class="keyword">new</span> Messenger(<span class="keyword">new</span> IncomingHandler());</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ServiceConnection mConnection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName componentName, IBinder iBinder)</span> </span>&#123;</div><div class="line">            <span class="comment">// This is called when the connection with the service has been</span></div><div class="line">            <span class="comment">// established, giving us the service object we can use to</span></div><div class="line">            <span class="comment">// interact with the service.  We are communicating with our</span></div><div class="line">            <span class="comment">// service through an IDL interface, so get a client-side</span></div><div class="line">            <span class="comment">// representation of that from the raw service object.</span></div><div class="line">            mService = <span class="keyword">new</span> Messenger(iBinder);</div><div class="line">            mCallbackText.setText(<span class="string">"Attached."</span>);</div><div class="line"></div><div class="line">            Message msg = Message.obtain(<span class="keyword">null</span>, MSG_REGISTER_CLIENT);</div><div class="line">            msg.replyTo = mMessenger;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                mService.send(msg);</div><div class="line">                msg = Message.obtain(<span class="keyword">null</span>, MSG_SET_VALUE, <span class="keyword">this</span>.hashCode(), <span class="number">0</span>);</div><div class="line">                mService.send(msg);</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                <span class="comment">// In this case the service has crashed before we could even</span></div><div class="line">                <span class="comment">// do anything with it; we can count on soon being</span></div><div class="line">                <span class="comment">// disconnected (and then reconnected if it can be restarted)</span></div><div class="line">                <span class="comment">// so there is no need to do anything here.</span></div><div class="line">            &#125;</div><div class="line">            <span class="comment">// As part of the sample, tell the user what happened.</span></div><div class="line">            Toast.makeText(MessageServiceActivity.<span class="keyword">this</span>, R.string.remote_service_connected,</div><div class="line">                    Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName componentName)</span> </span>&#123;</div><div class="line">            <span class="comment">// This is called when the connection with the service has been</span></div><div class="line">            <span class="comment">// unexpectedly disconnected -- that is, its process crashed.</span></div><div class="line">            mService = <span class="keyword">null</span>;</div><div class="line">            mCallbackText.setText(<span class="string">"Disconnected."</span>);</div><div class="line"></div><div class="line">            <span class="comment">// As part of the sample, tell the user what happened.</span></div><div class="line">            Toast.makeText(MessageServiceActivity.<span class="keyword">this</span>, R.string.remote_service_disconnected,</div><div class="line">                    Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_message_service);</div><div class="line">        <span class="comment">// Watch for button clicks.</span></div><div class="line">        Button button = (Button)findViewById(R.id.bind);</div><div class="line">        button.setOnClickListener(mBindListener);</div><div class="line">        button = (Button)findViewById(R.id.unbind);</div><div class="line">        button.setOnClickListener(mUnbindListener);</div><div class="line"></div><div class="line">        mCallbackText = (TextView)findViewById(R.id.callback);</div><div class="line">        mCallbackText.setText(<span class="string">"Not attached."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doBindService</span><span class="params">()</span> </span>&#123;</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(ACTION_BIND_SERVICE);</div><div class="line">        intent.setPackage(<span class="string">"com.xhj.huijian.aidlserver"</span>);</div><div class="line">        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</div><div class="line">        bindService(intent, mConnection, Context.BIND_AUTO_CREATE);</div><div class="line">        mIsBound = <span class="keyword">true</span>;</div><div class="line">        mCallbackText.setText(<span class="string">"Binding."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doUnbindService</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mIsBound) &#123;</div><div class="line">            <span class="comment">// If we have received the service, and hence registered with</span></div><div class="line">            <span class="comment">// it, then now is the time to unregister.</span></div><div class="line">            <span class="keyword">if</span> (mService != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Message msg = Message.obtain(<span class="keyword">null</span>, MSG_UNREGISTER_CLIENT);</div><div class="line">                    msg.replyTo = mMessenger;</div><div class="line">                    mService.send(msg);</div><div class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                    <span class="comment">// There is nothing special we need to do if the service</span></div><div class="line">                    <span class="comment">// has crashed.</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Detach our existing connection.</span></div><div class="line">            unbindService(mConnection);</div><div class="line">            mIsBound = <span class="keyword">false</span>;</div><div class="line">            mCallbackText.setText(<span class="string">"Unbinding."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> View.OnClickListener mBindListener = <span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">            doBindService();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> View.OnClickListener mUnbindListener = <span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">            doUnbindService();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码我就不再解释了，我贴下运行效果截图，</p>
<p><img src="https://gw.alicdn.com/tps/TB1QwznLXXXXXXRaXXXXXXXXXXX-998-378.png" alt=""></p>
<p>已经收到来自 service 的消息啦，哈哈，从日志也可以看出我们已经成功访问了，</p>
<p><img src="https://gw.alicdn.com/tps/TB1_nDALXXXXXXYXFXXXXXXXXXX-1594-110.png" alt=""></p>
<h4 id="IntentService"><a href="#IntentService" class="headerlink" title="IntentService"></a>IntentService</h4><p>刚开始学习 Android 开发时，常听人这么说，为了避免在 UI 线程上做耗时的操作所带来的 ANR(Application Not Responding)，可以把耗时的任务都放在 service 里去。其实这句话是不对的，在 service 里做耗时的操作同样也会带来 ANR。所以，你应该在 service 里开启子线程来执行耗时的任务。事实上，你不用自己那么麻烦地去创建一个 service，然后还要去管理 Service 的生命周期以及子线程。Android SDK 给你提供了一个叫 <strong>IntentService</strong> 的服务，它是 service 的子类，使用工作线程逐一处理所有启动请求。如果您不要求服务同时处理多个请求，这是最好的选择。 您只需实现 <code>onHandleIntent()</code> 方法即可，该方法会接收每个启动请求的 Intent，使你能够执行后台工作。</p>
<p>在 IntentService 内维护着一个工作线程来处理耗时操作，启动 IntentService 的方式和启动传统 Service 一样，同时，当任务执行完后，IntentService 会自动停止，而不需要我们去手动控制。另外， IntentService 可以启动多次，而每一个耗时操作会以工作队列的方式在IntentService 的 onHandleIntent 回调方法中执行，并且，每次只会执行一个工作线程，执行完第一个再执行第二个，以此类推。</p>
<p>而且，所有请求都在一个单线程中，不会阻塞应用程序的主线程（UI 线程），同一时间只处理一个请求。</p>
<p>综述，使用 IntentService 至少会给我们带来两个好处，一方面不需要自己去创建和管理子线程了；另一方面不需要考虑在什么时候关闭 Service 了。</p>
<p>下面，我们通过一个例子来学习 IntentService 的使用。IntentService 是一个抽象类，我们需要去实现它的 onHandleIntent 方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UploadService</span> <span class="keyword">extends</span> <span class="title">IntentService</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"UploadService"</span>;</div><div class="line">    <span class="comment">// IntentService can perform, e.g. ACTION_FETCH_NEW_ITEMS</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_UPLOAD = <span class="string">"com.xhj.huijian.servicedemo.service.action.UPLOAD"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXTRA_IMG_PATH = <span class="string">"com.xhj.huijian.servicedemo.service.extra.IMG_PATH"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UploadService</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(<span class="string">"UploadService"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onHandleIntent</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">final</span> String action = intent.getAction();</div><div class="line">            <span class="keyword">if</span> (ACTION_UPLOAD.equals(action)) &#123;</div><div class="line">                <span class="keyword">final</span> String path = intent.getStringExtra(EXTRA_IMG_PATH);</div><div class="line">                handleUploadImg(path);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleUploadImg</span><span class="params">(String path)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//模拟上传耗时</span></div><div class="line">            Thread.sleep(<span class="number">2000</span>);</div><div class="line"></div><div class="line">            Intent intent = <span class="keyword">new</span> Intent(MainActivity.UPLOAD_RESULT);</div><div class="line">            intent.putExtra(EXTRA_IMG_PATH, path);</div><div class="line">            sendBroadcast(intent);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        Log.d(TAG, <span class="string">"onCreate"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        Log.d(TAG, <span class="string">"onDestroy"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>UploadService 是一个模拟上传图片的服务，代码很简单，不做过多的解释啦，看下 MainActivity 的代码，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">private</span> BroadcastReceiver uploadImgReceiver = <span class="keyword">new</span> BroadcastReceiver() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (intent.getAction().equals(UPLOAD_RESULT)) &#123;</div><div class="line">                String path = intent.getStringExtra(UploadService.EXTRA_IMG_PATH);</div><div class="line">                uploadResult(path);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">uploadResult</span><span class="params">(String path)</span> </span>&#123;</div><div class="line">        TextView tv = (TextView) mContainer.findViewWithTag(path);</div><div class="line">        tv.setText(path + <span class="string">" upload complete "</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>广播用来监听服务发送的消息，收到消息后修改页面上的控件内容，同步上传状态。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startIntentService</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        String path = <span class="string">"/sdcard/images/"</span> + (++img) + <span class="string">".jpg"</span>;</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, UploadService.class);</div><div class="line">        intent.setAction(UploadService.ACTION_UPLOAD);</div><div class="line">        intent.putExtra(UploadService.EXTRA_IMG_PATH, path);</div><div class="line">        startService(intent);</div><div class="line"></div><div class="line">        TextView tv = <span class="keyword">new</span> TextView(<span class="keyword">this</span>);</div><div class="line">        mContainer.addView(tv);</div><div class="line">        tv.setText(path + <span class="string">" is uploading ..."</span>);</div><div class="line">        tv.setTag(path);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>上面是启动一个服务区下载图片，同时在页面上添加一个 TextView 用于显示上传状态。下面代码展示了广播的注册和注销，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        mContainer = (LinearLayout) findViewById(R.id.container);</div><div class="line">        <span class="comment">// 注册广播</span></div><div class="line">        IntentFilter filter = <span class="keyword">new</span> IntentFilter();</div><div class="line">        filter.addAction(UPLOAD_RESULT);</div><div class="line">        registerReceiver(uploadImgReceiver, filter);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">super</span>.onDestroy();</div><div class="line">       ...</div><div class="line">       <span class="comment">// 注销广播</span></div><div class="line">       unregisterReceiver(uploadImgReceiver);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>OK, Run 一下 demo，看下效果图：</p>
<p><img src="https://gw.alicdn.com/tps/TB1ZoYLLXXXXXcZXpXXXXXXXXXX-497-746.gif" alt=""></p>
<h4 id="扩展-Service-类"><a href="#扩展-Service-类" class="headerlink" title="扩展 Service 类"></a>扩展 Service 类</h4><p>上面所述，使用 IntentService 简化了启动服务的实现。但是，若要求服务执行多线程（而不是通过工作队列处理启动请求），则可扩展 service 类来处理每个 Intent。</p>
<p>下面我们创建一个并发处理多线程的 service，我们将其命名为 MultiThreadingService 吧，具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiThreadingService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Looper mServiceLooper;</div><div class="line">    <span class="keyword">private</span> ServiceHandler mServiceHandler;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_MULTI_UPLOAD = <span class="string">"com.xhj.huijian.servicedemo.service.action.MULTI_UPLOAD"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXTRA_IMG_PATH = <span class="string">"com.xhj.huijian.servicedemo.service.extra.IMG_PATH"</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Handler that receives messages from the thread</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ServiceHandler</span><span class="params">(Looper looper)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(looper);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">//模拟上传耗时</span></div><div class="line">                Thread.sleep(((<span class="keyword">int</span>)(<span class="number">1</span> + Math.random() * <span class="number">3</span>)) * <span class="number">1000</span>);</div><div class="line"></div><div class="line">                Intent intent = <span class="keyword">new</span> Intent(MainActivity.UPLOAD_RESULT);</div><div class="line">                intent.putExtra(EXTRA_IMG_PATH, (String) msg.obj);</div><div class="line">                sendBroadcast(intent);</div><div class="line">                stopSelf(msg.arg1);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MultiThreadingService</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// Start up the thread running the service.  Note that we create a</span></div><div class="line">        <span class="comment">// separate thread because the service normally runs in the process's</span></div><div class="line">        <span class="comment">// main thread, which we don't want to block.  We also make it</span></div><div class="line">        <span class="comment">// background priority so CPU-intensive work will not disrupt our UI.</span></div><div class="line">        HandlerThread thread = <span class="keyword">new</span> HandlerThread(<span class="string">"ServiceStartArguments"</span>,</div><div class="line">                Process.THREAD_PRIORITY_BACKGROUND);</div><div class="line">        thread.start();</div><div class="line"></div><div class="line">        <span class="comment">// Get the HandlerThread's Looper and use it for our Handler</span></div><div class="line">        mServiceLooper = thread.getLooper();</div><div class="line">        mServiceHandler = <span class="keyword">new</span> ServiceHandler(mServiceLooper);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">final</span> <span class="keyword">int</span> startId)</span> </span>&#123;</div><div class="line">        Toast.makeText(MultiThreadingService.<span class="keyword">this</span>, <span class="string">"多线程服务启动"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">final</span> String action = intent.getAction();</div><div class="line">            <span class="keyword">if</span> (TextUtils.equals(action, ACTION_MULTI_UPLOAD)) &#123;</div><div class="line">                <span class="keyword">final</span> String path = intent.getStringExtra(EXTRA_IMG_PATH);</div><div class="line">                <span class="comment">// 取消下面的注释, 然后注销掉下面的 Thread,该服务的作用就跟 UploadService 一样了</span></div><div class="line"><span class="comment">//                Message msg = mServiceHandler.obtainMessage();</span></div><div class="line"><span class="comment">//                msg.arg1 = startId;</span></div><div class="line"><span class="comment">//                msg.obj = path;</span></div><div class="line"><span class="comment">//                mServiceHandler.sendMessage(msg);</span></div><div class="line"></div><div class="line">                <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            <span class="comment">//模拟上传耗时</span></div><div class="line">                            Thread.sleep(((<span class="keyword">int</span>)(<span class="number">1</span> + Math.random() * <span class="number">3</span>)) * <span class="number">1000</span>);</div><div class="line"></div><div class="line">                            Intent intent = <span class="keyword">new</span> Intent(MainActivity.UPLOAD_RESULT);</div><div class="line">                            intent.putExtra(EXTRA_IMG_PATH, path);</div><div class="line">                            sendBroadcast(intent);</div><div class="line">                            stopSelf(startId);</div><div class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                            e.printStackTrace();</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;).start();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// If we get killed, after returning from here, restart</span></div><div class="line">        <span class="keyword">return</span> START_STICKY;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        Toast.makeText(MultiThreadingService.<span class="keyword">this</span>, <span class="string">"多线程服务结束"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为我们自己处理了 <code>onStartCommand()</code> 的每个调用，因此可以同时执行多个请求。Activity 的代码我就不贴出来了，大家看下 demo 吧，运行上面的代码，随便点击几下 “MultiService” 按钮，就可以看到下图的效果了，</p>
<p><img src="https://gw.alicdn.com/tps/TB1J9.XLXXXXXcYaXXXXXXXXXXX-497-746.gif" alt=""></p>
<p>可以看出已经是并发线程下载了。</p>
<h4 id="前台服务"><a href="#前台服务" class="headerlink" title="前台服务"></a>前台服务</h4><p>前台服务被认为是用户主动意识到的一种服务，因此在内存不足时，系统也不会考虑将其终止。前台服务必须为状态栏提供通知，状态栏位于“正在进行”标题下方，这意味着除非服务停止或从前台删除，否则不能清除通知。这个例子最好举了，当你打开音乐播放器时，你的手机状态栏上面是有一个通知，并且你手动去滑动是滑不掉的。</p>
<p>要请求让服务运行于前台，请调用 <code>startForeground()</code>。此方法取两个参数：唯一标识通知的整型数和状态栏的 <code>Notification</code>。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Notification notification = <span class="keyword">new</span> Notification(R.drawable.icon, getText(R.string.ticker_text),</div><div class="line">        System.currentTimeMillis());</div><div class="line">Intent notificationIntent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, ExampleActivity.class);</div><div class="line">PendingIntent pendingIntent = PendingIntent.getActivity(<span class="keyword">this</span>, <span class="number">0</span>, notificationIntent, <span class="number">0</span>);</div><div class="line">notification.setLatestEventInfo(<span class="keyword">this</span>, getText(R.string.notification_title),</div><div class="line">        getText(R.string.notification_message), pendingIntent);</div><div class="line">startForeground(ONGOING_NOTIFICATION_ID, notification);<span class="comment">// 提供给 startForeground() 的整型 ID 不得为 0</span></div></pre></td></tr></table></figure>
<p>要从前台删除服务，请调用 <code>stopForeground()</code>。此方法取一个布尔值，指示是否也删除状态栏通知。 此方法绝对不会停止服务。 但是，如果您在服务正在前台运行时将其停止，则通知也会被删除。</p>
<h4 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h4><p>写这篇文章的原因，一是作为自己对 service 组件的理解和应用做一次较全面的总结，二是帮助 Android 新人对 service 组件的学习有一个比较深刻的了解，三是方便自己遗忘，可以回头来查阅。上面较多的例子来自 Google 官方文档，所以你也能看到很多的英文注释，原本想把英文注释去掉，太占篇幅了，但后面发现，很多的英文注释可以帮助你理解代码为什么要这么写，因为注释很容易看，所以也不句句翻译了。当然，我也阅读了很多国内其他博主写的很好的博文，借鉴了他们的一些例子，之所以这么做，是怕自己个人的理解有些偏差，自己举例的代码不够好，误导大家。篇幅这么长，肯定有疏漏的地方，还请各位指出。</p>
<p><a href="http://download.csdn.net/detail/g96968586/9596505" target="_blank" rel="external">附件 demo</a></p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/09/15/JavaScript-客户端检测技术学习分享/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          JavaScript  客户端检测技术学习分享
        
      </div>
    </a>
  
  
    <a href="/2016/09/15/Android-音频技术开发总结/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Android 音频技术开发总结</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">Share to: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
    <a class="jiathis_button_twitter"></a>
    <a class="jiathis_button_plus"></a> 
    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="聊聊-Android-的-Service-组件" data-title="聊聊 Android 的 Service 组件" data-url="http://G96968586.github.io/2016/09/15/聊聊-Android-的-Service-组件/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"huijian"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 箫鉴哥
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: /
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>