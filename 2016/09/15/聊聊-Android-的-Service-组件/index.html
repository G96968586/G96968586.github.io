<!DOCTYPE html>
<html lang="">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="聊聊 Android 的 Service 组件"/>








  <link rel="alternate" href="/atom.xml" title="箫鉴哥">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="http://G96968586.github.io/2016/09/15/聊聊-Android-的-Service-组件/"/>


<meta name="description" content="Android 开发的同学都知道，Android 有四大组件，分别是 Activity、Service、BroadcastReceiver 和 ContentProvider。在这里，我想跟大家聊一聊 Service 组件，我们从头开始，包括什么是 Service？Service 有什么作用？怎么使用它？需要关注哪些性能问题？什么情况下使用它最合适？好，废话少说，马上进入主题。">
<meta property="og:type" content="article">
<meta property="og:title" content="聊聊 Android 的 Service 组件">
<meta property="og:url" content="http://G96968586.github.io/2016/09/15/聊聊-Android-的-Service-组件/index.html">
<meta property="og:site_name" content="箫鉴哥">
<meta property="og:description" content="Android 开发的同学都知道，Android 有四大组件，分别是 Activity、Service、BroadcastReceiver 和 ContentProvider。在这里，我想跟大家聊一聊 Service 组件，我们从头开始，包括什么是 Service？Service 有什么作用？怎么使用它？需要关注哪些性能问题？什么情况下使用它最合适？好，废话少说，马上进入主题。">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1onGRLXXXXXcvXVXXXXXXXXXX-389-507.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1GIa9LXXXXXXSXpXXXXXXXXXX-970-236.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1FRSPLXXXXXXYaXXXXXXXXXXX-980-324.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1zG93LXXXXXaxXFXXXXXXXXXX-2266-190.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1CUbjLXXXXXXeXXXXXXXXXXXX-1230-130.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1S9yYLXXXXXayapXXXXXXXXXX-847-417.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1Qqe1LXXXXXckaXXXXXXXXXXX-434-214.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1LnPcLXXXXXaWXFXXXXXXXXXX-434-267.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1sXnpLXXXXXalXFXXXXXXXXXX-996-314.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1lvPfLXXXXXbXXVXXXXXXXXXX-1350-54.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1qFTqLXXXXXXZXFXXXXXXXXXX-1762-166.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB120DxLXXXXXbTXpXXXXXXXXXX-1696-60.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1QwznLXXXXXXRaXXXXXXXXXXX-998-378.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1_nDALXXXXXXYXFXXXXXXXXXX-1594-110.png">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1ZoYLLXXXXXcZXpXXXXXXXXXX-497-746.gif">
<meta property="og:image" content="https://gw.alicdn.com/tps/TB1J9.XLXXXXXcYaXXXXXXXXXXX-497-746.gif">
<meta property="og:updated_time" content="2018-05-02T12:38:45.139Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="聊聊 Android 的 Service 组件">
<meta name="twitter:description" content="Android 开发的同学都知道，Android 有四大组件，分别是 Activity、Service、BroadcastReceiver 和 ContentProvider。在这里，我想跟大家聊一聊 Service 组件，我们从头开始，包括什么是 Service？Service 有什么作用？怎么使用它？需要关注哪些性能问题？什么情况下使用它最合适？好，废话少说，马上进入主题。">
<meta name="twitter:image" content="https://gw.alicdn.com/tps/TB1onGRLXXXXXcvXVXXXXXXXXXX-389-507.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> 聊聊 Android 的 Service 组件 - 箫鉴哥 </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">箫鉴哥</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          聊聊 Android 的 Service 组件
        
      </h1>

      <time class="post-time">
          Sep 15 2016
      </time>
    </header>



    
            <div class="post-content">
            <p>Android 开发的同学都知道，Android 有四大组件，分别是 <a href="https://developer.android.com/reference/android/app/Activity.html" target="_blank" rel="noopener">Activity</a>、<a href="https://developer.android.com/reference/android/app/Service.html" target="_blank" rel="noopener">Service</a>、<a href="https://developer.android.com/reference/android/content/BroadcastReceiver.html" target="_blank" rel="noopener">BroadcastReceiver</a> 和 <a href="https://developer.android.com/reference/android/content/ContentProvider.html" target="_blank" rel="noopener">ContentProvider</a>。在这里，我想跟大家聊一聊 Service 组件，我们从头开始，包括什么是 Service？Service 有什么作用？怎么使用它？需要关注哪些性能问题？什么情况下使用它最合适？好，废话少说，马上进入主题。<br><a id="more"></a></p>
<p>直译过来，Service 就是服务。它跟 Activity 不同，没有界面，不直接与用户进行交互，是一个可以在后台长时间运行的应用组件。服务可以由其他应用组件来启动，也可以由系统来启动。当用户从你的应用切换到其他应用后，我们的服务仍然可以在后台继续运行，甚至有些情况下，你退出了应用，服务仍能继续运行。最典型的例子就是音乐播放器了，当你退出应用后，音乐还能继续播放。又比如钉钉和微信，只要你没有在系统里禁止掉它们，即使杀掉它们的应用进程，你还是能收到别人给你发的消息。事实上，当你杀掉一个应用的进程后，该应用包括后台服务就彻底完了，只不过微信和钉钉有自启策略，又把服务拉起来了，这样你才能实时收到消息。</p>
<p>我们一般会在 Service 里做什么呢？上面刚举了一个例子，可以在 Service 里播放音乐，这样当用户手机锁屏或者按了 Home 键回到桌面，我们的音乐仍然能处于播放状态。另外，我们会常在 Service 里处理一些网络请求(如文件上传/下载等)、执行文件 I/O 或与内容提供程序(ContentProvider)交互等。</p>
<p>Service 有两种启动方式：</p>
<ul>
<li>通过 startService() 来启动</li>
<li>通过 bindService() 绑定服务启动</li>
</ul>
<p>Service 跟 Activity 一样，有它自己的生命周期。上面两种方式启动的 Service，其生命周期是有一些区别的，看下面的图：</p>
<p><img src="https://gw.alicdn.com/tps/TB1onGRLXXXXXcvXVXXXXXXXXXX-389-507.png" alt=""></p>
<p>左图是使用 startService() 所创建的服务的生命周期，右图是使用 bindService() 所创建的服务的生命周期。</p>
<p>服务的<strong>整个生命周期</strong>从调用 <code>onCreate()</code> 开始起，到 <code>onDestroy()</code> 返回时结束。与 Activity 类似，服务也在 <code>onCreate()</code> 中完成初始设置，并在<code>onDestroy()</code> 中释放所有剩余资源。例如，音乐播放服务可以在 <code>onCreate()</code> 中创建用于播放音乐的线程，然后在 <code>onDestroy()</code> 中停止该线程。无论服务是通过 <code>startService()</code> 还是 <code>bindService()</code> 创建，都会为所有服务调用 <code>onCreate()</code> 和 <code>onDestroy()</code> 方法。</p>
<p>服务的<strong>有效生命周期</strong>从调用 <code>onStartCommand()</code> 或 <code>onBind()</code> 方法开始。每种方法均有 <code>Intent</code> 对象，该对象分别传递到 <code>startService()</code> 或<code>bindService()</code>。</p>
<h4 id="startService"><a href="#startService" class="headerlink" title="startService()"></a>startService()</h4><p>下面是一个普通的 Service 例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"LocalService"</span>;</span><br><span class="line">    <span class="keyword">private</span> NotificationManager mNM;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Unique Identification Number for the Notification.</span></span><br><span class="line">    <span class="comment">// We use it on Notification start, and to cancel it.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> NOTIFICATION = R.string.local_service_started;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Class for clients to access.  Because we know this service always</span></span><br><span class="line"><span class="comment">     * runs in the same process as its clients, we don't need to deal with</span></span><br><span class="line"><span class="comment">     * IPC.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalBinder</span> <span class="keyword">extends</span> <span class="title">Binder</span> </span>&#123;</span><br><span class="line">        <span class="function">LocalService <span class="title">getService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> LocalService.<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LocalService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is the object that receives interactions from clients.  See</span></span><br><span class="line">    <span class="comment">// RemoteService for a more complete example.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IBinder mBinder = <span class="keyword">new</span> LocalBinder();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"onBind"</span>);</span><br><span class="line">        <span class="keyword">return</span> mBinder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"onCreate"</span>);</span><br><span class="line">        mNM = (NotificationManager)getSystemService(NOTIFICATION_SERVICE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Display a notification about us starting.  We put an icon in the status bar.</span></span><br><span class="line">        showNotification();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"onStartCommand"</span>);</span><br><span class="line">        Log.i(<span class="string">"LocalService"</span>, <span class="string">"Received start id "</span> + startId + <span class="string">": "</span> + intent);</span><br><span class="line">        <span class="keyword">return</span> START_NOT_STICKY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">(Intent intent, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"onStart"</span>);</span><br><span class="line">        <span class="keyword">super</span>.onStart(intent, startId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onUnbind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"onUnbind"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onUnbind(intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"onDestroy"</span>);</span><br><span class="line">        <span class="comment">// Cancel the persistent notification.</span></span><br><span class="line">        mNM.cancel(NOTIFICATION);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Tell the user we stopped.</span></span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, R.string.local_service_stopped, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Show a notification while this service is running.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TargetApi</span>(<span class="number">16</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showNotification</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// In this sample, we'll use the same text for the ticker and the expanded notification</span></span><br><span class="line">        CharSequence text = getText(R.string.local_service_started);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The PendingIntent to launch our activity if the user selects this notification</span></span><br><span class="line">        PendingIntent contentIntent = PendingIntent.getActivity(<span class="keyword">this</span>, <span class="number">0</span>,</span><br><span class="line">                <span class="keyword">new</span> Intent(<span class="keyword">this</span>, OtherActivity.class), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set the info for the views that show in the notification panel.</span></span><br><span class="line">        Notification notification = <span class="keyword">new</span> Notification.Builder(<span class="keyword">this</span>)</span><br><span class="line">                .setSmallIcon(R.mipmap.ic_launcher)  <span class="comment">// the status icon</span></span><br><span class="line">                .setTicker(text)  <span class="comment">// the status text</span></span><br><span class="line">                .setWhen(System.currentTimeMillis())  <span class="comment">// the time stamp</span></span><br><span class="line">                .setContentTitle(getText(R.string.local_service_label))  <span class="comment">// the label of the entry</span></span><br><span class="line">                .setContentText(text)  <span class="comment">// the contents of the entry</span></span><br><span class="line">                .setContentIntent(contentIntent)  <span class="comment">// The intent to send when the entry is clicked</span></span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Send the notification.</span></span><br><span class="line">        mNM.notify(NOTIFICATION, notification);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Activity 用来启动和结束服务，具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, LocalService.class);</span><br><span class="line">        startService(intent);<span class="comment">// 这里我们先使用 startService 来启动服务</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, LocalService.class);</span><br><span class="line">        stopService(intent);<span class="comment">// 使用 startService 启动的服务，需要我们通过 stopService 来结束它</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>XML 布局代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:paddingBottom</span>=<span class="string">"@dimen/activity_vertical_margin"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:paddingLeft</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:paddingRight</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:paddingTop</span>=<span class="string">"@dimen/activity_vertical_margin"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">"com.xhj.huijian.servicedemo.MainActivity"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"Hello World!"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/textView"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"startService"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:onClick</span>=<span class="string">"start"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/button"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_below</span>=<span class="string">"@+id/textView"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_alignParentLeft</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_alignParentStart</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"stopService"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:onClick</span>=<span class="string">"stop"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/button2"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_below</span>=<span class="string">"@+id/button"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_alignParentLeft</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_alignParentStart</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如同 Activity（以及其他组件）一样，您必须在应用的清单文件(AndroidManifest.xml)中声明所有服务。需要添加 <a href="https://developer.android.com/guide/topics/manifest/service-element.html" target="_blank" rel="noopener"><code>&lt;service&gt;</code></a> 元素作为 <a href="https://developer.android.com/guide/topics/manifest/application-element.html" target="_blank" rel="noopener"><code>&lt;application&gt;</code></a> 元素的子元素。例如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">...</span> &gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">application</span> <span class="attr">...</span> &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">".service.LocalService"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">activity</span>&gt;</span>...<span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">activity</span>&gt;</span>...<span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">      ...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>service 标签有一些常见的选项，我在这里也跟大家罗列一下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">".service.LocalService"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:enabled</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:label</span>=<span class="string">"@string/local_service_label"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:icon</span>=<span class="string">"@mipmap/ic_launcher"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:permission</span>=<span class="string">""</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:process</span>=<span class="string">":process"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">android:name:　服务类名</span><br><span class="line">android:label: 这个属性用于设定一个要显示给用户的服务的名称。如果没有设置这个属性，则会使用&lt;application&gt;元素的label属性值来代替。</span><br><span class="line">android:icon: 这个属性定义了一个代表服务的图标，它必须要引用一个包含图片定义的可绘制资源。如果这个属性没有设置，则会使用&lt;application&gt;元素的icon属性所设定的图标来代替。</span><br><span class="line">android:permission: 申明此服务的权限，这意味着只有提供了该权限的应用才能控制或连接此服务</span><br><span class="line">android:process: 表示该服务是否运行在另外一个进程，如果设置了此项，那么将会在包名后面加上这段字符串表示另一进程的名字</span><br><span class="line">android:enabled: 这个属性用于指示该服务是否能够被实例化。如果设置为true，则能够被实例化，否则不能被实例化。默认值是true。</span><br><span class="line">android:exported： 表示该服务是否能够被其他应用程序所控制或连接，不设置默认此项为 false</span><br></pre></td></tr></table></figure>
<p>OK，大家可以看到，前面我在 LocalService 的每一个生命周期方法中都添加了 log 打印，这样方便我们在跑 demo 时看到效果。现在请先忽视 LocalBinder 这个类。当服务通过 startService 启动后，我在 onCreate() 里调用了 showNotification() 方法，这时候会在系统状态栏看到一条消息：</p>
<p><img src="https://gw.alicdn.com/tps/TB1GIa9LXXXXXXSXpXXXXXXXXXX-970-236.png" alt=""></p>
<p>如果你点击它，则会打开一个新的 Activity，简单的显示一条招呼内容：</p>
<p><img src="https://gw.alicdn.com/tps/TB1FRSPLXXXXXXYaXXXXXXXXXXX-980-324.png" alt=""></p>
<p>从前面的生命周期图中，我们可以知道，当我们启动一个服务后，它会依次调用 onCreate -&gt; onStartCommand 方法，我们看下日志输出：</p>
<p><img src="https://gw.alicdn.com/tps/TB1zG93LXXXXXaxXFXXXXXXXXXX-2266-190.png" alt=""></p>
<p>因为我在 onStartCommand 里多打印了一条 log，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Log.i(<span class="string">"LocalService"</span>, <span class="string">"Received start id "</span> + startId + <span class="string">": "</span> + intent);</span><br></pre></td></tr></table></figure>
<p>所以在 onStartCommand 后面多了一条日志：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Received start id 1: Intent &#123; cmp=com.xhj.huijian.servicedemo/.service.LocalService &#125;</span><br></pre></td></tr></table></figure>
<p>如果这时候，我再重新去启动这个服务，它是不会再走 onCreate 这个方法的，但会重复调用 onStartCommand 方法，从上图的日志就可以看出来啦，系统又打印了两条 log:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">07-31 01:42:11.928 11361-11361/com.xhj.huijian.servicedemo D/LocalService: onStartCommand</span><br><span class="line">07-31 01:42:11.928 11361-11361/com.xhj.huijian.servicedemo I/LocalService: Received start id 2: Intent &#123; cmp=com.xhj.huijian.servicedemo/.service.LocalService &#125;</span><br></pre></td></tr></table></figure>
<p>此时，我在主 Activity 点击了 stop 按钮结束服务，LocalService 就会调用 onDestory 方法并结束掉自己。</p>
<h4 id="bindService"><a href="#bindService" class="headerlink" title="bindService()"></a>bindService()</h4><p>现在，我们通过第二种方式 bindService()  来启动服务。首先，在主 Activity 的布局里我们添加一个 bindService 按钮，另其 android:onClick=”bind” ，并在主 Activity 实现 bind 方法，这样当你点击 bindService 按钮时 bind 方法就会被触发，这是 Android 另一种事件绑定的方式。 bindService 绑定 Service 之前，我们还需要去实现一个 ServiceConnection，它用来监视 Activity (client) 与 service 的连接状态。当创建了一个可以绑定的 service 之后，你必须提供一个 <a href="http://developer.android.com/reference/android/os/IBinder.html" target="_blank" rel="noopener">IBinder</a> 对象，它用来提供 Activity (client) 与service 进行交互的接口。前面我们提到的 LocalBinder 就是一个 IBinder 对象了。</p>
<p>回顾一下 LocalService ，有下面的一段代码，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Class for clients to access.  Because we know this service always</span></span><br><span class="line"><span class="comment">     * runs in the same process as its clients, we don't need to deal with</span></span><br><span class="line"><span class="comment">     * IPC.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalBinder</span> <span class="keyword">extends</span> <span class="title">Binder</span> </span>&#123;</span><br><span class="line">        <span class="function">LocalService <span class="title">getService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> LocalService.<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LocalService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is the object that receives interactions from clients.  See</span></span><br><span class="line">    <span class="comment">// RemoteService for a more complete example.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IBinder mBinder = <span class="keyword">new</span> LocalBinder();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"onBind"</span>);</span><br><span class="line">        <span class="keyword">return</span> mBinder;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在 onBind 方法里返回一个 IBinder 对象。</p>
<p>在 MainActivity 里实现 ServiceConnection 的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> LocalService mBoundService;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mIsBound = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ServiceConnection mConnection = <span class="keyword">new</span> ServiceConnection() &#123;</span><br><span class="line">  		<span class="comment">// 绑定成功时回调该方法</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName className, IBinder service)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// This is called when the connection with the service has been</span></span><br><span class="line">            <span class="comment">// established, giving us the service object we can use to</span></span><br><span class="line">            <span class="comment">// interact with the service.  Because we have bound to a explicit</span></span><br><span class="line">            <span class="comment">// service that we know is running in our own process, we can</span></span><br><span class="line">            <span class="comment">// cast its IBinder to a concrete class and directly access it.</span></span><br><span class="line">            mBoundService = ((LocalService.LocalBinder)service).getService();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Tell the user about this for our demo.</span></span><br><span class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>, R.string.local_service_connected,</span><br><span class="line">                    Toast.LENGTH_SHORT).show();</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// 解绑时回调该方法</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName className)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// This is called when the connection with the service has been</span></span><br><span class="line">            <span class="comment">// unexpectedly disconnected -- that is, its process crashed.</span></span><br><span class="line">            <span class="comment">// Because it is running in our same process, we should never</span></span><br><span class="line">            <span class="comment">// see this happen.</span></span><br><span class="line">            mBoundService = <span class="keyword">null</span>;</span><br><span class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>, R.string.local_service_disconnected,</span><br><span class="line">                    Toast.LENGTH_SHORT).show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加绑定和解绑方法</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doBindService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Establish a connection with the service.  We use an explicit</span></span><br><span class="line">        <span class="comment">// class name because we want a specific service implementation that</span></span><br><span class="line">        <span class="comment">// we know will be running in our own process (and thus won't be</span></span><br><span class="line">        <span class="comment">// supporting component replacement by other applications).</span></span><br><span class="line">        bindService(<span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>,</span><br><span class="line">                LocalService.class), mConnection, Context.BIND_AUTO_CREATE);</span><br><span class="line">        mIsBound = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doUnbindService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mIsBound) &#123;</span><br><span class="line">            <span class="comment">// Detach our existing connection.</span></span><br><span class="line">            unbindService(mConnection);</span><br><span class="line">            mIsBound = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 bind 方法里调用 doBindService</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        doBindService();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 在 Activity 的 onDestory 方法里解绑</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        doUnbindService();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>bindService 比 startService 多了两个参数，需要传入 ServiceConnection 对象和一个绑定的选项，这里我们传入了 Context.BIND_AUTO_CREATE，表示只要有绑定存在，就自动创建服务(automatically create the service as long as the binding exists)。上面的代码，我们还在 Activity 的 onDestory 方法里调用了 doUnbindService 方法去解绑服务，事实上，当一个 client(这里指 Activity) 销毁后，即使我们没有在 onDestory 里进行解绑，被绑定的服务也会一同被销毁，因为系统会自动为我们解绑。这一点跟 startService 启动的服务不同，使用 startService 启动的服务，如果在 Activity 被销毁时没有调用 stopService()，服务还将在后台运行(如果是应用进程被杀掉，服务也就挂了)。</p>
<p>启动绑定服务并退出应用，可以看到下面的日志输出：</p>
<p><img src="https://gw.alicdn.com/tps/TB1CUbjLXXXXXXeXXXXXXXXXXXX-1230-130.png" alt=""></p>
<p>依次调用了 onCreate -&gt; onBind -&gt; onUnbind -&gt; onDestory 方法，这验证了前面说的使用 bindService 创建服务的生命周期。那如果我们重复 bindService 呢？其生命周期是否会发生改变？事实是，onCreate 和 onBind 都不会重复调用。</p>
<p>当我们需要允许组件与服务进行交互、发送请求、获取结果，甚至是利用进程间通信 (IPC) 跨进程执行这些操作时，就需要绑定服务提供一个客户端(client)-服务器(service)接口了。换句话说，通常是需要给其他程序组件提供服务时才会使用 bindService。</p>
<p>上面所说的都是本地服务(local service) ，即服务跑在应用主进程中。有本地自然就有远程啦，接下来，我们来了解远程服务 (remote service) 是什么样的。</p>
<h4 id="RemoteService-AIDL"><a href="#RemoteService-AIDL" class="headerlink" title="RemoteService(AIDL)"></a>RemoteService(AIDL)</h4><p>远程服务运行在独立的进程中，对应进程名格式为所在包名加上你指定的 android:process 字符串，前面介绍 service 标签常见选项时有提到过。比如，我有一个应用的包名是：com.example.servicedemo，我在其中一个 service 里添加了下面的属性 android:process=”:process”，这时候，这个服务就会运行在一个名叫 com.example.servicedemo:process 的进程中。由于是独立的进程，因此在 Activity 所在进程被Kill 的时候，该服务依然在运行，不受其他进程影响，有利于为多个进程提供服务具有较高的灵活性。</p>
<p>远程服务一般都是系统服务，并且都是常驻服务，Android 上第三方的消息推送服务，也都是跑在独立进程中的。</p>
<p>远程服务涉及到不同进程之间的通信(IPC，interprocess communication)，需要使用到 AIDL(Android Interface Definition Language)，用于生成可以在 Android 设备上两个进程之间进行进程间通信的代码。说到这里，你应该知道远程服务需要通过绑定来启动了。下面我们动起手，使用 AIDL 创建一个远程服务。</p>
<p>首先，我们另起一个 Android 工程 AIDLServer，用来充当跨进程通信的服务端，然后创建一个 .aidl 文件。在 AS 里创建 AIDL 很简单，在工程的 java 目录下，右键你的包名，选择 New -&gt; AIDL -&gt; AIDL File，</p>
<p><img src="https://gw.alicdn.com/tps/TB1S9yYLXXXXXayapXXXXXXXXXX-847-417.png" alt=""></p>
<p>我们将其命名为 IRemoteService，然后就会在 main 目录下出现一个 aidl 跟 java 同级别的目录，如图：</p>
<p><img src="https://gw.alicdn.com/tps/TB1Qqe1LXXXXXckaXXXXXXXXXXX-434-214.png" alt=""></p>
<p>在 IRemoteService.aidl 添加一个 getPid() 方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IRemoteService.aidl</span></span><br><span class="line"><span class="keyword">package</span> com.xhj.huijian.aidlserver;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Declare any non-default types here with import statements</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IRemoteService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** Request the process ID of this service, to do evil things with it. */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getPid</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Demonstrates some basic types that you can use as parameters</span></span><br><span class="line"><span class="comment">     * and return values in AIDL.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">double</span> aDouble, String aString)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明一下，aidl 中支持的参数类型为：基本类型（int, long, char, boolean 等）,String, CharSequence, List, Map，其他类型必须使用 import 导入，即使它们可能在同一个包里。另外，接口中的参数除了 aidl 支持的类型，其他类型必须标识其方向：输入、输出或两者兼之，用 in，out 或者 inout 来表示，默认为 in。</p>
<p>我们可以在工程 app -&gt; build -&gt; generated -&gt; source -&gt; aidl -&gt; debug 下看到 AS 为我们自动生成了一个接口 IRemoteService，</p>
<p><img src="https://gw.alicdn.com/tps/TB1LnPcLXXXXXaWXFXXXXXXXXXX-434-267.png" alt=""></p>
<p>打开 IRemoteService 可以看到一个代理类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">xhj</span>.<span class="title">huijian</span>.<span class="title">aidlserver</span>.<span class="title">IRemoteService</span></span></span><br></pre></td></tr></table></figure>
<p>这个 Stub 类就是一个普通的 Binder，只不过它实现了我们定义的 aidl 接口。它还有一个静态方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Cast an IBinder object into an com.xhj.huijian.aidlserver.IRemoteService interface,</span></span><br><span class="line"><span class="comment"> * generating a proxy if needed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> com.xhj.huijian.aidlserver.<span class="function">IRemoteService <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span></span></span><br></pre></td></tr></table></figure>
<p>通过它，我们就可以在客户端中得到 IRemoteService 的实例，进而通过实例来调用其方法。现在，我们创建一个服务端的 service，在里面去实现 aidl 中的抽象函数，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"ServerService"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PACKAGE_PERMISSION = <span class="string">"com.xhj.huijian.servicedemo"</span>;</span><br><span class="line">    <span class="keyword">private</span> NotificationManager mNM;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Unique Identification Number for the Notification.</span></span><br><span class="line">    <span class="comment">// We use it on Notification start, and to cancel it.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> NOTIFICATION = R.string.remote_service_started;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServerService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 实现 aidl 中的抽象函数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IRemoteService.Stub mBinder = <span class="keyword">new</span> IRemoteService.Stub() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPid</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="comment">// 这里返回进程 ID</span></span><br><span class="line">            <span class="keyword">return</span> Process.myPid();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat, <span class="keyword">double</span> aDouble, String aString)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="comment">// Does nothing</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在这里可以做权限认证，return false 意味着客户端的调用就会失败，比如下面，只允许包名为 com.xhj.huijian.servicedemo 的客户端通过，</span></span><br><span class="line">        <span class="comment">// 其他 apk 将无法完成调用过程</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            String packageName = <span class="keyword">null</span>;</span><br><span class="line">            String[] packages = ServerService.<span class="keyword">this</span>.getPackageManager().</span><br><span class="line">                    getPackagesForUid(getCallingUid());</span><br><span class="line">            <span class="keyword">if</span> (packages != <span class="keyword">null</span> &amp;&amp; packages.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                packageName = packages[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            Log.d(TAG, <span class="string">"onTransact: "</span> + packageName);</span><br><span class="line">            <span class="keyword">if</span> (!PACKAGE_PERMISSION.equals(packageName)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"remote service onCreate"</span>);</span><br><span class="line">        mNM = (NotificationManager)getSystemService(NOTIFICATION_SERVICE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Display a notification about us starting.  We put an icon in the status bar.</span></span><br><span class="line">        showNotification();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"remote service onStartCommand"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"remote service onBind"</span>);</span><br><span class="line">        <span class="keyword">return</span> mBinder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onUnbind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"remote service onUnbind"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onUnbind(intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRebind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onRebind(intent);</span><br><span class="line">        Log.d(TAG, <span class="string">"remote service onRebind"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        Log.d(TAG, <span class="string">"remote service onDestroy"</span>);</span><br><span class="line">        <span class="comment">// Cancel the persistent notification.</span></span><br><span class="line">        mNM.cancel(NOTIFICATION);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Tell the user we stopped.</span></span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, R.string.remote_service_stopped, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Show a notification while this service is running.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TargetApi</span>(<span class="number">16</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showNotification</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// In this sample, we'll use the same text for the ticker and the expanded notification</span></span><br><span class="line">        CharSequence text = getText(R.string.remote_service_started);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The PendingIntent to launch our activity if the user selects this notification</span></span><br><span class="line">        PendingIntent contentIntent = PendingIntent.getActivity(<span class="keyword">this</span>, <span class="number">0</span>,</span><br><span class="line">                <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MainActivity.class), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set the info for the views that show in the notification panel.</span></span><br><span class="line">        Notification notification = <span class="keyword">new</span> Notification.Builder(<span class="keyword">this</span>)</span><br><span class="line">                .setSmallIcon(R.mipmap.ic_launcher)  <span class="comment">// the status icon</span></span><br><span class="line">                .setTicker(text)  <span class="comment">// the status text</span></span><br><span class="line">                .setWhen(System.currentTimeMillis())  <span class="comment">// the time stamp</span></span><br><span class="line">                .setContentTitle(getText(R.string.remote_service_label))  <span class="comment">// the label of the entry</span></span><br><span class="line">                .setContentText(text)  <span class="comment">// the contents of the entry</span></span><br><span class="line">                .setContentIntent(contentIntent)  <span class="comment">// The intent to send when the entry is clicked</span></span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Send the notification.</span></span><br><span class="line">        mNM.notify(NOTIFICATION, notification);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ServerService 中 new 了一个 IRemoteService.Stub 对象，并实现了其抽象方法，然后在 onBind 方法返回给 client，这不难理解。在这里我要说的是在 IRemoteService.Stub 里被我们重写的 onTransact 方法，在该方法中可以根据调用者的 uid 来获取其信息，然后做权限认证，如果返回 true，则调用成功，否则调用会失败。这样我们的服务就可以做到只让某个特定的 apk 使用，而不是所有的 apk 都能使用。</p>
<p>接下来，在 AndroidMenifest 中声明我们的服务，</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:name</span>=<span class="string">".ServerService"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:process</span>=<span class="string">":remote"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:enabled</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:exported</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"com.xhj.huijian.aidlserver.ServerService"</span> /&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"com.xhj.huijian.aidlserver.ServerService"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>这一句是为了让其他应用通过隐式的方式来 bind 我们的 Service。通过隐式调用的方式来起 activity 或者service，需要把 category 设为 default，这是因为，隐式调用的时候，intent 中的 category 默认会被设置为default。这里需要注意的是，exported 要设置为 true，否则其他应用就绑定不了我们的服务了。</p>
<p>现在回到我们的“客户端”，第一个工程，在 MainActivity 里我们稍加一些测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">// action，隐式调用</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_BIND_SERVICE = <span class="string">"com.xhj.huijian.aidlserver.ServerService"</span>;</span><br><span class="line"><span class="keyword">private</span> IRemoteService mIRemoteService;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 远程服务 ServiceConnection</span></span><br><span class="line">    <span class="keyword">private</span> ServiceConnection mRemoteConnection = <span class="keyword">new</span> ServiceConnection() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName componentName, IBinder iBinder)</span> </span>&#123;</span><br><span class="line">            mIRemoteService = IRemoteService.Stub.asInterface(iBinder);</span><br><span class="line">            <span class="keyword">int</span> pid = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                pid = mIRemoteService.getPid();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            Log.d(TAG, <span class="string">"process id : "</span> + pid);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName componentName)</span> </span>&#123;</span><br><span class="line">            mIRemoteService = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加一个启动远程服务进程的 button，设置 onClick = bindRemoteService</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bindRemoteService</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(ACTION_BIND_SERVICE);</span><br><span class="line">        intent.setPackage(<span class="string">"com.xhj.huijian.aidlserver"</span>);</span><br><span class="line">        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">        bindService(intent, mRemoteConnection, Context.BIND_AUTO_CREATE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">	    ...</span><br><span class="line">        <span class="keyword">if</span> (mIRemoteService != <span class="keyword">null</span>) &#123;</span><br><span class="line">            unbindService(mRemoteConnection);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>和前面一样，我们绑定服务前要声明一个 ServiceConnection，我们在 onServiceConnected 方法里去获取 IRemoteService 的实例，然后调用它的方法 getPid 打印出一条 log，这里需要 try catch 一下捕获异常。在写 demo 时我遇到了一个问题，原本在 bindRemoteService 里我是这样写的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bindRemoteService</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(ACTION_BIND_SERVICE);</span><br><span class="line">        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">        bindService(intent, mRemoteConnection, Context.BIND_AUTO_CREATE);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>少了这一行代码 intent.setPackage(“com.xhj.huijian.aidlserver”); 然后在运行 demo 时发生了 crash，错误日志有这么一句，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IllegalArgumentException: Service Intent must be explicit</span><br></pre></td></tr></table></figure>
<p>经查阅资料发现，在 Android 5.0 以后服务必须采用显示方式启动，刚好我的模拟器就是 5.0 的，醉了。不过，方法还是有的，就是加上那句设置应用包名的代码，这是 Google 推荐的解决方法。OK，先安装好服务端，然后打开客户端，点击绑定远程服务按钮，可以看到系统状态栏弹出了一条消息，效果图如下：</p>
<p><img src="https://gw.alicdn.com/tps/TB1sXnpLXXXXXalXFXXXXXXXXXX-996-314.png" alt=""></p>
<p>从日志可以看出，我们调用 ServerService 的 getPid 方法成功了，输出了 process id : 16822</p>
<p><img src="https://gw.alicdn.com/tps/TB1lvPfLXXXXXbXXVXXXXXXXXXX-1350-54.png" alt=""></p>
<p>下面是 ServerService 的生命周期，跟本地服务绑定的生命周期一个样。</p>
<p><img src="https://gw.alicdn.com/tps/TB1qFTqLXXXXXXZXFXXXXXXXXXX-1762-166.png" alt=""></p>
<p>如果 AIDL 所支持的参数类型不满足我们的需求，我们想传输自定义类型的对象，该怎么做呢？</p>
<p>首先，在 AIDLServer 工程新建一个 Rect.aidl (名字随便起一个) 文件，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Rect.aidl</span></span><br><span class="line"><span class="keyword">package</span> com.xhj.huijian.aidlserver;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Declare any non-default types here with import statements</span></span><br><span class="line">parcelable Rect;</span><br></pre></td></tr></table></figure>
<p>这里 parcelable 是个类型，首字母是小写的，和 Parcelable 接口不是一个东西。</p>
<p>Rect.java 代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Rect</span> <span class="keyword">implements</span> <span class="title">Parcelable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> left;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> top;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> right;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> bottom;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Rect</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Rect</span><span class="params">(Parcel in)</span> </span>&#123;</span><br><span class="line">        readFromParcel(in);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Creator&lt;Rect&gt; CREATOR = <span class="keyword">new</span> Creator&lt;Rect&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Rect <span class="title">createFromParcel</span><span class="params">(Parcel in)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Rect(in);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Rect[] newArray(<span class="keyword">int</span> size) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Rect[size];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">describeContents</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel parcel, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        parcel.writeInt(left);</span><br><span class="line">        parcel.writeInt(top);</span><br><span class="line">        parcel.writeInt(right);</span><br><span class="line">        parcel.writeInt(bottom);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFromParcel</span><span class="params">(Parcel in)</span> </span>&#123;</span><br><span class="line">        left = in.readInt();</span><br><span class="line">        top = in.readInt();</span><br><span class="line">        right = in.readInt();</span><br><span class="line">        bottom = in.readInt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 AIDL 传输非基本类型的对象，被传输的对象需要序列化，Android sdk 提供了更轻量级更方便的方法，即实现 Parcelable 接口，上面就是一个去实现 Parcelable 接口的例子。你需要去实现一些抽象方法，还有 Parcelable.CREATOR 接口。</p>
<p>回到 IRemoteService.aidl，往里面添加一些代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IRemoteService.aidl</span></span><br><span class="line"><span class="keyword">package</span> com.xhj.huijian.aidlserver;</span><br><span class="line"><span class="keyword">import</span> com.xhj.huijian.aidlserver.Rect;</span><br><span class="line"><span class="comment">// Declare any non-default types here with import statements</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IRemoteService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** Request the process ID of this service, to do evil things with it. */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getPid</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Demonstrates some basic types that you can use as parameters</span></span><br><span class="line"><span class="comment">     * and return values in AIDL.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">double</span> aDouble, String aString)</span></span>;</span><br><span class="line"></span><br><span class="line">    List&lt;com.xhj.huijian.aidlserver.Rect&gt; getRect();</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addRect</span><span class="params">(in com.xhj.huijian.aidlserver.Rect rect)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新增了两个方法 getRect() 和 addRect(in Rect rect)，前面提到过，除了 aidl 支持的类型外，其他类型都必须标识其方向，这里 addRect 方法参数用 in 标记，因为它是输入型参数。</p>
<p>ServerService 做了一些修改，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;Rect&gt; mRects = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">...</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> IRemoteService.Stub mBinder = <span class="keyword">new</span> IRemoteService.Stub() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPid</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="comment">// 这里返回进程 ID</span></span><br><span class="line">            <span class="keyword">return</span> Process.myPid();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat, <span class="keyword">double</span> aDouble, String aString)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="comment">// Does nothing</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">  	    <span class="comment">// 实现两个新增的方法</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;Rect&gt; <span class="title">getRect</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mRects) &#123;</span><br><span class="line">                <span class="keyword">return</span> mRects;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRect</span><span class="params">(Rect rect)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mRects) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mRects.contains(rect)) &#123;</span><br><span class="line">                    mRects.add(rect);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">...</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"remote service onCreate"</span>);</span><br><span class="line">        mNM = (NotificationManager)getSystemService(NOTIFICATION_SERVICE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Display a notification about us starting.  We put an icon in the status bar.</span></span><br><span class="line">        showNotification();</span><br><span class="line">        <span class="comment">// 初始化一些数据</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mRects) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                Rect rect = <span class="keyword">new</span> Rect();</span><br><span class="line">                rect.top = i * <span class="number">1</span>;</span><br><span class="line">                rect.left = i * <span class="number">2</span>;</span><br><span class="line">                rect.right = i * <span class="number">4</span>;</span><br><span class="line">                rect.bottom = i * <span class="number">8</span>;</span><br><span class="line">                mRects.add(rect);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>因为我们增加了两个文件，Rect.aidl 和 Rect.class，所以也需要把这个两个文件拷贝到客户端中去。把 Rect.aidl 放在跟 IRemoteService 同目录下，在客户端工程(ServiceDemo)新建一个包，名为 com.xhj.huijian.aidlserve， Rect.class 在服务端的包名一样。客户端的 MainActivity 我们也修改一下调用代码，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 远程服务 ServiceConnection</span></span><br><span class="line">    <span class="keyword">private</span> ServiceConnection mRemoteConnection = <span class="keyword">new</span> ServiceConnection() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName componentName, IBinder iBinder)</span> </span>&#123;</span><br><span class="line">            mIRemoteService = IRemoteService.Stub.asInterface(iBinder);</span><br><span class="line">            <span class="keyword">int</span> pid = <span class="number">0</span>;</span><br><span class="line">            Rect rect = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                pid = mIRemoteService.getPid();</span><br><span class="line">                <span class="comment">// 因为第一个元素的四个属性值都是0，所以我在这里取 rect 数组的第二个元素</span></span><br><span class="line">                rect = mIRemoteService.getRect().get(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            Log.d(TAG, <span class="string">"process id : "</span> + pid);</span><br><span class="line">            Log.d(TAG, <span class="string">"rect top : "</span> + rect.top + <span class="string">" right : "</span> + rect.right + <span class="string">" left : "</span></span><br><span class="line">            + rect.left + <span class="string">" bottom : "</span> + rect.bottom);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName componentName)</span> </span>&#123;</span><br><span class="line">            mIRemoteService = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<p>OK，重新 run 一下工程，点击绑定按钮，可以看到下面的日志输出，</p>
<p><img src="https://gw.alicdn.com/tps/TB120DxLXXXXXbTXpXXXXXXXXXX-1696-60.png" alt=""></p>
<p>大功告成！是不是觉得 AIDL 实现起来稍微麻烦了些啊？反正我是觉得挺烦的，那下面就给大家介绍不用 AIDL 实现 IPC 的一个简便方法。嘿，请别喷我，这只是一个简便方法。</p>
<p>大概的思路如下：</p>
<ul>
<li>Service 实现一个 Handler 来接受 Client 的每一个 callback。</li>
<li>这个 Handler 用来创建 Messenger 对象。</li>
<li>Messenger 创建一个 IBinder 对象，Service 在 onBind 方法里面把这个对象返回给客户端。</li>
<li>客户端使用这个 IBinder 对象来实例化 Messenger (that references the service’s Handler), 然后客户端使用这个 messager 再发送 message 对象给 service。</li>
<li>Service 在它的 handler 里面接收到每一个 Message。</li>
</ul>
<p>直接上代码，代码演示了 client 和 service 怎么进行交互的。</p>
<p>Service 代码(AIDLServer)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"MessageService"</span>;</span><br><span class="line">    <span class="comment">/** For showing and hiding our notification. */</span></span><br><span class="line">    NotificationManager mNM;</span><br><span class="line">    <span class="comment">/** Keeps track of all current registered clients. */</span></span><br><span class="line">    ArrayList&lt;Messenger&gt; mClients = <span class="keyword">new</span> ArrayList&lt;Messenger&gt;();</span><br><span class="line">    <span class="comment">/** Holds last value set by a client. */</span></span><br><span class="line">    <span class="keyword">int</span> mValue = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Command to the service to register a client, receiving callbacks</span></span><br><span class="line"><span class="comment">     * from the service.  The Message's replyTo field must be a Messenger of</span></span><br><span class="line"><span class="comment">     * the client where callbacks should be sent.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_REGISTER_CLIENT = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Command to the service to unregister a client, ot stop receiving callbacks</span></span><br><span class="line"><span class="comment">     * from the service.  The Message's replyTo field must be a Messenger of</span></span><br><span class="line"><span class="comment">     * the client as previously given with MSG_REGISTER_CLIENT.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_UNREGISTER_CLIENT = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Command to service to set a new value.  This can be sent to the</span></span><br><span class="line"><span class="comment">     * service to supply a new value, and will be sent by the service to</span></span><br><span class="line"><span class="comment">     * any registered clients with the new value.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SET_VALUE = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handler of incoming messages from clients.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">IncomingHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">                <span class="keyword">case</span> MSG_REGISTER_CLIENT:</span><br><span class="line">                    mClients.add(msg.replyTo);</span><br><span class="line">                    Log.d(TAG, <span class="string">"register_client"</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> MSG_UNREGISTER_CLIENT:</span><br><span class="line">                    mClients.remove(msg.replyTo);</span><br><span class="line">                    Log.d(TAG, <span class="string">"unregister_client"</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> MSG_SET_VALUE:</span><br><span class="line">                    Log.d(TAG, <span class="string">"set_value"</span>);</span><br><span class="line">                    mValue = msg.arg1;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = mClients.size()-<span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            mClients.get(i).send(Message.obtain(<span class="keyword">null</span>,</span><br><span class="line">                                    MSG_SET_VALUE, mValue, <span class="number">0</span>));</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                            <span class="comment">// The client is dead.  Remove it from the list;</span></span><br><span class="line">                            <span class="comment">// we are going through the list from back to front</span></span><br><span class="line">                            <span class="comment">// so this is safe to do inside the loop.</span></span><br><span class="line">                            mClients.remove(i);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">super</span>.handleMessage(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Target we publish for clients to send messages to IncomingHandler.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> Messenger mMessenger = <span class="keyword">new</span> Messenger(<span class="keyword">new</span> IncomingHandler());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MessageService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        mNM = (NotificationManager)getSystemService(NOTIFICATION_SERVICE);</span><br><span class="line">        <span class="comment">// Display a notification about us starting.</span></span><br><span class="line">        showNotification();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        <span class="comment">// Cancel the persistent notification.</span></span><br><span class="line">        mNM.cancel(R.string.remote_service_started);</span><br><span class="line">        <span class="comment">// Tell the user we stopped.</span></span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, R.string.remote_service_stopped, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * When binding to the service, we return an interface to our messenger</span></span><br><span class="line"><span class="comment">     * for sending messages to the service.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mMessenger.getBinder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Show a notification while this service is running.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TargetApi</span>(<span class="number">16</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showNotification</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// In this sample, we'll use the same text for the ticker and the expanded notification</span></span><br><span class="line">        CharSequence text = getText(R.string.remote_service_started);</span><br><span class="line">        <span class="comment">// The PendingIntent to launch our activity if the user selects this notification</span></span><br><span class="line">        PendingIntent contentIntent = PendingIntent.getActivity(<span class="keyword">this</span>, <span class="number">0</span>,</span><br><span class="line">                <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MainActivity.class), <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// Set the info for the views that show in the notification panel.</span></span><br><span class="line">        Notification notification = <span class="keyword">new</span> Notification.Builder(<span class="keyword">this</span>)</span><br><span class="line">                .setSmallIcon(R.mipmap.ic_launcher)  <span class="comment">// the status icon</span></span><br><span class="line">                .setTicker(text)  <span class="comment">// the status text</span></span><br><span class="line">                .setWhen(System.currentTimeMillis())  <span class="comment">// the time stamp</span></span><br><span class="line">                .setContentTitle(getText(R.string.remote_service_label))  <span class="comment">// the label of the entry</span></span><br><span class="line">                .setContentText(text)  <span class="comment">// the contents of the entry</span></span><br><span class="line">                .setContentIntent(contentIntent)  <span class="comment">// The intent to send when the entry is clicked</span></span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">// Send the notification.</span></span><br><span class="line">        <span class="comment">// We use a string id because it is a unique number.  We use it later to cancel.</span></span><br><span class="line">        mNM.notify(R.string.remote_service_started, notification);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 AndroidManifest 中注册，</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">".MessageService"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:enabled</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:process</span>=<span class="string">":remote_msg"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"com.xhj.huijian.aidlserver.MessageService"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在客户端工程新建一个 MessageActivity，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageServiceActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_BIND_SERVICE = <span class="string">"com.xhj.huijian.aidlserver.MessageService"</span>;</span><br><span class="line">    <span class="comment">/** Messenger for communicating with service. */</span></span><br><span class="line">    Messenger mService = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">/** Flag indicating whether we have called bind on the service. */</span></span><br><span class="line">    <span class="keyword">boolean</span> mIsBound;</span><br><span class="line">    <span class="comment">/** Some text view we are using to show state information. */</span></span><br><span class="line">    TextView mCallbackText;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Command to the service to register a client, receiving callbacks</span></span><br><span class="line"><span class="comment">     * from the service.  The Message's replyTo field must be a Messenger of</span></span><br><span class="line"><span class="comment">     * the client where callbacks should be sent.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_REGISTER_CLIENT = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Command to the service to unregister a client, ot stop receiving callbacks</span></span><br><span class="line"><span class="comment">     * from the service.  The Message's replyTo field must be a Messenger of</span></span><br><span class="line"><span class="comment">     * the client as previously given with MSG_REGISTER_CLIENT.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_UNREGISTER_CLIENT = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Command to service to set a new value.  This can be sent to the</span></span><br><span class="line"><span class="comment">     * service to supply a new value, and will be sent by the service to</span></span><br><span class="line"><span class="comment">     * any registered clients with the new value.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SET_VALUE = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handler of incoming messages from service.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">IncomingHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">                <span class="keyword">case</span> MessageServiceActivity.MSG_SET_VALUE:</span><br><span class="line">                    mCallbackText.setText(<span class="string">"Received from service: "</span> + msg.arg1);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">super</span>.handleMessage(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Target we publish for clients to send messages to IncomingHandler.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> Messenger mMessenger = <span class="keyword">new</span> Messenger(<span class="keyword">new</span> IncomingHandler());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ServiceConnection mConnection = <span class="keyword">new</span> ServiceConnection() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName componentName, IBinder iBinder)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// This is called when the connection with the service has been</span></span><br><span class="line">            <span class="comment">// established, giving us the service object we can use to</span></span><br><span class="line">            <span class="comment">// interact with the service.  We are communicating with our</span></span><br><span class="line">            <span class="comment">// service through an IDL interface, so get a client-side</span></span><br><span class="line">            <span class="comment">// representation of that from the raw service object.</span></span><br><span class="line">            mService = <span class="keyword">new</span> Messenger(iBinder);</span><br><span class="line">            mCallbackText.setText(<span class="string">"Attached."</span>);</span><br><span class="line"></span><br><span class="line">            Message msg = Message.obtain(<span class="keyword">null</span>, MSG_REGISTER_CLIENT);</span><br><span class="line">            msg.replyTo = mMessenger;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mService.send(msg);</span><br><span class="line">                msg = Message.obtain(<span class="keyword">null</span>, MSG_SET_VALUE, <span class="keyword">this</span>.hashCode(), <span class="number">0</span>);</span><br><span class="line">                mService.send(msg);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="comment">// In this case the service has crashed before we could even</span></span><br><span class="line">                <span class="comment">// do anything with it; we can count on soon being</span></span><br><span class="line">                <span class="comment">// disconnected (and then reconnected if it can be restarted)</span></span><br><span class="line">                <span class="comment">// so there is no need to do anything here.</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// As part of the sample, tell the user what happened.</span></span><br><span class="line">            Toast.makeText(MessageServiceActivity.<span class="keyword">this</span>, R.string.remote_service_connected,</span><br><span class="line">                    Toast.LENGTH_SHORT).show();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName componentName)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// This is called when the connection with the service has been</span></span><br><span class="line">            <span class="comment">// unexpectedly disconnected -- that is, its process crashed.</span></span><br><span class="line">            mService = <span class="keyword">null</span>;</span><br><span class="line">            mCallbackText.setText(<span class="string">"Disconnected."</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// As part of the sample, tell the user what happened.</span></span><br><span class="line">            Toast.makeText(MessageServiceActivity.<span class="keyword">this</span>, R.string.remote_service_disconnected,</span><br><span class="line">                    Toast.LENGTH_SHORT).show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_message_service);</span><br><span class="line">        <span class="comment">// Watch for button clicks.</span></span><br><span class="line">        Button button = (Button)findViewById(R.id.bind);</span><br><span class="line">        button.setOnClickListener(mBindListener);</span><br><span class="line">        button = (Button)findViewById(R.id.unbind);</span><br><span class="line">        button.setOnClickListener(mUnbindListener);</span><br><span class="line"></span><br><span class="line">        mCallbackText = (TextView)findViewById(R.id.callback);</span><br><span class="line">        mCallbackText.setText(<span class="string">"Not attached."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doBindService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(ACTION_BIND_SERVICE);</span><br><span class="line">        intent.setPackage(<span class="string">"com.xhj.huijian.aidlserver"</span>);</span><br><span class="line">        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">        bindService(intent, mConnection, Context.BIND_AUTO_CREATE);</span><br><span class="line">        mIsBound = <span class="keyword">true</span>;</span><br><span class="line">        mCallbackText.setText(<span class="string">"Binding."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doUnbindService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mIsBound) &#123;</span><br><span class="line">            <span class="comment">// If we have received the service, and hence registered with</span></span><br><span class="line">            <span class="comment">// it, then now is the time to unregister.</span></span><br><span class="line">            <span class="keyword">if</span> (mService != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Message msg = Message.obtain(<span class="keyword">null</span>, MSG_UNREGISTER_CLIENT);</span><br><span class="line">                    msg.replyTo = mMessenger;</span><br><span class="line">                    mService.send(msg);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    <span class="comment">// There is nothing special we need to do if the service</span></span><br><span class="line">                    <span class="comment">// has crashed.</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Detach our existing connection.</span></span><br><span class="line">            unbindService(mConnection);</span><br><span class="line">            mIsBound = <span class="keyword">false</span>;</span><br><span class="line">            mCallbackText.setText(<span class="string">"Unbinding."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> View.OnClickListener mBindListener = <span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">            doBindService();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> View.OnClickListener mUnbindListener = <span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">            doUnbindService();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码我就不再解释了，我贴下运行效果截图，</p>
<p><img src="https://gw.alicdn.com/tps/TB1QwznLXXXXXXRaXXXXXXXXXXX-998-378.png" alt=""></p>
<p>已经收到来自 service 的消息啦，哈哈，从日志也可以看出我们已经成功访问了，</p>
<p><img src="https://gw.alicdn.com/tps/TB1_nDALXXXXXXYXFXXXXXXXXXX-1594-110.png" alt=""></p>
<h4 id="IntentService"><a href="#IntentService" class="headerlink" title="IntentService"></a>IntentService</h4><p>刚开始学习 Android 开发时，常听人这么说，为了避免在 UI 线程上做耗时的操作所带来的 ANR(Application Not Responding)，可以把耗时的任务都放在 service 里去。其实这句话是不对的，在 service 里做耗时的操作同样也会带来 ANR。所以，你应该在 service 里开启子线程来执行耗时的任务。事实上，你不用自己那么麻烦地去创建一个 service，然后还要去管理 Service 的生命周期以及子线程。Android SDK 给你提供了一个叫 <strong>IntentService</strong> 的服务，它是 service 的子类，使用工作线程逐一处理所有启动请求。如果您不要求服务同时处理多个请求，这是最好的选择。 您只需实现 <code>onHandleIntent()</code> 方法即可，该方法会接收每个启动请求的 Intent，使你能够执行后台工作。</p>
<p>在 IntentService 内维护着一个工作线程来处理耗时操作，启动 IntentService 的方式和启动传统 Service 一样，同时，当任务执行完后，IntentService 会自动停止，而不需要我们去手动控制。另外， IntentService 可以启动多次，而每一个耗时操作会以工作队列的方式在IntentService 的 onHandleIntent 回调方法中执行，并且，每次只会执行一个工作线程，执行完第一个再执行第二个，以此类推。</p>
<p>而且，所有请求都在一个单线程中，不会阻塞应用程序的主线程（UI 线程），同一时间只处理一个请求。</p>
<p>综述，使用 IntentService 至少会给我们带来两个好处，一方面不需要自己去创建和管理子线程了；另一方面不需要考虑在什么时候关闭 Service 了。</p>
<p>下面，我们通过一个例子来学习 IntentService 的使用。IntentService 是一个抽象类，我们需要去实现它的 onHandleIntent 方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UploadService</span> <span class="keyword">extends</span> <span class="title">IntentService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"UploadService"</span>;</span><br><span class="line">    <span class="comment">// IntentService can perform, e.g. ACTION_FETCH_NEW_ITEMS</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_UPLOAD = <span class="string">"com.xhj.huijian.servicedemo.service.action.UPLOAD"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXTRA_IMG_PATH = <span class="string">"com.xhj.huijian.servicedemo.service.extra.IMG_PATH"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UploadService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">"UploadService"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onHandleIntent</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> String action = intent.getAction();</span><br><span class="line">            <span class="keyword">if</span> (ACTION_UPLOAD.equals(action)) &#123;</span><br><span class="line">                <span class="keyword">final</span> String path = intent.getStringExtra(EXTRA_IMG_PATH);</span><br><span class="line">                handleUploadImg(path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleUploadImg</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//模拟上传耗时</span></span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">            Intent intent = <span class="keyword">new</span> Intent(MainActivity.UPLOAD_RESULT);</span><br><span class="line">            intent.putExtra(EXTRA_IMG_PATH, path);</span><br><span class="line">            sendBroadcast(intent);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        Log.d(TAG, <span class="string">"onCreate"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        Log.d(TAG, <span class="string">"onDestroy"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UploadService 是一个模拟上传图片的服务，代码很简单，不做过多的解释啦，看下 MainActivity 的代码，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> BroadcastReceiver uploadImgReceiver = <span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (intent.getAction().equals(UPLOAD_RESULT)) &#123;</span><br><span class="line">                String path = intent.getStringExtra(UploadService.EXTRA_IMG_PATH);</span><br><span class="line">                uploadResult(path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">uploadResult</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        TextView tv = (TextView) mContainer.findViewWithTag(path);</span><br><span class="line">        tv.setText(path + <span class="string">" upload complete "</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>广播用来监听服务发送的消息，收到消息后修改页面上的控件内容，同步上传状态。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startIntentService</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        String path = <span class="string">"/sdcard/images/"</span> + (++img) + <span class="string">".jpg"</span>;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, UploadService.class);</span><br><span class="line">        intent.setAction(UploadService.ACTION_UPLOAD);</span><br><span class="line">        intent.putExtra(UploadService.EXTRA_IMG_PATH, path);</span><br><span class="line">        startService(intent);</span><br><span class="line"></span><br><span class="line">        TextView tv = <span class="keyword">new</span> TextView(<span class="keyword">this</span>);</span><br><span class="line">        mContainer.addView(tv);</span><br><span class="line">        tv.setText(path + <span class="string">" is uploading ..."</span>);</span><br><span class="line">        tv.setTag(path);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>上面是启动一个服务区下载图片，同时在页面上添加一个 TextView 用于显示上传状态。下面代码展示了广播的注册和注销，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        mContainer = (LinearLayout) findViewById(R.id.container);</span><br><span class="line">        <span class="comment">// 注册广播</span></span><br><span class="line">        IntentFilter filter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">        filter.addAction(UPLOAD_RESULT);</span><br><span class="line">        registerReceiver(uploadImgReceiver, filter);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>.onDestroy();</span><br><span class="line">       ...</span><br><span class="line">       <span class="comment">// 注销广播</span></span><br><span class="line">       unregisterReceiver(uploadImgReceiver);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>OK, Run 一下 demo，看下效果图：</p>
<p><img src="https://gw.alicdn.com/tps/TB1ZoYLLXXXXXcZXpXXXXXXXXXX-497-746.gif" alt=""></p>
<h4 id="扩展-Service-类"><a href="#扩展-Service-类" class="headerlink" title="扩展 Service 类"></a>扩展 Service 类</h4><p>上面所述，使用 IntentService 简化了启动服务的实现。但是，若要求服务执行多线程（而不是通过工作队列处理启动请求），则可扩展 service 类来处理每个 Intent。</p>
<p>下面我们创建一个并发处理多线程的 service，我们将其命名为 MultiThreadingService 吧，具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiThreadingService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Looper mServiceLooper;</span><br><span class="line">    <span class="keyword">private</span> ServiceHandler mServiceHandler;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_MULTI_UPLOAD = <span class="string">"com.xhj.huijian.servicedemo.service.action.MULTI_UPLOAD"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXTRA_IMG_PATH = <span class="string">"com.xhj.huijian.servicedemo.service.extra.IMG_PATH"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handler that receives messages from the thread</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ServiceHandler</span><span class="params">(Looper looper)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(looper);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//模拟上传耗时</span></span><br><span class="line">                Thread.sleep(((<span class="keyword">int</span>)(<span class="number">1</span> + Math.random() * <span class="number">3</span>)) * <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">                Intent intent = <span class="keyword">new</span> Intent(MainActivity.UPLOAD_RESULT);</span><br><span class="line">                intent.putExtra(EXTRA_IMG_PATH, (String) msg.obj);</span><br><span class="line">                sendBroadcast(intent);</span><br><span class="line">                stopSelf(msg.arg1);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MultiThreadingService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Start up the thread running the service.  Note that we create a</span></span><br><span class="line">        <span class="comment">// separate thread because the service normally runs in the process's</span></span><br><span class="line">        <span class="comment">// main thread, which we don't want to block.  We also make it</span></span><br><span class="line">        <span class="comment">// background priority so CPU-intensive work will not disrupt our UI.</span></span><br><span class="line">        HandlerThread thread = <span class="keyword">new</span> HandlerThread(<span class="string">"ServiceStartArguments"</span>,</span><br><span class="line">                Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">        thread.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get the HandlerThread's Looper and use it for our Handler</span></span><br><span class="line">        mServiceLooper = thread.getLooper();</span><br><span class="line">        mServiceHandler = <span class="keyword">new</span> ServiceHandler(mServiceLooper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">final</span> <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        Toast.makeText(MultiThreadingService.<span class="keyword">this</span>, <span class="string">"多线程服务启动"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> String action = intent.getAction();</span><br><span class="line">            <span class="keyword">if</span> (TextUtils.equals(action, ACTION_MULTI_UPLOAD)) &#123;</span><br><span class="line">                <span class="keyword">final</span> String path = intent.getStringExtra(EXTRA_IMG_PATH);</span><br><span class="line">                <span class="comment">// 取消下面的注释, 然后注销掉下面的 Thread,该服务的作用就跟 UploadService 一样了</span></span><br><span class="line"><span class="comment">//                Message msg = mServiceHandler.obtainMessage();</span></span><br><span class="line"><span class="comment">//                msg.arg1 = startId;</span></span><br><span class="line"><span class="comment">//                msg.obj = path;</span></span><br><span class="line"><span class="comment">//                mServiceHandler.sendMessage(msg);</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="comment">//模拟上传耗时</span></span><br><span class="line">                            Thread.sleep(((<span class="keyword">int</span>)(<span class="number">1</span> + Math.random() * <span class="number">3</span>)) * <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">                            Intent intent = <span class="keyword">new</span> Intent(MainActivity.UPLOAD_RESULT);</span><br><span class="line">                            intent.putExtra(EXTRA_IMG_PATH, path);</span><br><span class="line">                            sendBroadcast(intent);</span><br><span class="line">                            stopSelf(startId);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// If we get killed, after returning from here, restart</span></span><br><span class="line">        <span class="keyword">return</span> START_STICKY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Toast.makeText(MultiThreadingService.<span class="keyword">this</span>, <span class="string">"多线程服务结束"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为我们自己处理了 <code>onStartCommand()</code> 的每个调用，因此可以同时执行多个请求。Activity 的代码我就不贴出来了，大家看下 demo 吧，运行上面的代码，随便点击几下 “MultiService” 按钮，就可以看到下图的效果了，</p>
<p><img src="https://gw.alicdn.com/tps/TB1J9.XLXXXXXcYaXXXXXXXXXXX-497-746.gif" alt=""></p>
<p>可以看出已经是并发线程下载了。</p>
<h4 id="前台服务"><a href="#前台服务" class="headerlink" title="前台服务"></a>前台服务</h4><p>前台服务被认为是用户主动意识到的一种服务，因此在内存不足时，系统也不会考虑将其终止。前台服务必须为状态栏提供通知，状态栏位于“正在进行”标题下方，这意味着除非服务停止或从前台删除，否则不能清除通知。这个例子最好举了，当你打开音乐播放器时，你的手机状态栏上面是有一个通知，并且你手动去滑动是滑不掉的。</p>
<p>要请求让服务运行于前台，请调用 <code>startForeground()</code>。此方法取两个参数：唯一标识通知的整型数和状态栏的 <code>Notification</code>。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Notification notification = <span class="keyword">new</span> Notification(R.drawable.icon, getText(R.string.ticker_text),</span><br><span class="line">        System.currentTimeMillis());</span><br><span class="line">Intent notificationIntent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, ExampleActivity.class);</span><br><span class="line">PendingIntent pendingIntent = PendingIntent.getActivity(<span class="keyword">this</span>, <span class="number">0</span>, notificationIntent, <span class="number">0</span>);</span><br><span class="line">notification.setLatestEventInfo(<span class="keyword">this</span>, getText(R.string.notification_title),</span><br><span class="line">        getText(R.string.notification_message), pendingIntent);</span><br><span class="line">startForeground(ONGOING_NOTIFICATION_ID, notification);<span class="comment">// 提供给 startForeground() 的整型 ID 不得为 0</span></span><br></pre></td></tr></table></figure>
<p>要从前台删除服务，请调用 <code>stopForeground()</code>。此方法取一个布尔值，指示是否也删除状态栏通知。 此方法绝对不会停止服务。 但是，如果您在服务正在前台运行时将其停止，则通知也会被删除。</p>
<h4 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h4><p>写这篇文章的原因，一是作为自己对 service 组件的理解和应用做一次较全面的总结，二是帮助 Android 新人对 service 组件的学习有一个比较深刻的了解，三是方便自己遗忘，可以回头来查阅。上面较多的例子来自 Google 官方文档，所以你也能看到很多的英文注释，原本想把英文注释去掉，太占篇幅了，但后面发现，很多的英文注释可以帮助你理解代码为什么要这么写，因为注释很容易看，所以也不句句翻译了。当然，我也阅读了很多国内其他博主写的很好的博文，借鉴了他们的一些例子，之所以这么做，是怕自己个人的理解有些偏差，自己举例的代码不够好，误导大家。篇幅这么长，肯定有疏漏的地方，还请各位指出。</p>
<p><a href="http://download.csdn.net/detail/g96968586/9596505" target="_blank" rel="noopener">附件 demo</a></p>

            </div>
          

    
      <footer class="post-footer">
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2016/09/15/JavaScript-客户端检测技术学习分享/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">JavaScript  客户端检测技术学习分享</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2016/09/15/Android-音频技术开发总结/">
        <span class="next-text nav-default">Android 音频技术开发总结</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2016 -
    
    2018
    <span class="footer-author">箫鉴哥.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
